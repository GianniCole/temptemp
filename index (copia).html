{% extends "base.html" %}
{% block content %}

<div class="container">
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar1">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand"><img src={{ url_for('static', filename="netcast_logo.png") }} alt="NetCAST Tool" style="width:30px">
        </a>
        <label style="font-size: larger; margin-top: 15%; color: #777; ">NetCAST
        </label>
      </div>
      <div id="navbar1" class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right" style="margin-top:5px">
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
              <span class="fa fa-user"></span>
              <span id="username" class="user-name"> {{ current_user.username }} </span>
              <span class="fa fa-caret-down"></span>
            </a>
            <ul class="dropdown-menu" role="menu">
              <li class="dropdown-header">OpenStack project:</li>
              <li>
                <a style="pointer-events:none;cursor:default;">
                  <span class="fa fa-check"></span>
                  <span id="openstackProject" class="dropdown-title"> {{ current_user.project_name }} </span>
                </a>
              </li>
              <li class="dropdown-header">Role:</li>
              <li>
                <a style="pointer-events:none;cursor:default;">
                  <span class="fa fa-check"></span>
                  <span id="uRole" class="dropdown-title"> {{ current_user.urole }} </span>
                </a>
              </li>
              <li class="dropdown-header">Campaign:</li>
              <li>
                <a style="pointer-events:none;cursor:default;">
                  <span class="fa fa-check"></span>
                  <span id="campaignName" class="dropdown-title"></span>
                </a>
              </li>
              <li class="divider"></li>
              <li>
                <a id="logoutBtn" role="button" href="#">
                  <span class="fa fa-sign-out"></span> Log out
                </a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
      <!--/.nav-collapse -->
    </div>
    <!--/.container-fluid -->
  </nav>
</div>
           

<div id="pippozzo" class="container">
  
  <ul class="nav nav-tabs">
    <li id="scanBtn" class="active">
      <a data-toggle="tab" href="#tabScan" style="font-size: 25px">Scan</a>
    </li>
    <li id="executeBtn">
      <a data-toggle="tab" href="#tabDashboard" style="font-size: 25px">Dashboard <i class="fa fa-spinner fa-spin" style="font-size:16px;color:#ffa012;" hidden></i></a>
    </li>
    <li id="analyticsBtn">
      <a data-toggle="tab" href="#tabAnalytics" style="font-size: 25px">Analytics</a>
    </li>
  </ul>

  <div class="tab-content">

    <div id="tabScan" class="tab-pane fade in active">
      <div class="text-center">
        <br>
        <br>
        <br>
        <div class="row">
          <button id="scanResources" class="btn btn-success btn-lg" data-toggle="tooltip" data-placement="bottom" title="Click here to scan all resources" style="margin-right: 20px; width: 200px;">Configure <br> fault injection <br> test plan <br><br>
            <i class="fa fa-gears" aria-hidden="true" style="color: white;pointer-events: none;font-size: 45px;">
            </i>scanResources
          </button>
          <button id="executeSelectedFIP" class="btn btn-danger btn-lg" data-toggle="tooltip" data-placement="bottom" title="Click on this button to execute the selected test cases. You need to select the test cases in the table below" style="margin-left: 20px; width: 200px;" disabled>Execute <br> selected <br> test cases <br><br>
            <i class="fa fa-arrow-circle-right" aria-hidden="true" style="color: white;pointer-events: none;font-size: 45px;">
            </i>
          </button>
        </div>
      </div>
      <br>
      <br>
      <br>
      <table id="table1" class="table-striped table-bordered" cellspacing="0" width="100%">
        <thead>
          <th></th>
          <th>Domain</th>
          <th>Component</th>
          <th>Resource Target</th>
          <th>Fault Target</th>
          <th>Fault Type</th>
          <th>Args</th>
          <th>Description</th>
          <th>Fault Pattern</th>
          <th>Fault Pattern Arg 1</th>
          <th>Fault Pattern Arg 2</th>
          <th>Fault Target Traffic</th>
          <th>Fault Target Traffic protocol</th>
          <th>Fault Target Traffic src ports</th>
          <th>Fault Target Traffic dst ports</th>
          <th>Status</th>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>

    <div id="tabDashboard" class="tab-pane">
      <div class="container-fluid">
        <div class="row" style="text-align: center;"> 
          <button id="selectWorkload" class="btn btn-lg btn-default" style="margin-top: 20px;">Select Workload</button>
        </div>


        <br>
        <br>

        <div class="pull-right" style="margin-right:20px;">
          <input type="checkbox" class="form-check-input" id="autoscrollCheckExp" checked>
          <label class="form-check-label" for="autoscrollCheckExp">Autoscroll</label>
        </div>

        <div style="text-align: left; margin:20px;">
          <div id="exp-list" style="width:100%;overflow-y:scroll;max-height:411px;display:inline-block" class=" btn-group btn-group-vertical">
          </div>
        </div>
      </div>

      <div class="progress progress-striped active" style="margin-left: 20px;margin-right: 20px;">
        <div class="progress-bar progress-bar-success" style="width:0%"></div>
      </div>

      <br>
      <div class="text-center">
        <div class="btn-group-vertical">
          <button id="executeTestCases" class="btn btn-success btn-lg" style="margin-bottom: 10px; border-radius: 4px;" data-toggle="tooltip" data-placement="bottom" title="Click on this button to execute the selected test cases." disabled>Execute test cases</button>
          <button id="stopTestCases" class="btn btn-danger btn-lg" style="margin-bottom: 10px; border-radius: 4px;" data-toggle="tooltip" data-placement="bottom" title="Click on this button to stop test cases execution." disabled>Stop</button>
        </div>
      </div>
      <div class="row" style="margin:20px;display: inline-flex;">
        <button id="showLogs" class="btn btn-default">Show/Hide Logs</button>
        <button id="injectionSetup" class="btn btn-default" style="margin-left: 20px;">Advanced injection parameters</button>

        <div class="dropdown" style="margin-left: 20px;">
                <button id="instancesConsole" class="btn btn-default dropdown dropdown-toggle" type="button" data-toggle="dropdown">Instances consoles
                <span class="caret"></span></button>
                <ul id="consoles_dropdown_menu" class="dropdown-menu">
                    <div id="consoles_body">
                    </div>
                </ul>
        </div>
        <div id="autoscrollCheckDiv" class="form-check hidden" style="margin-left: 20px;margin-top: 10px;">
            <input type="checkbox" class="form-check-input" id="autoscrollCheck">
            <label class="form-check-label" for="autoscrollCheck">Autoscroll</label>
        </div>
      </div>
      <div id="logs" class="panel panel-default hidden" style="overflow-y: scroll; width: 100%; height: 300px;">
      </div>
    </div>

    <div id="tabAnalytics" class="tab-pane">
      <div class="container" style="padding-left: 0px;">      
        <!-- Left column -->
        <div class="col-sm-2" style="padding-left: 0px;">
          <!-- List of tests -->
          <div class="panel panel-default" style="padding-right: 5px; padding-left: 5px; padding-top: 5px; margin-top: 20px; height: 425px; background-color: #f5f5f5">
            <p style="text-align: center;"><b>Test list</b></p>
            <div style="text-align: center; margin-top: 10px;">
              <div id="exp-list_analytics_col" class="btn-group btn-group-vertical btn-group-toggle" style="width:100%;" data-toggle="buttons">
                <label class="btn btn-success">
                  <input type="radio" name="options" id="all_test_analytics" autocomplete="off">
                  <text>All</text>
                </label>
                <hr>
                <div id="exp-list_analytics" class=" btn-group btn-group-vertical" style="width: 100%;overflow-y:scroll;max-height:298px;display:inline-block;">
                </div>
              </div>
            </div>
            <!-- end list of tests -->
          </div>

          <!-- panel checkbox -->
          <div id="analytics_test_checkbox">
          </div>
        </div>

        <!-- Right column -->
        <div id="analytics_details" class="col-sm-10" style="margin-top: 20px;">
        </div>

      </div>
    </div>
  </div>

</div>


<!-- Modal execute-list -->
<div id="campaignModal" class="modal fade" role="dialog">
  <!-- Modal for Campaign manager -->
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <!--
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      -->
        <h4 class="modal-title">Campaign manager</h4>
      </div>
      <div class="modal-body">
        
        <!-- create project row -->
        <div class="row">
          <div class="col-sm-6">
            <input id="newCampaignName" class="form-control" type="text" placeholder="insert campaign name"></input>
          </div>
          <div class="col-sm-6">
            <button type="button" class="btn btn-primary pull-right" id="createCampaign">New campaign</button>    
          </div>
        </div>
        <p></p>
        <div id="createCampaign_alertArgs">
        </div>

        <hr>
        <!-- load project row -->
        <div class="row">
          <div class="col-sm-6">
            <div id="campaignList_dropdown" class="dropdown">
              <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                <span id="campaignListLabel" class="dropdown-title">select campaign </span>
                <span class="fa fa-caret-down"></span>
              </button>
              <ul id="campaignList_dropdown_menu" class="dropdown-menu">
                    <!-- code generated from campaignList() function -->
              </ul>
            </div>
          </div>
          <div class="col-sm-6">
            <button type="button" class="btn btn-success pull-right" id="loadCampaign" disabled="">Load campaign</button>
          </div>
        </div>
        <p></p>
        <div id="loadCampaign_alertArgs">
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="logoutCampaign">Logout</button>
      </div>

    </div>
  </div>
</div>




<!-- Scan Resources and Fault Library  Modal -->
<div id="ProjectResourcesModal" class="modal fade" role="dialog">
  <div class="deploymodal-dialog">
    <!-- Modal content-->
    <div class="modal-content" >
      <div class="modal-header">
        <h2>Test plan configuration</h2>
      </div>
      <div class="modal-body" style="padding-bottom: 0px;">
        <div class="row">
          <h3>
            <u>Click on a resource to add faults...</u>
          </h3>
          <br>
          <div id="showNetworkTopology_faultload" class="fade in" hidden style="max-height: 500px; border:2px #555 dashed;">
            <div class="col-md-7">
              <div id="showNetworkTopologyContainer">
                <div id="showNetworkTopologyObject">
                </div>
              </div>
            </div>
            <div class="col-md-5">
              <div id="faultload_configuration">
              </div>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top: 20px; margin-bottom: 20px;">
          <button id="showNetworkTopology" type="button" class="btn btn-default btn-sm" title="Click button to reload the last valid faultload configuration.">
            <span class="glyphicon glyphicon-refresh"></span> Refresh network topology
          </button>
          <button id="showNetworkTopology_help_1" type="button" data-toggle="popover" class="btn btn-default btn-sm">
            <span class="glyphicon glyphicon-info-sign"></span> Help
          </button>
        </div>

        <!-- fast configuration start-->
        <div id="fast_configuration_modal" class="row modal-content" hidden>
          <div class="modal-header">
            <h5 class="modal-title" style="display: inline" ;="">Advanced configuration</h5>
            <button id="fast_configuration_header_close" type="button" class="close">
              <span aria-hidden="true">×</span>
            </button>
          </div>

          <div id="scanTabRow" class="modal-body">
            <ul class="nav nav-tabs">
              <li id="projectResourcesBtn" class="active">
                <a data-toggle="tab" href="#tabScan_projectResources" style="font-size: 25px">Project Resources</a>
              </li>
              <li id="faultLibraryBtn">
                <a data-toggle="tab" href="#tabScan_faultLibrary" style="font-size: 25px">Fault Library</a>
              </li>
            </ul>
            <div class="tab-content">

              <div id="tabScan_projectResources" class="tab-pane fade in active">
                <div class="modal-body">
                  <div class="row">
                    <div id="PR_tree_container" class="col-sm-6">
                      <p><b>Select resources to be enabled:</b></p>
                      <div id="PR_tree">
                      </div>
                    </div>
                    <div class="col-sm-6">
                      <p><b>Description:</b></p>
                      <div class="panel panel-default" style="height: 100px;">
                        <div id="PR_description" class="panel-body">
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="btn-toolbar" style="margin-left:20px;">
                      <button id="btnEnableResources" class="btn btn-default pull-left" data-toggle="tooltip" data-placement="bottom" title="Select/Deselect all resources">
                      <span class="glyphicon glyphicon-random"></span> Select/Deselect all</button>
                    </div>
                  </div>              
                </div>
              </div>

              <div id="tabScan_faultLibrary" class="tab-pane fade">
                <div class="modal-body">
                  <div class="row">
                    <div id="FL_tree_container" class="col-sm-6">
                      <p><b>Select faults to be enabled:</b></p>
                      <div id="FL_tree"></div>
                    </div>
                    <div class="col-sm-6">
                      <p><b>Description:</b></p>
                      <div class="panel panel-default" style="height: 100px;">
                        <div id="FL_description" class="panel-body"></div>
                      </div>
                      <p><b>Args<text id="FL_args_unit"></text>: </b></p>
                      <div class="form-group">
                        <input id="FL_args" type="text" disabled></input>
                        <button id="FL_args_save" class="btn btn-default btn-sm" disabled><i class="fa fa-floppy-o fa-2x" aria-hidden="true" style="color:black;pointer-events:none"></i></button>
                        <p></p>
                        <div id="alertArgs">
                        </div>
                      </div>  
                    </div>
                  </div>
                  <div class="btn-toolbar pull-left">
                    <button id="btnEnableFaults" class="btn btn-default pull-left" data-toggle="tooltip" data-placement="bottom" title="Select/Deselect all resources">
                    <span class="glyphicon glyphicon-random"></span> Select/Deselect all</button>
                  </div>
                  <br>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="btn-toolbar pull-right">
              <button id="fast_configuration_add" class="btn btn-primary">Add</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <a id="fastConfiguration" class="pull-left" href="#" style="margin-top:10px"> &lt;&lt; Advanced configuration &gt;&gt;</a>
        <div class="btn-toolbar pull-right">
          <button id="FL_cancel" class="btn btn-danger btn-lg">Cancel</button>
          <button id="FL_save" class="btn btn-primary btn-lg">Save</button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal confirm -->
<div class="modal fade" id="confirmModalDeployWorkloadInstaces">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <text>NetCAST is going to inject faults in the {{ current_user.urole}} network. Click OK to confirm and start the tests.</text> 
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="confirmModalDeployWorkloadInstaces_ok">Ok</button>
            <button type="button" class="btn btn-danger" id="confirmModalDeployWorkloadInstaces_cancel">Cancel</button>
          </div>
    </div>
  </div>
</div>


<!-- Modal execute-list -->
<div id="expListModal" class="modal fade" role="dialog">
  <!-- Modal for Test Details -->
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Test details</h4>
      </div>
      <div id="exp-details" style="padding:15px">
      </div>
    </div>
  </div>
</div>


<!-- Modal Injection Setup -->
<div id="injectionSetupModal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content col-md-6 col-md-offset-3">
      <div class="modal-header">
        <h4 class="modal-title">Injection Setup</h4>
      </div>
      <div class="modal-body">
        <div class="form-group"> 
          <!-- TODO: add help -->
          <label class="control-label">Pre-injection delay (sec): 
            <input id="preInjectTime" class="form-control" type="text" value="5" placeholder="Insert delay (sec)"></input>
          </label>
          <p></p>
          <label class="control-label">Injection duration (sec): 
            <input id="InjectTime" class="form-control" type="text" value="30" placeholder="Insert delay (sec)"></input>
          </label>
          <p></p>
          <label class="control-label">Post-injection delay (sec): 
            <input id="postInjectTime" class="form-control" type="text" value="5" placeholder="Insert delay (sec)"></input>
          </label>
        </div>
        <div id="alertArgs_injection_parameters">
        </div>
      </div>
      <div class="modal-footer">
        <div class="btn-toolbar pull-right">
          <button id="injectionSetupCancel" class="btn btn-danger btn-lg">Cancel</button>
          <button id="injectionSetupSave" class="btn btn-primary btn-lg">Save</button>
        </div>
      </div>
    </div>
  </div>
</div>


<div id="deployingModal" class="modal fade" role="dialog">
    <div class="deploymodal-dialog">
        <div class="modal-content text-center">

            <div id="deploySpinner">
                <i id="deploySpinner" class="fa fa-spinner fa-spin" style="font-size:100px;padding:20px"></i>
                <p style="font-size:16px;"><b>Deploying...</b></p>
                <!--<div id="logs" class="panel panel-default panel-mypanel" style="margin:5px;"></div>-->
            </div>

            <div id="deploy_logs" class="panel panel-default" style="margin:5px;text-align:left;overflow-y: scroll;height: 350px;"></div>

        </div>

    </div>

</div>

<!-- Modal fa fa-spinner fa-spin -->
<div id="fa_fa_spinner_fa_spin" class="modal fade" role="dialog" style="width: 500px; height: 300px;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body" style="text-align:center">
        <span class="field-label" style="font-size:32px;color:#555;">Deploying...</span>
        <br>
        <span class="fa fa-spinner fa-spin" style="font-size:64px;color:#555;"></span>
        <div id="deploy_logs" class="panel panel-default" style="overflow-y: scroll; width: 100%; height: 300px;"></div>
      </div>
    </div>
  </div>
</div>


<!-- Modal Select Workload -->
<div id="selectWorkloadModal" class="modal fade" role="dialog">
  <div class="deploymodal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Select Workload</h2>
          </div>
          <!--
          <ul class="nav nav-tabs">
            <li id="selectDefaultWorkload" class="active">
              <a data-toggle="tab" href="#tabSelectDefaultWorkload" style="font-size: 25px">Workload generators</a>
            </li>
            
            <li id="selectCustomWorkload">
              <a data-toggle="tab" href="#tabSelectCustomWorkload" style="font-size: 25px">Custom workload</a>
            </li>
          </ul>
          -->
          <div class="tab-content">
            
            <div id="tabSelectDefaultWorkload" class="tab-pane fade in active">
              <div class="modal-body" style="padding-bottom: 0px;">
                <div class="row">
                  <h3>
                    <u> Use drag-and-drop to setup the workload generators...</u>
                    <button id="showNetworkTopology_help_conf" type="button" data-toggle="popover" class="btn btn-default" style="width: 30px; height: 30px; border-radius: 15px; padding-left: 0px;padding-top: 1px;padding-right: 0px;padding-bottom: 0px;">
                      <span class="glyphicon glyphicon-question-sign" style="font-size: x-large;"></span>
                    </button>
                  </h3>
                  <div id="showNetworkTopology_workload" class="fade in" hidden style="max-height: 500px; border:2px #555 dashed;">
                    <div class="col-md-7">
                      <div id="showNetworkTopologyContainer_workload">
                        <div id="showNetworkTopologyObject_workload">
                        </div>
                      </div>
                    </div>
                    <div class="col-md-5">
                      <div id="workload_configuration">
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-top: 20px; margin-bottom: 20px;">
                  <button id="showNetworkTopology_workload_refresh" type="button" class="btn btn-default btn-sm" title="Click button to reload the last valid workload configuration.">
                    <span class="glyphicon glyphicon-refresh"></span> Refresh network topology
                  </button>
                  <button id="showNetworkTopology_workload_editFaults" type="button" class="btn btn-default btn-sm" title="Click button to add/remove/change faults.">
                    <span class="glyphicon glyphicon-edit"></span> Change fault configuration
                  </button>
                  <button id="showNetworkTopology_help_2" type="button" data-toggle="popover" class="btn btn-default btn-sm showNetworkTopology_help_2">
                    <span class="glyphicon glyphicon-info-sign"></span> Help
                  </button>

                </div>
              </div>

<!-- insert in tabworkload config panel 
              <div class="modal-body">
                <div class="container">
                  <div class="dropdown">
                    <button id="genLabel"class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Generators
                    <span class="caret"></span></button>
                    <ul class="dropdown-menu">
                      <li><a href="#">JMeter</a></li>
                      <li><a href="#">iPerf</a></li>
                      <li><a href="#">SIPp</a></li>
                      <li role="separator" class="divider"></li>
                      <li><a href="#">...</a></li>
                    </ul>
                  </div>
                </div>
                <div id="bodySelectWorkload">
                </div>
              </div>
-->
            </div>

            <div id="tabSelectCustomWorkload" class="tab-pane fade">
              <div class="modal-body">
                  <div class="form-group">
                    <label class="control-label">Pre-workload commands:
                      <textarea id="preWlCommands" style="height: 200px;width: 100%;resize: none;"></textarea>
                    </label>
                    <p></p>
                    <label class="control-label">Workload commands:
                      <textarea id="wlCommands" style="height: 200px;width: 100%;resize: none;"></textarea>
                    </label>
                    <p></p>
                  </div>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <div class="btn-toolbar pull-right">
              <button id="selectWorkloadCancel" class="btn btn-danger btn-lg">Cancel</button>
              <button id="selectWorkloadSave" class="btn btn-primary btn-lg">Save</button>
            </div>
          </div>
  </div>
</div>


<!-- style analytics checkbox -->
<style type="text/css">


#analytics_test_checkbox > div > div > ul > li {
    padding-left: 4px;
    padding-right: 12px;
}

.progress {
  height: 30px;
}

.progress.active .progress-bar {
    -webkit-transition: none !important;
    transition: none !important;
}

.progress .progress-bar {
    font-size: 20px;
    line-height: unset;
    color: black;
}

.material-switch > input[type="checkbox"] {
    display: none;   
}

.material-switch > label {
    cursor: pointer;
    height: 0px;
    position: relative; 
    width: 40px;  
}

.material-switch > label::before {
    background: rgb(0, 0, 0);
    box-shadow: inset 0px 0px 10px rgba(0, 0, 0, 0.5);
    border-radius: 8px;
    content: '';
    height: 16px;
    margin-top: -8px;
    position:absolute;
    opacity: 0.3;
    transition: all 0.4s ease-in-out;
    width: 40px;
}
.material-switch > label::after {
    background: rgb(255, 255, 255);
    border-radius: 16px;
    box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
    content: '';
    height: 24px;
    left: -4px;
    margin-top: -8px;
    position: absolute;
    top: -4px;
    transition: all 0.3s ease-in-out;
    width: 24px;
}
.material-switch > input[type="checkbox"]:checked + label::before {
    background: inherit;
    opacity: 0.5;
}
.material-switch > input[type="checkbox"]:checked + label::after {
    background: inherit;
    left: 20px;
}

</style>

<!-- style topology -->
<style type="text/css">
  
.node {
  stroke: #fff;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

.node text {
  display: none;
  font: 15px arial, sans-serif;
  stroke: #000;
  font-size: 14px;
}

.node:hover text {
  display: inline;
}

.node circle {
  fill: #fff;
  stroke: #000;
  stroke-width: 1px;
}

.deploymodal-dialog {
 
          margin:0 auto;
          width:75%;
 
}

 
</style>


<script type="text/javascript">

//In the nav-bar, remove the OpenStack project from the dropdown menu 
if ( $('#uRole').text() == " physical " ) {
  $('#navbar1 > ul > li > ul > li:nth-child(2)').remove();
  $('#navbar1 > ul > li > ul > li:nth-child(1)').remove();
}

var LOADED = false;

// ################### START - JS for Campaign Manager Modal ######################

$('.nav-tabs a[href="#tabScan"]').on('click', function (){
    
    $.ajax ({
      method: "POST",
      url:  "{{ url_for('netcast.loadCampaign') }}",
      data: {campaign: $('#campaignName').text() },

      success: function(response) {
        var fip_list = JSON.parse(response);
        //var fips_list = JSON.parse(fip_list);

        //console.log(fip_list);
        t = $('#table1').DataTable();
        t.rows().remove().draw();
        t.rows.add(fip_list).draw();
        t.rows().select();

      },
      statusCode: {
        400:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }, 
        401:  function (response) { alert('No faults !!!'); }, 
        500:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        0:    function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
      }
    });

    
})

    

$('#campaignModal').on('show.bs.dropdown', function () {
  console.log("YESSA")
  $('#campaignList_dropdown_menu').html("");

  $.ajax({
    method: "GET",
    url:    "{{ url_for('netcast.getCampaignList') }}",

    beforeSend: function () {
        $('#campaignList_dropdown_menu').html('<li><a style="pointer-events:none;cursor:default;"><span class="fa fa-spinner fa-spin" style="font-size:16px;color:#000000;"></span><b> Loading...</b></a></li>');
    },

    success: function (response) {

      campaign_list = JSON.parse(response);

      $('#campaignList_dropdown_menu').html("");
      $('#campaignList_dropdown_menu').append(
          '<li data-original-index="0" data-toggle="tooltip" data-placement="top">'+
            '<a data-select-value="">select campaign </a>'+
          '</li>'
        );

      if (campaign_list.length) {
        for (var i = 0 ; i < campaign_list.length; i++) {
          //console.log("PROJECT_NAME %s PROJECT_DOMAIN_ID %s USER_DOMAIN_ID %s " , project.name, project.domain_id, project.parent_id);
          $('#campaignList_dropdown_menu').append(
              '<li data-original-index="'+ i+1 +'" data-toggle="tooltip" data-placement="top">'+
                '<a data-select-value="' +campaign_list[i]+ '">'+ campaign_list[i] +'</a>'+
              '</li>'
          );
        }

        $('#campaignList_dropdown_menu li a').click( function () {
          //on change projectListLabel content
          if ($('#campaignListLabel').text() !== $(this).text()){
            $('#campaignListLabel').text($(this).text());  
          }

          if ($('#campaignListLabel').text() !== "select project ") {
            $('#loadCampaign').prop('disabled', false);
          }
        });
      }
      else {
        $('#campaignListLabel').text("Empty");
        $('#campaignList_dropdown button').prop('disabled', true);
      }
    }    
  });
});

$('#logoutCampaign').on('click', function() {
    console.log("YESSA")
    logout();
  });


  $('#createCampaign').on('click', function() {
    $('#createCampaign_alertArgs').html("");

    campaign_name = $('#newCampaignName').val();

    if ( !campaign_name ) {
      console.log("newCampaignName is Null");
      $('#createCampaign_alertArgs').append('<div id="createCampaign_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a campaign name. </div> ');
      return false;
    }

    $.ajax({
      method: "POST",
      url: "{{ url_for('netcast.createCampaign') }}",
      data: { 'campaign_name' : campaign_name },

      success: function (response) {
        $('#campaignName').text(campaign_name);
        $('#campaignModal').modal('hide');
        LOADED = false;
      },
      statusCode: {
        500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        501: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        502: function (response) { 
          $('#createCampaign_alertArgs').append('<div id="createCampaign_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">The campaign "' + campaign_name + '" already exist. Click on select campaign to load it. </div> ');
          return false;
        },
        400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
      }
    });
  });


  $('#loadCampaign').on('click', function ( ) {

    loadedCampaign = $('#campaignListLabel').text();
    $('#campaignName').text(loadedCampaign);

    $.ajax ({
      method: "POST",
      url:  "{{ url_for('netcast.loadCampaign') }}",
      data: {campaign: loadedCampaign },

      success: function(response) {
        var fip_list = JSON.parse(response);
        //var fips_list = JSON.parse(fip_list);

        //console.log(fip_list);
        t = $('#table1').DataTable();
        t.rows().remove().draw();
        t.rows.add(fip_list).draw();
        t.rows().select();

        LOADED = true;

        $('#campaignModal').modal('hide'); 

        for ( var i = 0; i < fip_list.length; i++ ) {
          if ( fip_list[i][15] != "NotCompleted" ) {
            //disable dataTable button (i.e. Select all, Select none, Clear Table)
            $('#table1_wrapper > div.dt-buttons > a:nth-child(1)').toggleClass('disabled', true)
            $('#table1_wrapper > div.dt-buttons > a:nth-child(2)').toggleClass('disabled', true)
            $('#table1_wrapper > div.dt-buttons > a:nth-child(3)').toggleClass('disabled', true)
            break;
          }
        }
        
        //disable toggle checkbox for erro/completed row in dataTable
        for (i = 0; i < $('#table1 > tbody')[0]['childElementCount']; i++) {
          if ( $('#table1 > tbody > tr:nth-child('+ (i+1) +') > td:nth-child(9)').text() != " NotCompleted" ) {
            $('#table1 > tbody > tr:nth-child('+ (i+1) +') > td:nth-child(1)').on('click', function() {
              alert('Tests in completed or error state can not be deselect.');
              return false;
            })
          }
        }

        //set gloabal LOADED = true => in this case the user can't:
        // 1) remove completed or error test
        // 2) modify wl configuration
        // 3) modify injectionTimeSetup
        // 4) after click on button id "scanResources", load the db_scan and compare this with new_scan:
        //    - if new_scan == db_scan => continue
        //    - if new_scan != db_scan => alert to user, disable Scan and Dashboard tab, active only 
        //                                analytics tab 
      },
      statusCode: {
        400:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }, 
        401:  function (response) { alert('No faults !!!'); }, 
        500:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        0:    function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
      }
    });


  });


  $('#campaignModal').on('hide.bs.modal', function() {

    if ( LOADED ) {
      $.confirm({
                      title: '<b>WARNING</b>',
                      content: 'For loaded campaigns, the user can only add new faults or remove those NotCompleted ',
                      type: 'orange',
                      typeAnimated: true,
                      buttons: {
                          logout: function () { logout(); },
                          ok: function() { return; }
                      }
                  });
    }
      

      $.ajax({
        method: "POST",
        data: { 'campaign_name' : $('#campaignName').text() },
        url: "{{ url_for('netcast.getInjectorTime') }}",
        success: function (response) {
          injector_time = JSON.parse(response);

          pre_injection_time = injector_time['pre_injection_time'];
          injection_time = injector_time['injection_time'];
          post_injection_time = injector_time['post_injection_time'];

          $('#preInjectTime').val(pre_injection_time);
          $('#InjectTime').val(injection_time);
          $('#postInjectTime').val(post_injection_time);

        },
        statusCode: {
          500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          501: function (response) { alert('Error during load injection time configuration'); },
          400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
        } 
      });  
  });


// ################### END - JS for Campaign Manager Modal ######################

function check_agents(){
    console.log( "Check injector agents!" );
    $.ajax({
      type: "GET",
      url: "{{ url_for('netcast.check_agents') }}",
      success: function (response) {


          if (response != "OK"){
         
              if ( response === "all_down" ){
                  hosts_down_message = 'The NetCAST Master is unable to connect to ALL theNetCAST injector agents on OpenStack nodes. Please contact the system administrator.'
                  
                  $.confirm({
                      title: '<b>ERROR</b>',
                      content: hosts_down_message,
                      type: 'red',
                      typeAnimated: true,
                      buttons: {
                          logout: function () {
                            
                              logout()

                          }
                      }
                  });

              }

              else {
                  
                  hosts_down_message = 'The NetCAST Master is unable to connect some NetCAST injector agents on OpenStack nodes. <p> Please check that NetCAST injector agents run on the following nodes: </p>'
                  hosts_down_message += response
                  hosts_down_message += '<p> Click CONTINUE if you want to continue anyway (<b>some tests will be skipped!</b>) </p>'

                  $('.hosts_down').html(response);

                  $.confirm({
                      title: '<b>WARNING</b>',
                      content: hosts_down_message,
                      type: 'orange',
                      typeAnimated: true,
                      buttons: {
                          logout: function () {
                            
                              logout()

                          },
                          continue: function () {
                                
                                ret = "continue"
                                return ret
                          }
                      }
                  });
              }

          }

      },
      statusCode: {
        500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        501: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
      }
    });
}

function check_agents_after_deploy(){
    console.log( "Check injector agents!" );
    $.ajax({
      type: "GET",
      url: "{{ url_for('netcast.check_agents') }}",
      success: function (response) {


          if (response != "OK"){
         
              if ( response === "all_down" ){
                  hosts_down_message = 'The NetCAST Master is unable to connect to ALL theNetCAST injector agents on OpenStack nodes. Please contact the system administrator.'
                  
                  $.confirm({
                      title: '<b>ERROR</b>',
                      content: hosts_down_message,
                      type: 'red',
                      typeAnimated: true,
                      buttons: {
                          logout: function () {
                            
                              logout()

                          }
                      }
                  });

              }

              else {
                  
                  hosts_down_message = 'The NetCAST Master is unable to connect some NetCAST injector agents on OpenStack nodes. <p> Please check that NetCAST injector agents run on the following nodes: </p>'
                  hosts_down_message += response
                  hosts_down_message += '<p> Click CONTINUE if you want to continue anyway (<b>some tests will be skipped!</b>) </p>'

                  $('.hosts_down').html(response);

                  $.confirm({
                      title: '<b>WARNING</b>',
                      content: hosts_down_message,
                      type: 'orange',
                      typeAnimated: true,
                      buttons: {
                          logout: function () {
                            
                              logout()

                          },
                          continue: function () {
                                
                                continue_execute_tests()
                          }
                      }
                  });
              }

          }
          else
             continue_execute_tests()

      },
      statusCode: {
        500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        501: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
      }
    });
}



$( document ).ready(function() {
      
    check_agents();
    //display campaign manager modal
    $('#campaignModal').modal( {backdrop: 'static', keyboard: false} );

});


/****** START - JS for scanProgessBar ******/

function updateExecProgess() {

  $.ajax({
    type: "POST",
    url: "{{ url_for('netcast.getProgressStatus') }}",
    data: { campaign_name : $('#campaignName').text() },
    success: function (response) {
      resp = JSON.parse(response);
      last_val = $('.progress .progress-bar').text();

      if (last_val != resp['progress'] + '%') {
        $(".progress-bar").animate({width: resp['progress'] +'%'}, 2500);
        $('.progress .progress-bar').text(resp['progress'] +'%');
        $('#exp-list_analytics_col > label > text').text("All ("+resp['progress']+"%) ");
      }

      if (resp['progress'] == "100.0") {
        clearInterval(execProgessID);
        $('.progress .progress-bar').text('All tests are completed !!!')
        $('.progress').removeClass('active');
        $('#exp-list_analytics_col > label > text').text("All");
        $('#exp-list_analytics_col > label > i').prop('hidden', true);
        $('#exp-list_analytics_col > label').removeClass("btn-danger").addClass("btn-success");
      }
    },
    statusCode: {
      500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      501: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
    }
  });
}  

/****** END - JS for scanProgessBar ******/


/****** START - JS workload generator ******/
$('#selectWorkloadModal').on('show.bs.modal', function() {
  if ( $('#uRole').text() == " physical " ) {
    $('#tabSelectDefaultWorkload > div > div:nth-child(1) > text').text("\"Click on a node to attach the network workload generator...\"")
  }
  setTimeout(function(){
    $('#showNetworkTopology_workload_refresh').click()
  },300);
})

$('#showNetworkTopology_workload_editFaults').click( function () {
  $('#selectWorkloadModal').modal('hide');
  setTimeout(function() { 
    $('.nav-tabs a[href="#tabScan"]').tab('show');
  },300);
  setTimeout(function() {
    $('#scanResources').click();
    },600);  
});

var workload_network_topology_iperf_client_node = {}
var workload_network_topology_iperf_client_link = {}

var workload_network_topology_iperf_server_node = {}
var workload_network_topology_iperf_server_link = {}

var workload_network_topology_jmeter_client_node = {}
var workload_network_topology_jmeter_client_link = {}

var tmp_workload_network_topology_iperf_client_node = {}
var tmp_workload_network_topology_iperf_client_link = {}

var tmp_workload_network_topology_iperf_server_node = {}
var tmp_workload_network_topology_iperf_server_link = {}

var tmp_workload_network_topology_jmeter_client_node = {}
var tmp_workload_network_topology_jmeter_client_link = {}

var workload_network_topology;
var predefinite_workload_generators;
$('#showNetworkTopology_workload_refresh').click( function () {

  if ( $('#uRole').text() == " physical " ) {
    $('#tabSelectDefaultWorkload > div > div:nth-child(1) > text').text("Grab a detached workload generator (yellow node with the instance icon), drag it nearby a physical node (a green circle will appear) and drop the node in order to attach it. In the same way, grab an attached generator (green node with the instance icon), drag it from the physical node and drop the node in order to detach it.");
  }

  $('#workload_configuration').html("");
  $('#showNetworkTopologyObject_workload').html("");
  $('#showNetworkTopology_workload').show();
  
  $('#showNetworkTopology_workload').css("height", "500px");
  $('#showNetworkTopologyObject_workload').css("height", "500px");
  $('#workload_configuration').css("height", "500px");

  var groupResources = {
    1: "public_network",
    2: "router",
    3: "private_network",
    4: "subnet",
    5: "vm",
    6: "vm-workload",
    7: "switch",
    8: "vmPhysical",
    10: "latency",
    11: "loss",
    12: "corrupt",
    13: "delete",
    14: "duplicate",
    15: "bottleneck",
    16: "down",
    17: "reboot"
  }

  var groupLogo = {
    1: "{{ url_for('static', filename="globe_icon.png") }}",
    2: "{{ url_for('static', filename="router_icon.png") }}",
    3: "{{ url_for('static', filename="cloud_icon.png") }}",
    4: "{{ url_for('static', filename="subnet_icon.png") }}",
    5: "{{ url_for('static', filename="workstation_icon.png") }}",
    6: "{{ url_for('static', filename="workstation_icon.png") }}",
    7: "{{ url_for('static', filename="switch_icon.png") }}",
    8: "{{ url_for('static', filename="workstation_icon2.png") }}",
    10: "{{ url_for('static', filename="latency_icon.png") }}",
    11: "{{ url_for('static', filename="loss_icon.png") }}",
    12: "{{ url_for('static', filename="corruption_icon.png") }}",
    13: "{{ url_for('static', filename="delete_icon.png") }}",
    14: "{{ url_for('static', filename="duplicate_icon.png") }}",
    15: "{{ url_for('static', filename="bottleneck_icon.png") }}",
    16: "{{ url_for('static', filename="down_icon.png") }}",
    17: "{{ url_for('static', filename="reboot_icon.png") }}"
  }

  var groupWorkloadGenerator = {
    1 : "{{ url_for('static', filename="workload_generator_icon/iperf_icon.png") }}",
    2 : "{{ url_for('static', filename="workload_generator_icon/apache-jmeter_icon.png") }}"
  }

  var groupLogoSize = {
    1: 26,
    2: 24,
    3: 24,
    4: 15,
    5: 19,
    6: 19,
    7: 19,
    8: 19,
    10: 12,
    11: 12,
    12: 12,
    13: 12,
    14: 12,
    15: 16,
    16: 12,
    17: 12
  }

  var groupCircleColor = {
    1: "white",
    2: "white",
    3: "white",
    4: "white",
    5: "white",
    6: "#00ff0080",
    7: "white",
    8: "white",
    10: "#ff000080",
    11: "#ff000080",
    12: "#ff000080",
    13: "#ff000080",
    14: "#ff000080",
    15: "#ff000080",
    16: "#ff000080",
    17: "#ff000080"
  }

  var groupLogoXY = {
    1: -13,
    2: -12,
    3: -12,
    4: -7.5,
    5: -9.5,
    6: -9.5,
    7: -9.5,
    8: -9.5,
    10: -6,
    11: -6,
    12: -6,
    13: -6,
    14: -6,
    15: -8,
    16: -6,
    17: -6
  }

  var groupCircleSize = {
    1: 18,
    2: 18,
    3: 18,
    4: 15,
    5: 18,
    6: 18,
    7: 18,
    8: 18,
    10: 12,
    11: 12,
    12: 12,
    13: 12,
    14: 12,
    15: 12,
    16: 12,
    17: 12
  }

  var statusNodeIcon = {
    'NotCompleted' : "{{ url_for('static', filename="NotCompleted.png") }}",
    'completed' : "{{ url_for('static', filename="completed.png") }}",
    'error' : "{{ url_for('static', filename="error.png") }}"
  }

  if ($('#uRole').text() == " virtual ") 
    getNetTopologyURL = "{{ url_for('netcast.getNetworkTopology') }}"
  else
    getNetTopologyURL = "{{ url_for('netcast.scanPhyNetworkTopology') }}"


  var width = $('#showNetworkTopologyContainer_workload').width(),
      height = $('#showNetworkTopologyObject_workload').height();

  var color = d3.scale.category20();
  
  var force = d3.layout.force()
      .charge(-400)
      .linkDistance(50)
      .size([width, height]);

   var zoom = d3.behavior.zoom()
            .scaleExtent([1/5, 10])
            .on("zoom", zoomed);

   var drag = d3.behavior.drag()
            .origin(function(d) { return d; })
            .on("dragstart", dragstarted)
            .on("drag", dragged)
            .on("dragend", dragended);

  var svg = d3.select("#showNetworkTopologyObject_workload").append("svg")
            .attr("width", width)
            .attr("height", height)
            .call(zoom);


  var zoomContainer = svg.append("g");

  var node, link = [];

  //call "/getPredefiniteWorkloadGenerators" to get the list of workload generators (i.e. one iperf_client, one iperf_server, one jmeter_client)

  $.ajax({
    method: "POST",
    url: "{{ url_for('netcast.getPredefiniteWorkloadGenerators') }}",
    data : { 'campaign_name' : $('#campaignName').text() },
    success: function (response) {
      predefinite_workload_generators = JSON.parse(response);
      
      console.log(predefinite_workload_generators);

      $.ajax({
        method: "POST",
        //url:    "{{ url_for('netcast.getNetworkTopology') }}",
        url: getNetTopologyURL,
        data: { campaign_name : $('#campaignName').text() },
        beforeSend: function () {
            $('#showNetworkTopologyContainer_workload').append(
              '<div id="showNetworkTopologySpinner" class="panel-default" style="position: absolute; text-align: center; top: 50%; width: 561px; height: 500px;">' +
                '<span class="field-label" style="font-size:32px;color:#555;">Loading...</span>' +
                '<br>' +
                '<span class="fa fa-spinner fa-spin" style="font-size:64px;color:#555;"></span>' +
              '</div>'
            ); 
        },    
        success: function(response) {
          $('#showNetworkTopologySpinner').fadeOut(300, function() { $('#showNetworkTopologySpinner').remove();});
          workload_network_topology = JSON.parse(response);

          $.d3render_workload();

          if ( !( JSON.stringify(workload_network_topology_iperf_client_node ) === '{}' ) ) {
        
            new_link = {}
            new_link['source'] = workload_network_topology_iperf_client_link['source']['index'];
            new_link['target'] = workload_network_topology['nodes']['length']
            new_link['value'] = 1;
            new_link['distance'] = 70;

            new_node = Object.assign({}, workload_network_topology_iperf_client_node);

            workload_network_topology['nodes'].push(new_node);
            workload_network_topology['links'].push(new_link);
          }
          if ( !( JSON.stringify(workload_network_topology_iperf_server_node ) === '{}' ) ) {

            new_link = {}
            new_link['source'] = workload_network_topology_iperf_server_link['source']['index'];
            new_link['target'] = workload_network_topology['nodes']['length']
            new_link['value'] = 1;
            new_link['distance'] = 70;

            new_node = Object.assign({}, workload_network_topology_iperf_server_node);

            workload_network_topology['nodes'].push(new_node);
            workload_network_topology['links'].push(new_link);
          }

          if ( !( JSON.stringify(workload_network_topology_jmeter_client_node ) === '{}' ) ) {
            
            new_link = {}
            new_link['source'] = workload_network_topology_jmeter_client_link['source']['index'];
            new_link['target'] = workload_network_topology['nodes']['length']
            new_link['value'] = 1;
            new_link['distance'] = 70;

            new_node = Object.assign({} , workload_network_topology_jmeter_client_node );

            workload_network_topology['nodes'].push(new_node);
            workload_network_topology['links'].push(new_link);
            
          }
          
          //push int the workload_network_topology the predefinite_workload (returned from getPredefiniteWorkloadGenerators)
          for ( var i = 0; i < predefinite_workload_generators['nodes']['length']; i++ ) {
            new_node = {}
            new_node['group'] = predefinite_workload_generators['nodes'][i]['group'];
            new_node['name'] = predefinite_workload_generators['nodes'][i]['name'];
            new_node['type'] = predefinite_workload_generators['nodes'][i]['type'];
            new_node['attached'] = predefinite_workload_generators['nodes'][i]['attached'];
            new_node['args'] = {}

            //##############
            if ( $('#uRole').text() == " virtual " ) {
              new_node['args']['net_ID'] = predefinite_workload_generators['nodes'][i]['args']['net_ID'];
              new_node['args']['net_group'] = predefinite_workload_generators['nodes'][i]['args']['net_group'];
              new_node['args']['net_name'] = predefinite_workload_generators['nodes'][i]['args']['net_name'];
              new_node['args']['subnet_ID'] = predefinite_workload_generators['nodes'][i]['args']['subnet_ID'];
              new_node['args']['subnet_name'] = predefinite_workload_generators['nodes'][i]['args']['subnet_name'];  
            }
            else {
              new_node['args']['node_ip'] = predefinite_workload_generators['nodes'][i]['args']['node_ip'];  
            }
            //##############
            
            if ( new_node['name'] == "iperf client") {
              new_node['args']['bandwidth'] = predefinite_workload_generators['nodes'][i]['args']['bandwidth'];
              new_node['args']['protocol'] = predefinite_workload_generators['nodes'][i]['args']['protocol'];
            }

            else if ( new_node['name'] == "iperf server") {
              new_node['args']['server_port'] = predefinite_workload_generators['nodes'][i]['args']['server_port'];
            }

            else if ( new_node['name'] == "jmeter client") {
              new_node['args']['server_ip'] = predefinite_workload_generators['nodes'][i]['args']['server_ip'];
              new_node['args']['server_port'] = predefinite_workload_generators['nodes'][i]['args']['server_port'];
              new_node['args']['requestMethod'] = predefinite_workload_generators['nodes'][i]['args']['requestMethod'];
              new_node['args']['requestPage'] = predefinite_workload_generators['nodes'][i]['args']['requestPage'];
              new_node['args']['requestThroughput'] = predefinite_workload_generators['nodes'][i]['args']['requestThroughput'];
              new_node['args']['connect_timeout'] = predefinite_workload_generators['nodes'][i]['args']['connect_timeout'];
              new_node['args']['response_timeout'] = predefinite_workload_generators['nodes'][i]['args']['response_timeout'];
            }

            var found_wl_node = false;
            for ( var j = 0; j < workload_network_topology['nodes']['length']; j++ ) {
              if ( new_node['name'] == workload_network_topology['nodes'][j]['name'] ) {
                found_wl_node = true;
                break;
              }
            }

            if (!found_wl_node){
              console.log(found_wl_node)
              workload_network_topology['nodes'].push(new_node);
            }
          }

          for ( var i = 0; i < predefinite_workload_generators['links']['length']; i++) {
            new_link = {}
            new_link['distance'] = predefinite_workload_generators['links'][i]['distance'];
            new_link['value'] = predefinite_workload_generators['links'][i]['value'];
            new_link['source'] = predefinite_workload_generators['links'][i]['source'];
            new_link['target'] = predefinite_workload_generators['links'][i]['target'];
            workload_network_topology['links'].push(new_link);
          }


          for ( var i = 0; i < data_network_topology['nodes']['length']; i++ ) {
            if ( data_network_topology['nodes'][i]['type'] == "fault" ) {
              new_node = {}
              new_node['group'] = data_network_topology['nodes'][i]['group'];
              new_node['name'] = data_network_topology['nodes'][i]['name'];
              new_node['type'] = "fault";
              new_node['fault_target'] = {};
              new_node['fault_target']['resource_type'] = data_network_topology['nodes'][i]['fault_target']['resource_type'];
              new_node['fault_target']['resource_name'] = data_network_topology['nodes'][i]['fault_target']['resource_name'];
              new_node['fault_target']['resource_faultID'] = data_network_topology['nodes'][i]['fault_target']['resource_faultID'];
              new_node['args'] = data_network_topology['nodes'][i]['args'];
              new_node['description'] = data_network_topology['nodes'][i]['description'];

              new_node['fault_pattern'] = {}
              new_node['fault_pattern']['name'] = data_network_topology['nodes'][i]['fault_pattern']['name'];
              new_node['fault_pattern']['args'] = {}
              new_node['fault_pattern']['args']['arg1'] = data_network_topology['nodes'][i]['fault_pattern']['args']['arg1'];
              new_node['fault_pattern']['args']['arg2'] = data_network_topology['nodes'][i]['fault_pattern']['args']['arg2'];
              
              new_node['fault_target_traffic'] = {}
              new_node['fault_target_traffic']['name'] = data_network_topology['nodes'][i]['fault_target_traffic']['name'];
              new_node['fault_target_traffic']['args'] = {}
              new_node['fault_target_traffic']['args']['protocol'] = data_network_topology['nodes'][i]['fault_target_traffic']['args']['protocol'];
              new_node['fault_target_traffic']['args']['src_ports'] = data_network_topology['nodes'][i]['fault_target_traffic']['args']['src_ports'];
              new_node['fault_target_traffic']['args']['dst_ports'] = data_network_topology['nodes'][i]['fault_target_traffic']['args']['dst_ports'];

              new_node['status'] = data_network_topology['nodes'][i]['status']

              new_link = {}

              // get correspondent res_id (i.e. net_id or router_id)
              var res_id = null;
              for ( var j = 0; j < data_network_topology['links']['length']; j++ ) {
                if ( data_network_topology['links'][j]['target']['fault_target']['resource_faultID'] == data_network_topology['nodes'][i]['fault_target']['resource_faultID'] ) {
                  res_id = data_network_topology['links'][j]['source']['ID'];
                  break;
                }
              }

              for ( var j = 0; j < workload_network_topology['nodes']['length']; j++ ) {
                if ( workload_network_topology['nodes'][j]['ID'] == res_id ) {
                  new_link['source'] = workload_network_topology['nodes'][j]['index'];
                  break;
                }
              }
              new_link['target'] = workload_network_topology['nodes']["length"];
              new_link['value'] = 0;
              new_link['distance'] = 20;

              workload_network_topology['nodes'].push(new_node);
              workload_network_topology['links'].push(new_link);

              /****************
                new_link = {}
                new_link['source'] = node_index;
                new_link['target'] = data_network_topology['nodes']["length"];
                new_link['value'] = 0;
                new_link['distance'] = 20;

                var found = false;
                for ( var i = 0; i < data_network_topology['nodes']["length"]; i++ ) {
                  if ( data_network_topology['nodes'][i]['type'] == "fault" ) {
                    if ( data_network_topology['nodes'][i]['name'] == new_node['name'] && 
                          data_network_topology['nodes'][i]['args'] == new_node['args'] &&
                          data_network_topology['nodes'][i]['fault_target']['resource_faultID'] == new_node['fault_target']['resource_faultID']) {
                      found = true;
                      break;
                    }
                  }
                }

                if (!found) {
                  data_network_topology['nodes'].push(new_node);
                  data_network_topology['links'].push(new_link);

              *********************/

            }
          }

          $.d3render_workload();

          // init tmp_worklaod_configuration_nodes with the saved configuration
          for ( var i = 0; i < workload_network_topology['nodes']['length']; i++ ) {
            if ( workload_network_topology['nodes'][i]['name'] == "iperf client" ) {
              tmp_workload_network_topology_iperf_client_node = Object.assign({}, workload_network_topology['nodes'][i]);
            }
            if ( workload_network_topology['nodes'][i]['name'] == "iperf server" ) {
              tmp_workload_network_topology_iperf_server_node = Object.assign({}, workload_network_topology['nodes'][i]);    
            }
            if ( workload_network_topology['nodes'][i]['name'] == "jmeter client" ) {
              tmp_workload_network_topology_jmeter_client_node = Object.assign({}, workload_network_topology['nodes'][i]);    
            }
          }
 
          for ( var i = 0; i < workload_network_topology['links']['length']; i++ ) {
            if ( workload_network_topology['links'][i]['target']['name'] == "iperf client" ) {
              tmp_workload_network_topology_iperf_client_link = Object.assign({}, workload_network_topology['links'][i]);    
            }
            if ( workload_network_topology['links'][i]['target']['name'] == "iperf server" ) {
              tmp_workload_network_topology_iperf_server_link = Object.assign({}, workload_network_topology['links'][i]);
            }
            if ( workload_network_topology['links'][i]['target']['name'] == "jmeter client" ) {
              tmp_workload_network_topology_jmeter_client_link = Object.assign({}, workload_network_topology['links'][i]);
            }
          }

          if ( LOADED ) {
            for ( var i = 0; i < workload_network_topology['nodes']['length']; i++ ) {
              if ( workload_network_topology['nodes'][i]['type'] == "fault" && ( workload_network_topology['nodes'][i]['status'] == "completed" || workload_network_topology['nodes'][i]['status'] == "error") ) {
                $.confirm({
                          title: '<b>WARNING</b>',
                          content: 'For this campaign, there are some tests in completed or error status. The user can not reconfigure the workload configuration.',
                          type: 'orange',
                          typeAnimated: true,
                          buttons: {
                              logout: function () { logout(); },
                              ok: function() { return; }
                          }
                      });
                $('#selectWorkloadSave').hide();
                $('#executeTestCases').prop('disabled', false);
                break;
              }
            }
          }
          
        },
        statusCode: {
          500:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          501:  function (response) { alert('Error during scan for network resources. Please check NetCAST master agent logs.'); location.reload(); },
          400:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          0:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        }
      });

    },
    statusCode: {
      500:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      501:  function (response) { alert('Error during scan for network resources. Please check NetCAST master agent logs.'); location.reload(); },
      400:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      0:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
    }
  });


  jQuery.d3render_workload = function d3render_workload() {

    my_node = workload_network_topology['nodes'];
    my_link = workload_network_topology['links'];

    force.nodes(my_node)
          .links(my_link)
          .linkDistance(d => d.distance)
          .start();

    var link = zoomContainer.selectAll(".link").remove();

    var link = zoomContainer.selectAll(".link").data(my_link);

    link.enter().append("line")
        .attr("class", "link")
        .style("stroke-width", function(d) { return Math.sqrt(d.value); });

    link.exit().remove();

    var node = zoomContainer.selectAll(".node").remove();
    var node = zoomContainer.selectAll(".node").data(my_node);

    var nodeEnter = node.enter().append("g")
        .attr("class", "node")
        .call(drag)
        .on("click", handleClickNode_workload);

    nodeEnter.append("circle")
        .attr({ r : function(d) { return groupCircleSize[d.group] * 1.5 }})
        .attr("cx", 0)
        .attr("cy", 0)
        .style("fill", "orange")
        .style("opacity", 0);

    nodeEnter.append("circle")
        .attr("r", function(d) { return groupCircleSize[d.group] })
        .attr("cx", 0)
        .attr("cy", 0)
        .style("fill", function(d, i) { 
          if ( groupResources[d.group] == "vm-workload" ) {
            if ( workload_network_topology['nodes'][i]['attached'] == "false" )
              return "yellow";
            else
              return groupCircleColor[d.group];
          }
          else 
            return groupCircleColor[d.group];
        });

    nodeEnter.append("png:image")
        .attr("xlink:href", function(d) { return groupLogo[d.group] })     
        .attr("x", function(d) { return groupLogoXY[d.group] })
        .attr("y", function(d) { return groupLogoXY[d.group] })
        .attr("width", function(d) { return groupLogoSize[d.group] })
        .attr("height", function(d) { return groupLogoSize[d.group] });

    nodeEnter.append("png:image")
        .attr("xlink:href", function(d, i) { 
          if ( groupResources[d.group] == "vm-workload" ) {
            if ( workload_network_topology['nodes'][i]['name'] == "jmeter client" )
              return groupWorkloadGenerator[2];
            else
              return groupWorkloadGenerator[1];
            }
            else 
              return null;
          })     
        .attr("x", function(d) { return groupLogoXY[d.group] - 15 })
        .attr("y", function(d) { return groupLogoXY[d.group] - 47.5})
        .attr("width", function(d) { return groupLogoSize[d.group] * 3 })
        .attr("height", function(d) { return groupLogoSize[d.group] * 3 });

    nodeEnter.append("text")
        .attr("dx", +22)
        .attr("dy", +5)
        .text(function(d) { return d.name });

    nodeEnter.append("png:image")
        .attr("xlink:href", function(d, i) { 
          if ( workload_network_topology['nodes'][i]['type'] == "fault" )
            return statusNodeIcon[ workload_network_topology['nodes'][i]['status'] ];
          else
            return null;
          })     
        .attr("x", function(d) { return groupLogoXY[d.group] + 15 })
        .attr("y", function(d) { return groupLogoXY[d.group] - 15 })
        .attr("width", function(d) { return 12 })
        .attr("height", function(d) { return 12 });
    
    node.exit().remove();

    force.on("tick", function() {
      link.attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

      node.attr("transform", function(d) { return "translate(" + (d.x) + "," + (d.y) + ")"; });

    });
  }

  function dragstarted(d, i) {

    $('#workload_configuration').html("");

    d3.event.sourceEvent.stopPropagation();
    //d3.select(this).classed("dragging", true);
    //force.start();
    d3.select(this).classed("fixed", d.fixed = true);

    //turn off others active node
    d3.selectAll('circle')
        .filter(function(d, i) { return (i%2) == 0  })
        .style("opacity", 0);
    
    //activate only clicked node 
    if (groupResources[workload_network_topology['nodes'][i]['group']] == "vm-workload") {
      d3.select(this).select('circle')
        .filter(function(d, i) { return i == 0 })
        .style("opacity", 1);
 
      force.stop();

      //activate the subnet nodes to indicate to the user where to attach the vm-workload node
      if ( workload_network_topology['nodes'][i]['attached'] == "false" ) {
        var link = zoomContainer.selectAll(".link");
        var node = zoomContainer.selectAll(".node");

        for ( var j = 0; j < workload_network_topology['nodes']['length']; j++ ) {
          // if (uRole == virtual) ==> active subnet node 
          if ( groupResources[workload_network_topology['nodes'][j]['group']] == "subnet" ) {
            node.select('circle')
                .filter( function ( d, i) {return i == j})
                .style("fill", "#00ff0080")
                .style("opacity", 1);
          }
          // if (uRole == physical) ==> active vmPhysical node
          if ( groupResources[workload_network_topology['nodes'][j]['group']] == "vmPhysical" ) {
            node.select('circle')
                .filter( function ( d, i) {return i == j})
                .style("fill", "#00ff0080")
                .style("opacity", 1);
          } 
        }  
      }
    }
  }

  function dragged(d, i) {
    
    var link = zoomContainer.selectAll(".link");
    var node = zoomContainer.selectAll(".node");

    //d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
    if (groupResources[workload_network_topology['nodes'][i]['group']] == "vm-workload") {
      force.stop();

      var r = 19;

      sourceX = d.x;
      sourceY = d.y;

      if ( workload_network_topology['nodes'][i]['attached'] == "false" ) {
        for (var j = 0; j < workload_network_topology['nodes'].length; j++ ){
          if (groupResources[workload_network_topology['nodes'][j]['group']] == "subnet" || groupResources[workload_network_topology['nodes'][j]['group']] == "vmPhysical" ) {
            targetX = workload_network_topology['nodes'][j]['x'];
            targetY = workload_network_topology['nodes'][j]['y'];
            distance =  Math.sqrt( Math.pow(targetX - sourceX, 2) + Math.pow(targetY - sourceY, 2) );
            if ( distance < 3*r ) {
              //reset other nodes
              node.selectAll('circle')
                  .filter( function(d, i) {return i%2 == 0})
                  .attr({ r : function(d) { return groupCircleSize[d.group] * 1.5 }});

              //set correspondent ndoe
              node.select('circle')
                  .filter( function ( d, i) {return i == j} )
                  .attr({ r : function(d) { return groupCircleSize[d.group] * 3 }});

              break;
            }
            else {
              //reset node
              node.select('circle')
                  .filter( function ( d, i) {return i == j})
                  .attr({ r : function(d) { return groupCircleSize[d.group] * 1.5 }})
            }
          }
        }
      }

    }
    else {
      force.start();
    }
    
    d.px += d3.event.dx;
    d.py += d3.event.dy;
    d.x += d3.event.dx;
    d.y += d3.event.dy;
    
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

  }

  function dragended(d, i) {
    
    d3.select(this).classed("fixed", d.fixed = false);

    if (groupResources[workload_network_topology['nodes'][i]['group']] == "vm-workload") {
      var r = 19;

      sourceX = d.x;
      sourceY = d.y;

      if ( workload_network_topology['nodes'][i]['attached'] == "false" ) {
        for ( var j = 0; j < workload_network_topology['nodes'].length; j++ ){
          if ( groupResources[workload_network_topology['nodes'][j]['group']] == "subnet" || groupResources[workload_network_topology['nodes'][j]['group']] == "vmPhysical" ) {
            targetX = workload_network_topology['nodes'][j]['x'];
            targetY = workload_network_topology['nodes'][j]['y'];
            distance =  Math.sqrt( Math.pow(targetX - sourceX, 2) + Math.pow(targetY - sourceY, 2) );
            if ( distance < 3*r ) {
              console.log("FOUND SUBNET COLLIDED ");
              console.log("NODE " + j);
              workload_network_topology['nodes'][i]['attached'] = "true";
              createNewLink(j, i);
              if ( workload_network_topology['nodes'][i]['name'] == "iperf client" ) {
                //check multiple vm-workload iperf_client
                if ( !( tmp_workload_network_topology_iperf_client_node['attached'] === "false" ) ) {
                  workload_network_topology['nodes'][i]['attached'] = "false";
                  workload_network_topology['links'].splice(workload_network_topology['links'].length - 1 , 1);
                  $.d3render_workload();
                  d3recolor();
                  alert("NetCAST supports only one instance for each type of vm-workload");
                }
                else if ( !( tmp_workload_network_topology_jmeter_client_node['attached'] === "false" ) ) {
                  workload_network_topology['nodes'][i]['attached'] = "false";
                  workload_network_topology['links'].splice(workload_network_topology['links'].length - 1 , 1);
                  $.d3render_workload();
                  d3recolor();
                  alert("NetCAST supports only one type of vm-workload (JMeter client is already deployed)")
                }
                else {
                  //add correspondent net/subnet information
                  net_subnet_info = getNetSubnetInfo(j);

                  //virtual mode
                  if ( $('#uRole').text()  == " virtual ") {
                    if ( !( tmp_workload_network_topology_iperf_server_node['attached'] === "false" ) &&  net_subnet_info['net_group'] == 1 && tmp_workload_network_topology_iperf_server_node['args']['net_ID'] == net_subnet_info['net_ID'] ) {
                      workload_network_topology['nodes'][i]['attached'] = "false";
                      workload_network_topology['links'].splice(workload_network_topology['links'].length - 1 , 1);
                      $.d3render_workload();
                      d3recolor();
                      alert("iPerf client and iPerf server cannot be deployed on public networks at the some time!")
                    }
                    else {
                      workload_network_topology['nodes'][i]['args']['net_ID'] = net_subnet_info['net_ID'];
                      workload_network_topology['nodes'][i]['args']['net_group'] = net_subnet_info['net_group'];
                      workload_network_topology['nodes'][i]['args']['net_name'] = net_subnet_info['net_name'];
                      workload_network_topology['nodes'][i]['args']['subnet_ID'] = net_subnet_info['subnet_ID'];
                      workload_network_topology['nodes'][i]['args']['subnet_name'] = net_subnet_info['subnet_name'];

                      tmp_workload_network_topology_iperf_client_node = Object.assign({}, workload_network_topology['nodes'][i]);
                      tmp_workload_network_topology_iperf_client_link = Object.assign({}, workload_network_topology['links'][workload_network_topology['links']['length']-1]);

                      handleClickNode_workload(d, i);
                    }
                  }

                  //physical mode
                  else {

                    workload_network_topology['nodes'][i]['args']['node_ip'] = net_subnet_info['node_ip'];

                    tmp_workload_network_topology_iperf_client_node = Object.assign({}, workload_network_topology['nodes'][i]);
                    tmp_workload_network_topology_iperf_client_link = Object.assign({}, workload_network_topology['links'][workload_network_topology['links']['length']-1]);

                    handleClickNode_workload(d, i);
                  } 
                    
                }       
              }

              else if ( workload_network_topology['nodes'][i]['name'] == "iperf server" ) {
                //check multiple vm-workload iperf_server
                if ( !( tmp_workload_network_topology_iperf_server_node['attached'] === "false" ) ) {
                  workload_network_topology['nodes'][i]['attached'] = "false";
                  workload_network_topology['links'].splice(workload_network_topology['links'].length - 1 , 1);
                  $.d3render_workload();
                  d3recolor();
                  alert("NetCAST supports only one instance for each type of vm-workload");
                }
                else if ( !( tmp_workload_network_topology_jmeter_client_node['attached'] === "false" ) ) {
                  workload_network_topology['nodes'][i]['attached'] = "false";
                  workload_network_topology['links'].splice(workload_network_topology['links'].length - 1 , 1);
                  $.d3render_workload();
                  d3recolor();
                  alert("NetCAST supports only one type of vm-workload (JMeter client is already deployed)")
                }
                else {
                  //add correspondent net/subnet information
                  net_subnet_info = getNetSubnetInfo(j);

                  //virtual mode
                  if ( $('#uRole').text()  == " virtual ") {
                    if ( !( tmp_workload_network_topology_iperf_client_node['attached'] === "false" ) &&  net_subnet_info['net_group'] == 1 && tmp_workload_network_topology_iperf_client_node['args']['net_ID'] == net_subnet_info['net_ID'] ) {
                      workload_network_topology['nodes'][i]['attached'] = "false";
                      workload_network_topology['links'].splice(workload_network_topology['links'].length - 1 , 1);
                      $.d3render_workload();
                      d3recolor();
                      alert("iPerf client and iPerf server cannot be deployed on public networks at the some time!")
                    }
                    else {
                      workload_network_topology['nodes'][i]['args']['net_ID'] = net_subnet_info['net_ID'];
                      workload_network_topology['nodes'][i]['args']['net_group'] = net_subnet_info['net_group'];
                      workload_network_topology['nodes'][i]['args']['net_name'] = net_subnet_info['net_name'];
                      workload_network_topology['nodes'][i]['args']['subnet_ID'] = net_subnet_info['subnet_ID'];
                      workload_network_topology['nodes'][i]['args']['subnet_name'] = net_subnet_info['subnet_name'];

                      tmp_workload_network_topology_iperf_server_node = Object.assign({}, workload_network_topology['nodes'][i]);
                      tmp_workload_network_topology_iperf_server_link = Object.assign({}, workload_network_topology['links'][workload_network_topology['links']['length']-1]);

                      handleClickNode_workload(d, i);
                    }
                  }

                  //physical mode
                  else {

                    workload_network_topology['nodes'][i]['args']['node_ip'] = net_subnet_info['node_ip'];

                    tmp_workload_network_topology_iperf_server_node = Object.assign({}, workload_network_topology['nodes'][i]);
                    tmp_workload_network_topology_iperf_server_link = Object.assign({}, workload_network_topology['links'][workload_network_topology['links']['length']-1]);

                    handleClickNode_workload(d, i);
                  }

                }
              }

              else if ( workload_network_topology['nodes'][i]['name'] == "jmeter client" ) {
                //check multiple vm-workload jmeter_client
                if ( !( tmp_workload_network_topology_jmeter_client_node['attached'] === "false" ) ) {
                  workload_network_topology['nodes'][i]['attached'] = "false";
                  workload_network_topology['links'].splice(workload_network_topology['links'].length - 1 , 1);
                  $.d3render_workload();
                  d3recolor();
                  alert("NetCAST supports only one instance for each type of vm-workload");
                }
                else if ( !( tmp_workload_network_topology_iperf_client_node['attached'] === "false" ) ) {
                  workload_network_topology['nodes'][i]['attached'] = "false";
                  workload_network_topology['links'].splice(workload_network_topology['links'].length - 1 , 1);
                  $.d3render_workload();
                  d3recolor();
                  alert("NetCAST supports only one type of vm-workload (iPerf client is already deployed)")
                }
                else if ( !( tmp_workload_network_topology_iperf_server_node['attached'] === "false" ) ) {
                  workload_network_topology['nodes'][i]['attached'] = "false";
                  workload_network_topology['links'].splice(workload_network_topology['links'].length - 1 , 1);
                  $.d3render_workload();
                  d3recolor();
                  alert("NetCAST supports only one type of vm-workload (iPerf server is already deployed)")
                }
                else {
                  //add correspondent net/subnet information
                  net_subnet_info = getNetSubnetInfo(j);

                  //virtual mode
                  if ( $('#uRole').text()  == " virtual ") {
                    workload_network_topology['nodes'][i]['args']['net_ID'] = net_subnet_info['net_ID'];
                    workload_network_topology['nodes'][i]['args']['net_group'] = net_subnet_info['net_group'];
                    workload_network_topology['nodes'][i]['args']['net_name'] = net_subnet_info['net_name'];
                    workload_network_topology['nodes'][i]['args']['subnet_ID'] = net_subnet_info['subnet_ID'];
                    workload_network_topology['nodes'][i]['args']['subnet_name'] = net_subnet_info['subnet_name'];  
                  }
                  //physical mode
                  else {
                    workload_network_topology['nodes'][i]['args']['node_ip'] = net_subnet_info['node_ip'];  
                  }
                  

                  tmp_workload_network_topology_jmeter_client_node = Object.assign({}, workload_network_topology['nodes'][i]);
                  tmp_workload_network_topology_jmeter_client_link = Object.assign({}, workload_network_topology['links'][workload_network_topology['links']['length']-1]);

                  handleClickNode_workload(d, i);

                }
              }
              break;
            }
          }
        }

        //################################



        //###############################
      }
      else if ( workload_network_topology['nodes'][i]['attached'] == "true" ) {
        for ( var j = 0; j < workload_network_topology['links']['length']; j++ ) {
          if ( workload_network_topology['links'][j]['target']['index'] == i ) {
            index_subnet = workload_network_topology['links'][j]['source']['index'];

            targetX = workload_network_topology['nodes'][index_subnet]['x'];
            targetY = workload_network_topology['nodes'][index_subnet]['y'];

            distance =  Math.sqrt( Math.pow(targetX - sourceX, 2) + Math.pow(targetY - sourceY, 2) )

            if ( distance > 6*r ) {
              if ( workload_network_topology['nodes'][i]['name'] == "iperf client" ) {               
                tmp_workload_network_topology_iperf_client_node['attached'] = "false";
                tmp_workload_network_topology_iperf_client_link = {};
              }
              else if ( workload_network_topology['nodes'][i]['name'] == "iperf server" ) {
                tmp_workload_network_topology_iperf_server_node['attached'] = "false";
                tmp_workload_network_topology_iperf_server_link = {};
              }
              else if ( workload_network_topology['nodes'][i]['name'] == "jmeter client" ) {
                tmp_workload_network_topology_jmeter_client_node['attached'] = "false";
                tmp_workload_network_topology_jmeter_client_link = {};
              }
              workload_network_topology['links'].splice(j, 1);
              workload_network_topology['nodes'][i]['attached'] = "false";


              //reset predefinite_information
              for ( var k = 0; k < predefinite_workload_generators['nodes']['length']; k ++ ) {
                if ( workload_network_topology['nodes'][i]['name'] == predefinite_workload_generators['nodes'][k]['name'] ) {

                  if ( workload_network_topology['nodes'][i]['name'] == "iperf client") {
                    workload_network_topology['nodes'][i]['args']['bandwidth'] = predefinite_workload_generators['nodes'][k]['args']['bandwidth'];
                    workload_network_topology['nodes'][i]['args']['protocol'] = predefinite_workload_generators['nodes'][k]['args']['protocol'];
                  }

                  else if ( workload_network_topology['nodes'][i]['name'] == "iperf server") {
                    workload_network_topology['nodes'][i]['args']['server_port'] = predefinite_workload_generators['nodes'][k]['args']['server_port'];
                  }

                  else if ( workload_network_topology['nodes'][i]['name'] == "jmeter client") {
                    workload_network_topology['nodes'][i]['args']['server_ip'] = predefinite_workload_generators['nodes'][k]['args']['server_ip'];
                    workload_network_topology['nodes'][i]['args']['server_port'] = predefinite_workload_generators['nodes'][k]['args']['server_port'];
                    workload_network_topology['nodes'][i]['args']['requestMethod'] = predefinite_workload_generators['nodes'][k]['args']['requestMethod'];
                    workload_network_topology['nodes'][i]['args']['requestPage'] = predefinite_workload_generators['nodes'][k]['args']['requestPage'];
                    workload_network_topology['nodes'][i]['args']['requestThroughput'] = predefinite_workload_generators['nodes'][k]['args']['requestThroughput'];
                    workload_network_topology['nodes'][i]['args']['connect_timeout'] = predefinite_workload_generators['nodes'][k]['args']['connect_timeout'];
                    workload_network_topology['nodes'][i]['args']['response_timeout'] = predefinite_workload_generators['nodes'][k]['args']['response_timeout'];
                  }

                }
              }

              $('#workload_configuration').html("");
              //clear node_subnet and net_subnet information
              /*
              workload_network_topology['nodes'][i]['args']['net_ID'] = "";
              workload_network_topology['nodes'][i]['args']['net_group'] = "";
              workload_network_topology['nodes'][i]['args']['net_name'] = "";
              workload_network_topology['nodes'][i]['args']['subnet_ID'] = "";
              workload_network_topology['nodes'][i]['args']['subnet_name'] = "";
              */

              $.d3render_workload();
              d3recolor();
            }

            break;
          }
        }
      }
    }
    force.resume();
  }

  function getNetSubnetInfo(source_node_index) {
    //source_node_index is subnet in virtual mode and vm node in physical mode
    net_subnet_info = {}
    
    if ( $('#uRole').text() == " virtual " ) {
      for ( var i = 0; i < workload_network_topology['links']["length"]; i++) {
        if ( workload_network_topology['links'][i]['target']['ID'] == workload_network_topology['nodes'][source_node_index]['ID']) {
          net_subnet_info['net_ID'] = workload_network_topology['links'][i]['source']['ID'];
          net_subnet_info['net_name'] = workload_network_topology['links'][i]['source']['name'];
          net_subnet_info['net_group'] = workload_network_topology['links'][i]['source']['group']
          break;
        }
      }

      net_subnet_info['subnet_ID'] = workload_network_topology['nodes'][source_node_index]['ID'];
      net_subnet_info['subnet_name'] = workload_network_topology['nodes'][source_node_index]['name'];   
    }

    else {

      net_subnet_info['node_ip'] = workload_network_topology['nodes'][source_node_index]['name'];
    } 
    

    return net_subnet_info
  }

  function createNewLink(source, target) {
      new_link = {}
      new_link['source'] = source;
      new_link['target'] = target;
      new_link['distance'] = 70;
      new_link['value'] = 1;
      workload_network_topology['links'].push(new_link);
      $.d3render_workload();
      d3recolor();
  }

  function zoomed() {
    zoomContainer.attr("transform", function () { return "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")";});
  }

  function d3recolor() {
    d3.selectAll('circle')
      //.attr({ r : function(d) { return groupCircleSize[d.group] } })
      //.style("fill", function(d) { return groupCircleColor[d.group] });
      .filter(function(d, i) { return (i%2) == 0  })
      .style("opacity", 0);
  }

  var node_index = null;
  function handleClickNode_workload(d, i) {
    node_index = i;
    $('#workload_configuration').html("");
    /**** emphasized_node ****/

    //turn off others active node
    d3.selectAll('circle')
      .filter(function(d, i) { return (i%2) == 0  })
      .style("opacity", 0);
      
    //active only clicked fault node or vm-workload

    if ( ( workload_network_topology['nodes'][node_index]['group'] == 6 && workload_network_topology['nodes'][node_index]['attached'] == "true" ) || workload_network_topology['nodes'][node_index]['type'] == "fault" ) {

      var node = zoomContainer.selectAll(".node");

      node.select('circle')
        .filter(function(d, i) { return i == node_index })
        .style("opacity", 1);
      }

    console.log(workload_network_topology);
    
    if ( workload_network_topology['nodes'][node_index]['type'] == "fault" ) {

      $('#workload_configuration').append(
        '<div id="workload_configuration_content" class="modal-dialog modal-content" style="top: 15px; width: 300px; background-color: aliceblue; border: 1px #555 solid; margin-top: 0px;">' +
          '<div class="modal-header">' +
            '<h5 class="modal-title" style="display: inline";>Workload configuration</h5>' +
            '<button id="workload_configuration_header_close" type="button" class="close">' +
              '<span aria-hidden="true">×</span>' +
            '</button>' +
          '</div>' +
          '<div class="modal-body">' +
            
            '<div class="row">' +
              '<div class="col-sm-6" style="text-align: center">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label">' +
                    '<span class="field-label">Resource type:</span>' +
                  '</label>' +
                  '<br>' +
                  '<div class="form-group">' +
                    '<text id="workload_configuration_RS" type="text">' + workload_network_topology['nodes'][node_index]['fault_target']['resource_type'] + '<br>' + workload_network_topology['nodes'][node_index]['fault_target']['resource_name'] + '</text>' +
                  '</div>' +
                '</div>' +
              '</div>' +
              '<div class="col-sm-6" style="text-align: center">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label" style="display: block;">' +
                    '<span class="field-label">Fault type:</span>' +
                  '</label>' +
                  '<div class="form-group">' +
                    '<text id="workload_configuration_FL" type="text">' + workload_network_topology['nodes'][node_index]['name'] + '</input>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +

            '<div class="row" style="text-align: center; margin-bottom: 15px;">' +
              '<a data-toggle="collapse" data-target="#fault_conf_details_workload" class="collapsed">show details ' +
                '<span class="glyphicon glyphicon-chevron-down" style="font-size: small;"></span> ' +
              '</a>' +
            '</div>' +

            '<div id="fault_conf_details_workload" class="collapse"> '+
              '<div class="panel panel-default">' +
                '<div id="workload_configuration_FL_description" class="panel-body">' + workload_network_topology['nodes'][node_index]['description'] +
                '</div>' +
              '</div>' +

              '<div class="row">' +
                '<div class="col-sm-6" style="text-align: center">' +
                  '<div class="form-group" style="display: inline-block;">' +
                    '<label class="control-label">' +
                      '<span id="workload_configuration_FL_args_unit" class="field-label">Configuration:</span>' +
                    '</label>' +
                    '<div class="form-group">' +
                      '<text id="workload_configuration_FL_args" type="text">' + workload_network_topology['nodes'][node_index]['args'] + '</text>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
              '</div>' +

              // fault pattern params
              //
              '<hr>' +
              '<div class="row">' +
                '<div class="col-sm-4" style="text-align: center">' +
                  '<div class="form-group" style="display: inline-block;">' +
                    '<label class="control-label">' +
                      '<span class="field-label">Fault pattern:</span>' +
                    '</label>' +
                    '<div class="form-group">' +
                      '<text id="faultload_configuration_FL_pattern_name" type="text">' + workload_network_topology['nodes'][node_index]['fault_pattern']['name'] + '</text>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
                '<div class="col-sm-8" style="text-align: center">' +
                  '<div id="faultload_configuration_FL_args_pattern_container">' +
                    //input fields set properly on node['fault_pattern']['name']
                  '</div>' +  
                '</div>' +
              '</div>' +

              '<hr>' +
              '<div class="row">' +
                '<div class="col-sm-5" style="text-align: center">' +
                  '<div class="form-group" style="display: inline-block;">' +
                    '<label class="control-label">' +
                      '<span class="field-label">Fault target:</span>' +
                    '</label>' +
                    '<div class="form-group">' +
                      '<text id="faultload_configuration_FL_target_name" type="text">' + workload_network_topology['nodes'][node_index]['fault_target_traffic']['name'] + '</text>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
                '<div class="col-sm-7" style="text-align: center">' +
                  '<div id="faultload_configuration_FL_args_target_container">' +
                    //input fields set properly on node['fault_target_traffic']['name'] 
                  '</div>' +  
                '</div>' +
              '</div>' +

              // fault target traffic params
            '</div>' +
          '</div>' +
        '</div>'
      );

      //********************
      if ( workload_network_topology['nodes'][node_index]['fault_pattern']['name']  == "random") {
        $('#faultload_configuration_FL_args_pattern_container').append(
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_pattern_unit" class="field-label">Probability of faulty packet (%):</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_pattern" type="text">' + workload_network_topology['nodes'][node_index]['fault_pattern']['args']['arg1'] + '</text>' +
            '</div>'
          );
      } 
      else if ( workload_network_topology['nodes'][node_index]['fault_pattern']['name'] == "persistent" ) {
        $('#faultload_configuration_FL_args_pattern_container').append(
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_pattern_unit" class="field-label">N/A</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_pattern" type="text">Empty</text>' +
            '</div>'
          );
      }
      else if ( workload_network_topology['nodes'][node_index]['fault_pattern']['name'] == "burst" ) {
        $('#faultload_configuration_FL_args_pattern_container').append(
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_pattern_unit" class="field-label">Burst duration (ms):</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_pattern" type="text">' + workload_network_topology['nodes'][node_index]['fault_pattern']['args']['arg1'] + '</text>' +
            '</div>' +
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_pattern_1_unit" class="field-label">Burst periodicity (ms):</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_pattern_1" type="text">' + workload_network_topology['nodes'][node_index]['fault_pattern']['args']['arg2'] + '</text>' +
            '</div>'
          );
      }
      else if ( workload_network_topology['nodes'][node_index]['fault_pattern']['name'] == "degradation" ) {
        $('#faultload_configuration_FL_args_pattern_container').append(
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_pattern_unit" class="field-label">Rate of packet degradation (%):</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_pattern" type="text">' + workload_network_topology['nodes'][node_index]['fault_pattern']['args']['arg1'] + '</text>' +
            '</div>'
          );
      }

      if ( workload_network_topology['nodes'][node_index]['fault_target_traffic']['name'] !== "User-specified traffic" ) {
        $('#faultload_configuration_FL_args_target_container').html("");
        $('#faultload_configuration_FL_args_target_container').append(
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_taget_unit" class="field-label">Protocol:</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_target" type="text"></text>' +
            '</div>' +  
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_taget_1_unit" class="field-label">SRC Ports:</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_target_1" type="text" size="15"></text>' +
            '</div>' +
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_taget_2_unit" class="field-label">DST Ports:</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_target_2" type="text" size="15"></text>' +
            '</div>'
          );
        $('#faultload_configuration_FL_args_target_1').html("Empty");

        if ( workload_network_topology['nodes'][node_index]['fault_target_traffic']['name'] == "any traffic" ) {
          $('#faultload_configuration_FL_args_target').html("Empty");
          $('#faultload_configuration_FL_args_target_2').html("Empty");
        }
        else {
          $('#faultload_configuration_FL_args_target').html(workload_network_topology['nodes'][node_index]['fault_target_traffic']['args']['protocol']);
          $('#faultload_configuration_FL_args_target_2').html(workload_network_topology['nodes'][node_index]['fault_target_traffic']['args']['dst_ports']);
        }
      }
      else {
        //TODO: ADD properly input filed. Protocol is defined
        $('#faultload_configuration_FL_args_target_container').html("");
        $('#faultload_configuration_FL_args_target_container').append(
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_taget_unit" class="field-label">Protocol:</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_target" type="text">' + workload_network_topology['nodes'][node_index]['fault_target_traffic']['args']['protocol'] + '</text>' +
            '</div>' +
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_taget_1_unit" class="field-label">SRC Ports:</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_target_1" type="text"></text>' +
            '</div>' +
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_taget_2_unit" class="field-label">DST Ports:</span>' +
            '</label>' +
            '<div class="form-group">' +
                '<text id="faultload_configuration_FL_args_target_2" type="text"></text>' +
            '</div>'
          );

        if ( !workload_network_topology['nodes'][node_index]['fault_target_traffic']['args']['src_ports'] ) {
          $('#faultload_configuration_FL_args_target_1').html("Empty");
        }
        else {
          $('#faultload_configuration_FL_args_target_1').html(workload_network_topology['nodes'][node_index]['fault_target_traffic']['args']['src_ports']); 
        }

        if ( !workload_network_topology['nodes'][node_index]['fault_target_traffic']['args']['dst_ports'] ) {
          $('#faultload_configuration_FL_args_target_2').html("Empty");
        }
        else {
          $('#faultload_configuration_FL_args_target_2').html(workload_network_topology['nodes'][node_index]['fault_target_traffic']['args']['dst_ports']);
        }

      }

      //*************************************************

      if ( workload_network_topology['nodes'][node_index]['name'] == "latency" ) {
        $('#workload_configuration_FL_args_unit').text("Args (ms): ");
      }
      else if ( workload_network_topology['nodes'][node_index]['name'] == "delete" || workload_network_topology['nodes'][node_index]['name'] == "corrupt" || workload_network_topology['nodes'][node_index]['name'] == "loss" || workload_network_topology['nodes'][node_index]['name'] == "duplicate") {
       $('#workload_configuration_FL_args_unit').text(""); 
      }
      else if ( workload_network_topology['nodes'][node_index]['name'] == "bottleneck" ) {
        $('#workload_configuration_FL_args_unit').text("Args (KBits): ");  
      }
      else {
        $('#workload_configuration_FL_args_unit').text("Args (%): ");  
      }

      $('#workload_configuration_header_close').click( function () {
        $('#workload_configuration').html("");
        d3recolor();
      });


      //event on show/hide details in "Workload configuration"
      $('#fault_conf_details_workload').on('show.bs.collapse', function () {
        $('#workload_configuration_content > div.modal-body > div:nth-child(2) > a').html('hide details <span class="glyphicon glyphicon-chevron-up" style="font-size: small;"></span>');
      });

      $('#fault_conf_details_workload').on('hide.bs.collapse', function () {
        $('#workload_configuration_content > div.modal-body > div:nth-child(2) > a').html('show details <span class="glyphicon glyphicon-chevron-down" style="font-size: small;"></span>');
      });
    }

    // if clicked node is a vm-workload node
    if ( workload_network_topology['nodes'][node_index]['group'] == 6 && workload_network_topology['nodes'][node_index]['attached'] == "true" ) {

      $('#workload_configuration').append(
        '<div id="workload_configuration_content" class="modal-dialog modal-content" style="top: 15px; width: 300px; background-color: aliceblue; border: 1px #555 solid; margin-top: 0px;">' +
          '<div class="modal-header">' +
            '<h5 class="modal-title" style="display: inline";>Workload configuration</h5>' +
            '<button id="workload_configuration_header_close" type="button" class="close">' +
              '<span aria-hidden="true">×</span>' +
            '</button>' +
          '</div>' +
          '<div class="modal-body">' +
            
            '<div class="row">' +
              '<div class="col-sm-6" style="text-align: center">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label">' +
                    '<span class="field-label">Network name:</span>' +
                  '</label>' +
                  '<text id="workload_configuration_NET" type="text">' + workload_network_topology['nodes'][node_index]['args']['net_name'] + '</text>' +
                '</div>' +
              '</div>' +
              '<div class="col-sm-6" style="text-align: center">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label" style="display: block;">' +
                    '<span class="field-label">Subnet name:</span>' +
                  '</label>' +
                  '<text id="workload_configuration_SUBNET" type="text">' + workload_network_topology['nodes'][node_index]['args']['subnet_name'] + '</text>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<hr>' +
            '<div class="row" style="text-align: center">' +
              '<div class="form-group" style="display: inline-block;">' +
                '<label class="control-label">' +
                  '<span class="field-label">Resource type:</span>' +
                '</label>' +
                '<br>' +
                '<text type="text">' + workload_network_topology['nodes'][node_index]['name'] + '</text>' +
              '</div>' +
            '</div>' +
            '<div id="workload_client_server_configuration">' +
            '</div>' +
          '</div>' +
          '<div class="modal-footer" style="margin-top: 0px;">'+
            '<button id="workload_configuration_remove" type="button" class="btn btn-danger">Remove</button>' +
            '<button id="workload_configuration_update" type="button" class="btn btn-primary">Update</button>' +
          '</div>' +
        '</div>'
      );

      // change form configuration for physical mode
      if ( $('#uRole').text() == " physical " ) {
        $('#workload_configuration_content > div.modal-body > div:nth-child(1)').html("");
        $('#workload_configuration_content > div.modal-body > div:nth-child(1)').append(
          '<div class="row" style="text-align: center">' +              
              '<div class="form-group" style="display: inline-block;">' +
                '<label class="control-label">' +
                  '<span class="field-label">Node name:</span>' +
                '</label>' +
                '<br>' +
                '<text id="workload_configuration_IP" type="text">' + workload_network_topology['nodes'][node_index]['args']['node_ip'] + '</text>' +
              '</div>' +
            '</div>' 
          );
      }

      if ( workload_network_topology['nodes'][node_index]['name'] == "iperf client") {
        $('#workload_client_server_configuration').append(
          '<hr>' +
          '<div class="row" style="text-align: center;">' +
            '<div class="form-group" style="display: inline-block;">' +
              '<label class="control-label" for="bandwidthIperf">' +
                '<span class="field-label">Bandwidth (Mbit/sec):</span>' +
              '</label>' +
              '<input id="workload_bandwidthIperf" class="form-control form-lg" type="text" value="'+ workload_network_topology['nodes'][node_index]['args']['bandwidth'] +'" placeholder="Insert bandwidth" size="5">' + 
            '</div>' +
            '<div class="form-group" style="display: inline-block;margin-left:10px;">' +
              '<label class="control-label" for="protocolIperf">' +
                '<span class="field-label">Protocol:</span>' +
              '</label>' +
              '<div id="workload_protocolIperf_dropdown" class="dropdown">' +
                '<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">' +
                    '<span id="workload_protocolIperfLabel" class="dropdown-title">' +
                    workload_network_topology['nodes'][node_index]['args']['protocol'] + ' </span>'+
                    '<span class="fa fa-caret-down"></span>' +
                '</button>' +
                '<ul id="workload_protocolIperf_dropdown_menu" class="dropdown-menu">' +
                  '<li data-original-index="1" data-toggle="tooltip" data-placement="top">' +
                    '<a data-select-value="udp">udp </a>' +
                  '</li>' +
                  '<li data-original-index="2" data-toggle="tooltip" data-placement="top">' +
                    '<a data-select-value="tcp">tcp </a>' +
                  '</li>' +
                '</ul>' +
              '</div>' +
            '</div>' +
            '<div id="workload_configuration_alertArgs">' +
            '</div>' +
          '</div>'
        );

        $('#workload_protocolIperf_dropdown_menu li a').click( function () {
          $('#workload_protocolIperfLabel').text($(this).text());
        });

      } 
      else if ( workload_network_topology['nodes'][node_index]['name'] == "iperf server" ) {
        $('#workload_client_server_configuration').append(
          '<hr>' +
          '<div class="row" style="text-align: center;">' +
            '<div class="form-group" style="display: inline-block;">'+
              '<label class="control-label  " for="bandwidthIperf">'+
                '<span class="field-label">Server port:</span>'+
              '</label>'+
              '<input id="workload_serverPortIperf" class="form-control form-lg" type="text" value="' + workload_network_topology['nodes'][node_index]['args']['server_port'] + '" placeholder="Insert server port">'+ 
            '</div>'+
            '<div id="workload_configuration_alertArgs">' +
            '</div>' +
          '</div>'
        );
      }
      else if ( workload_network_topology['nodes'][node_index]['name'] == "jmeter client" ) {
        $('#workload_client_server_configuration').append(
          '<hr>' +
            '<div class="row" style="text-align: center;">' +
              '<div class ="col-sm-6">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label" for="serverIPJMeter">' +
                    '<span class="field-label">Server IP :</span>' +
                  '</label>' +
                  '<input id="workload_serverIPJMeter" class="form-control form-lg" type="text" placeholder="Insert IP" size="17" value="' + workload_network_topology['nodes'][node_index]['args']['server_ip'] + '">' + 
                '</div>' +
              '</div>' +
              '<div class="col-sm-6">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label" for="serverPORTJMeter">' +
                    '<span class="field-label">Server port :</span>' +
                  '</label>' +
                  '<input id="workload_serverPORTJMeter" class="form-control form-lg" type="text" placeholder="Insert port" size="17" value="' + workload_network_topology['nodes'][node_index]['args']['server_port'] + '">' + 
                '</div>' +
              '</div>' +
            '</div>' +

            '<hr>' +
            '<div class="row" style="text-align: center;">' +
              '<div class ="col-sm-6">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label" for="requestMethodJMeter">' +
                    '<span class="field-label">Method :</span>' +
                  '</label>' +
                  '<input id="workload_requestMethodJMeter" class="form-control form-lg" type="text" placeholder="Insert method" size="15" value="' + workload_network_topology['nodes'][node_index]['args']['requestMethod'] + '">' + 
                '</div>' +
              '</div>' +
              '<div class="col-sm-6">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label" for="requestPageJMeter">' +
                    '<span class="field-label">request path :</span>' +
                  '</label>' +
                  '<input id="workload_requestPageJMeter" class="form-control form-lg" type="text" placeholder="Insert path" size="15" value="' + workload_network_topology['nodes'][node_index]['args']['requestPage'] + '">' + 
                '</div>' +
              '</div>' +
            '</div>' +

            '<hr>' +
            '<div class="row" style="text-align: center;">' +
              '<div class="form-group" style="display: inline-block;">' +
                '<label class="control-label" for="requestThroughputJMeter">' +
                  '<span class="field-label">Throughput (req/min) :</span>' +
                '</label>' +
                '<input id="workload_requestThroughputJMeter" class="form-control form-lg" type="text" placeholder="Insert throughput" size="15" value="' + workload_network_topology['nodes'][node_index]['args']['requestThroughput'] + '">' + 
              '</div>' +
            '</div>' +

            '<div class="row" style="text-align: center;">' +
              '<div class ="col-sm-6">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label" for="connect_timeoutJMeter">' +
                    '<span class="field-label">Connect timeout (ms) :</span>' +
                  '</label>' +
                  '<input id="workload_connect_timeoutJMeter" class="form-control form-lg" type="text" placeholder="Insert timeout" size="15" value="' + workload_network_topology['nodes'][node_index]['args']['connect_timeout'] + '">' + 
                '</div>' +
              '</div>' +
              '<div class="col-sm-6">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label" for="response_timeoutJMeter">' +
                    '<span class="field-label">Response timeout :</span>' +
                  '</label>' +
                  '<input id="workload_response_timeoutJMeter" class="form-control form-lg" type="text" placeholder="Insert timeout" size="15" value="' + workload_network_topology['nodes'][node_index]['args']['response_timeout'] + '">' + 
                '</div>' +
              '</div>' +
            '</div>' +
            '<div id="workload_configuration_alertArgs">' +
            '</div>' 
          );
      }

      $('#workload_configuration_update').click( function () {
        // reset alert div
        $('#workload_configuration_alertArgs').html("");
        var re = /^()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$/i;

        if ( workload_network_topology['nodes'][node_index]['name'] == "iperf client" ) {
          //checks on iperf bandwidth

          if ( isNaN( $('#workload_bandwidthIperf').val()) ) {
            $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a number for bandwidth. </div> ');
            return false;
          }
          
          if ( $('#workload_bandwidthIperf').val() < 0 ) {
            $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a positive value for bandwidth. </div> ');
            return false;
          }
          
          if ( !$('#workload_bandwidthIperf').val() ) {
            $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert bandwidth. </div> ');
            return false;
          }

          workload_network_topology['nodes'][node_index]['args']['bandwidth'] = $('#workload_bandwidthIperf').val();
          workload_network_topology['nodes'][node_index]['args']['protocol'] =  $('#workload_protocolIperfLabel').text().slice(0,-1);    

        }
        else if ( workload_network_topology['nodes'][node_index]['name'] == "iperf server" ) {
          //checks on server port
          if ( !$('#workload_serverPortIperf').val() ) {
            $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert server port. </div> ');
            return false;
          }

          if ( !re.test($('#workload_serverPortIperf').val()) || $('#workload_serverPortIperf').val() == 0 ) {
            $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a valid server port. </div> ');
            return false;
          }

          workload_network_topology['nodes'][node_index]['args']['server_port'] = $('#workload_serverPortIperf').val();  
      
        }
        else if ( workload_network_topology['nodes'][node_index]['name'] == "jmeter client" ) {

          //check on server IP
          if ( !$('#workload_serverIPJMeter').val() ) {
            $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert server IP. </div> ');
            return false;
          }
          //check on server port
          if ( !$('#workload_serverPORTJMeter').val() ) {
            $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert server port. </div> ');
            return false;
          }

          //var re = /^()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$/i;
          if ( !re.test($('#workload_serverPORTJMeter').val()) || $('#workload_serverPORTJMeter').val() == 0 ) {
            $('#workload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a valid server port. </div> ');
            return false;
          }

          //check on method
          if ( !$('#workload_requestMethodJMeter').val() ) {
            $('#workload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert method. </div> ');
            return false;
          }

          var arrayJMETERMethod = ["GET", "POST", "HEAD", "TRACE", "OPTIONS", "PUT", "DELETE", "PATCH", "COPY", "LOCK", "MKCOL", "MOVE", "PROPFIND", "PROPPATCH", "UNLOCK", "REPORT", "MKCALENDAR", "SEARCH"];
          if ( !arrayJMETERMethod.includes($('#workload_requestMethodJMeter').val().toUpperCase()) ) {
            $('#workload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a valid method. </div> ');
            return false;
          }

          //check on request path
          if ( !($('#workload_requestPageJMeter').val()) ) {
            $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert request path . </div> ');
            return false;
          }

          //check on throughput
          if ( !$('#workload_requestThroughputJMeter').val() ) {
           $('#workload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert throughput. </div> ');
            return false; 
          }

          if ( isNaN($('#workload_requestThroughputJMeter').val()) ) {
            $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a number for throughput. </div> ');
            return false;
          }

          if ( $('#workload_requestThroughputJMeter').val() <= 0 ) {
           $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a positive value for throughput. </div> ');
            return false; 
          }

          //check on connect_timeout
          if ( isNaN($('#workload_connect_timeoutJMeter').val()) ) {
           $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a number for connection timeout. </div> ');
            return false; 
          }

          if ( $('#workload_connect_timeoutJMeter').val() < 0 ) {
           $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a positive value for connection timeout. </div> ');
            return false;  
          }

          //check on resp_timeout
          if ( isNaN($('#workload_response_timeoutJMeter').val()) ) {
            $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a number for response timeout. </div> ');
            return false; 
          }

          if ( $('#workload_response_timeoutJMeter').val() < 0 ) {
           $('#workload_configuration_alertArgs').append('<div id="workload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a positive value for response timeout. </div> ');
            return false;  
          }

          workload_network_topology['nodes'][node_index]['args']['server_ip'] = $('#workload_serverIPJMeter').val();
          workload_network_topology['nodes'][node_index]['args']['server_port'] = $('#workload_serverPORTJMeter').val();
          workload_network_topology['nodes'][node_index]['args']['requestMethod'] = $('#workload_requestMethodJMeter').val().toUpperCase();
          workload_network_topology['nodes'][node_index]['args']['requestPage'] = $('#workload_requestPageJMeter').val();
          workload_network_topology['nodes'][node_index]['args']['requestThroughput'] = $('#workload_requestThroughputJMeter').val();
          workload_network_topology['nodes'][node_index]['args']['connect_timeout'] = $('#workload_connect_timeoutJMeter').val();
          workload_network_topology['nodes'][node_index]['args']['response_timeout'] = $('#workload_response_timeoutJMeter').val();
        }
        
        $('#workload_configuration').html("");
        d3recolor();
      });
    
      $('#workload_configuration_header_close').click( function () {
        $('#workload_configuration').html("");
        d3recolor();
      });

      $('#workload_configuration_remove').click ( function () {
        //remove vm-workload node
        if ( workload_network_topology['nodes'][node_index]['name'] == 'iperf client' ) {
          tmp_workload_network_topology_iperf_client_node['attached'] = "false";
          tmp_workload_network_topology_iperf_client_link = {}

        }
        else if ( workload_network_topology['nodes'][node_index]['name'] == 'iperf server' ) {
          tmp_workload_network_topology_iperf_server_node['attached'] = "false";
          tmp_workload_network_topology_iperf_server_link = {}
          
        }
        else if ( workload_network_topology['nodes'][node_index]['name'] == 'jmeter client' ) {
          tmp_workload_network_topology_jmeter_client_node['attached'] = "false";
          tmp_workload_network_topology_jmeter_client_link = {}
          
        }

        workload_network_topology['nodes'][node_index]['attached'] = "false";

        //remove correspondent link
        for ( var i = 0; i < workload_network_topology['links']['length']; i++ ) {
          if ( workload_network_topology['links'][i]['target']['index'] == node_index ) {
            workload_network_topology['links'].splice(i, 1);
            break;
          }
        }

        //reset predefinite_information
        for ( var i = 0; i < predefinite_workload_generators['nodes']['length']; i ++ ) {
          if ( workload_network_topology['nodes'][node_index]['name'] == predefinite_workload_generators['nodes'][i]['name'] ) {

            if ( workload_network_topology['nodes'][node_index]['name'] == "iperf client") {
              workload_network_topology['nodes'][node_index]['args']['bandwidth'] = predefinite_workload_generators['nodes'][i]['args']['bandwidth'];
              workload_network_topology['nodes'][node_index]['args']['protocol'] = predefinite_workload_generators['nodes'][i]['args']['protocol'];
            }

            else if ( workload_network_topology['nodes'][node_index]['name'] == "iperf server") {
              workload_network_topology['nodes'][node_index]['args']['server_port'] = predefinite_workload_generators['nodes'][i]['args']['server_port'];
            }

            else if ( workload_network_topology['nodes'][node_index]['name'] == "jmeter client") {
              workload_network_topology['nodes'][node_index]['args']['server_ip'] = predefinite_workload_generators['nodes'][i]['args']['server_ip'];
              workload_network_topology['nodes'][node_index]['args']['server_port'] = predefinite_workload_generators['nodes'][i]['args']['server_port'];
              workload_network_topology['nodes'][node_index]['args']['requestMethod'] = predefinite_workload_generators['nodes'][i]['args']['requestMethod'];
              workload_network_topology['nodes'][node_index]['args']['requestPage'] = predefinite_workload_generators['nodes'][i]['args']['requestPage'];
              workload_network_topology['nodes'][node_index]['args']['requestThroughput'] = predefinite_workload_generators['nodes'][i]['args']['requestThroughput'];
              workload_network_topology['nodes'][node_index]['args']['connect_timeout'] = predefinite_workload_generators['nodes'][i]['args']['connect_timeout'];
              workload_network_topology['nodes'][node_index]['args']['response_timeout'] = predefinite_workload_generators['nodes'][i]['args']['response_timeout'];
            }
          }
        }
        $.d3render_workload();
        d3recolor();
        $('#workload_configuration').html("");
      });

    }
  }
    
});


/****** START - JS workload generator ******/





/****** START - JS for iPerfAnalytics - ******/

var view_changed;
var all_test_analytics_iperf = [];
var all_test_analytics_iperf_UDP = [];
var all_test_analytics_iperf_TCP = [];

$('#all_test_analytics').change( function () {

  $.ajax({
    method: "POST",
    url: "{{  url_for('netcast.getWorkloadType') }}",
    data: { campaign_name : $('#campaignName').text() },
    success: function (response) {
      resp = JSON.parse(response);
      if ( resp['workload_type'] == 'iperf' ) {
        function_iperf_graph();
      } else {
        function_jmeter_graph();
      }
    },
    statusCode: {
      500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      404: function (response) { 
        alert('File *workload_type.json* not found. Please check NetCAST master agent logs.');
        $('#exp-list_analytics').html('');
        $('#analytics_details').html('');
        $('#analytics_test_checkbox').html('');
      },
      0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
    }
  });
  
  function function_jmeter_graph() {
    
    $a = $('#exp-list_analytics label input');
    var array_testID = [];
    $a.each( function () { array_testID.push($(this).attr('id')); });
    
    if (view_changed != "all") {
      view_changed = "all";
      last_pressed_button = "all_test_analytics";
      $('#analytics_details').html('');
      $('#analytics_test_checkbox').html('');
    
      //All test jmeter mode
      $('#analytics_details').append(
        '<!-- Up row -->' +
        '<div class="row">' +
          '<!-- All Test Throughput (#req/sec) Graph -->' +
            '<div id="containerTestParametersGraph_throughput_req_sec_all" style="height: 300px;">' +
            '</div>' +
          '<!-- end All Test Throughput (#req/sec) Graph -->' +
        '</div>' +
        '<!-- Up row -->' +
        '<div class="row">' +
          '<!-- All Test Error Rate Graph -->' +
            '<div id="containerTestParametersGraph_error_rate_all" style="height: 300px;">' +
            '</div>' +
          '<!-- end All Test Error Rate Graph -->' +
        '</div>' +
        '<!-- Up row -->' +
        '<div class="row">' +
          '<!-- All Test Throughput (#Bytes/sec) Graph -->' +
            '<div id="containerTestParametersGraph_throughput_bytes_sec_all" style="height: 300px;">' +
            '</div>' +
          '<!-- end All Test Throughput (#Bytes/sec) Graph -->' +
        '</div>' +
        '<!-- Up row -->' +
        '<div class="row">' +
          '<!-- All Test Elapsed Time Graph -->' +
            '<div id="containerTestParametersGraph_elapsed_time_all" style="height: 300px;">' +
            '</div>' +
          '<!-- end All Test Elapsed Time Graph -->' +
        '</div>' +
        '<!-- Up row -->' +
        '<div class="row">' +
          '<!-- All Test Connection Time Out Graph -->' +
            '<div id="containerTestParametersGraph_conn_timeout_all" style="height: 300px;">' +
            '</div>' +
          '<!-- end All Test Connection Time Out Graph -->' +
        '</div>' +
        '<!-- Up row -->' +
        '<div class="row">' +
          '<!-- All Test Response Time Out Graph -->' +
            '<div id="containerTestParametersGraph_resp_timeout_all" style="height: 300px;">' +
            '</div>' +
          '<!-- end All Test Response Time Out Graph -->' +
        '</div>' 
      );
    }

    $.ajax({
      method: "POST",
      url: "{{ url_for('netcast.getJmeterAllTest_average') }}",
      data: { tests: JSON.stringify(array_testID), campaign_name : $('#campaignName').text() },
      success: function (response) {
        jmeter_all_test_average = JSON.parse(response);
        console.log(jmeter_all_test_average);

        //list of jmeter test
        jmeter_all_test = jmeter_all_test_average['tests'];
        
        //list of average throughput_req_sec tests
        jmeter_all_test_throughput_req_sec = jmeter_all_test_average['throughput_req_sec']
        //average pre-injection throughput_req_sec tests
        jmeter_all_test_throughput_req_sec_pre = jmeter_all_test_average['throughput_req_sec_pre']

        //list of average error_rate tests
        jmeter_all_test_error_rate = jmeter_all_test_average['error_rate']
        //average pre-injection error_rate tests
        jmeter_all_test_error_rate_pre = jmeter_all_test_average['error_rate_pre']

        //list of average throughput_bytes_sec tests
        jmeter_all_test_throughput_bytes_sec = jmeter_all_test_average['throughput_bytes_sec']
        //average pre-injection throughput_bytes_sec tests
        jmeter_all_test_throughput_bytes_sec_pre = jmeter_all_test_average['throughput_bytes_sec_pre']

        //list of average elapsed_time tests
        jmeter_all_test_elapsed_time = jmeter_all_test_average['elapsed_time']
        //average pre-injection elapsed_time tests
        jmeter_all_test_elapsed_time_pre = jmeter_all_test_average['elapsed_time_pre']

        jmeter_all_test_conn_timeout = jmeter_all_test_average['conn_timeout']
        jmeter_all_test_conn_timeout_pre = jmeter_all_test_average['conn_timeout_pre']

        jmeter_all_test_resp_timeout = jmeter_all_test_average['resp_timeout']
        jmeter_all_test_resp_timeout_pre = jmeter_all_test_average['resp_timeout_pre']

        draw_jmeter_graph_average_all(1, jmeter_all_test, jmeter_all_test_throughput_req_sec, jmeter_all_test_throughput_req_sec_pre);

        draw_jmeter_graph_average_all(2, jmeter_all_test, jmeter_all_test_error_rate, jmeter_all_test_error_rate_pre);

        draw_jmeter_graph_average_all(3, jmeter_all_test, jmeter_all_test_throughput_bytes_sec, jmeter_all_test_throughput_bytes_sec_pre);

        draw_jmeter_graph_average_all(4, jmeter_all_test, jmeter_all_test_elapsed_time, jmeter_all_test_elapsed_time_pre);

        draw_jmeter_graph_average_all(5, jmeter_all_test, jmeter_all_test_conn_timeout, jmeter_all_test_conn_timeout_pre);

        draw_jmeter_graph_average_all(6, jmeter_all_test, jmeter_all_test_resp_timeout, jmeter_all_test_resp_timeout_pre);

      },
      statusCode: {
        500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        501: function (response) { 
          alert('An error occurred while calculating jmeter all_test statistics.'); 
          $('#analytics_details').html('');
          $('#analytics_test_checkbox').html('');
          view_changed = "all";
          last_pressed_button = null;
        },
        400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        404: function (response) { alert('File *injection_setup.json* or some *summary.csv* not found. Please check NetCAST master agent logs.'); },
        0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
      }
    });
  }

  function function_iperf_graph() {  
    iperf_last_test_protocol_client = null;
    iperf_last_test_protocol_server = null;

    $a = $('#exp-list_analytics label input');
    
    if (!$a.length) {
      return;
    }

    var first_testID_tmp = $a.first().attr('id');
    var first_testID = first_testID_tmp.replace('test_', '');


    var array_testID = [];
    $a.each( function () { array_testID.push($(this).attr('id')); });

    $.ajax({
      method: "POST",
      url: "{{ url_for('netcast.getIperfLog') }}",
      data: { test: first_testID, log_type: "client" , campaign_name : $('#campaignName').text() },
      success: function (response) {
        iperf_client_log = JSON.parse(response);

        try {
          iperf_client_test_protocol = iperf_client_log['start']['test_start']['protocol'];
        }
        catch(err) {
          alert('Test_' + first_testID + '/iperf_client.log is not valid.');
          $('#analytics_details').html('');
          $('#analytics_test_checkbox').html('');
          iperf_last_test_protocol_client = null;
          view_changed = "all";
          last_pressed_button = null;
          return;
        }

        if (iperf_client_test_protocol == "UDP") {
          if (view_changed != "all"){
            view_changed = "all";
            last_pressed_button = "all_test_analytics";
            $('#analytics_details').html('');
            $('#analytics_test_checkbox').html('');
          
            // All test udp mode
            $('#analytics_details').append(
              '<!-- Up row -->' +
              '<div class="row">' +
                '<!-- All Test Bandwidth Graph UDP -->' +
                  '<div id="containerTestParametersGraph_bandwidth_server_udp_all" style="height: 300px;">' +
                  '</div>' +
                '<!-- end All Test Bandwidth Graph UDP -->' +
              '</div>' +
              '<!-- Up row -->' +
              '<div class="row">' +
                '<!-- All Test Sent/Lost Graph UDP -->' +
                  '<div id="containerTestParametersGraph_sent_lost_server_udp_all" style="height: 300px;">' +
                  '</div>' +
                '<!-- end All Test Sent/Lost Graph UDP -->' +
              '</div>'
            );
          }

          $.ajax({
            method: "POST",
            url: "{{ url_for('netcast.getIperfAllTest_UDP_average') }}",
            data: { tests: JSON.stringify(array_testID), campaignName : $('#campaignName').text() },
            success: function (response) {
              iperf_all_test_udp_average = JSON.parse(response);
              
              //list of UDP test
              iperf_all_test_udp_test_server = iperf_all_test_udp_average['tests_server'];
              //list of average bandwidth server UDP tests
              iperf_all_test_udp_bandwidth_server = iperf_all_test_udp_average['bandwidth_server'];
              //average pre-injection bandwidth UDP tests
              iperf_all_test_udp_bandwidth_pre_server = iperf_all_test_udp_average['pre_bandwidth_server'];
              //list of average sent_lost packets server UDP tests
              iperf_all_test_udp_sent_lost_server = iperf_all_test_udp_average['sent_lost_server'];
              //average pre-injection sent_lost packets server UDP tests
              iperf_all_test_udp_sent_lost_pre_server = iperf_all_test_udp_average['pre_sent_lost_server'];

              //console.log(iperf_all_test_udp_average);

              draw_iperf_graph_average_all("UDP", 2, 2, iperf_all_test_udp_test_server,iperf_all_test_udp_bandwidth_server, iperf_all_test_udp_bandwidth_pre_server);

              draw_iperf_graph_average_all("UDP", 2, 5, iperf_all_test_udp_test_server,iperf_all_test_udp_sent_lost_server, iperf_all_test_udp_sent_lost_pre_server);

            },
            statusCode: {
              500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
              501: function (response) { alert('An error occurred while calculating iperf all_test UDP statistics.'); },
              400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
              404: function (response) { alert('File *injection_setup.json* or some *iperf_server.log* not found. Please check NetCAST master agent logs.'); },
              0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
            }
          }); 
        }

        else {

          if (view_changed != "all") {
            view_changed = "all";
            last_pressed_button = "all_test_analytics";
            $('#analytics_details').html('');
            $('#analytics_test_checkbox').html('');
            //All test tcp mode
            $('#analytics_details').append(
              '<!-- Up row -->' +
              '<div class="row">' +
                '<!-- All Test Client Bandwidth Graph TCP -->' +
                  '<div id="containerTestParametersGraph_bandwidth_client_tcp_all" style="height: 300px;">' +
                  '</div>' +
                '<!-- end All Test Client Bandwidth Graph TCP -->' +
              '</div>' +
              '<!-- Up row -->' +
              '<div class="row">' +
                '<!-- All Test Client RTT Graph TCP -->' +
                  '<div id="containerTestParametersGraph_rtt_client_tcp_all" style="height: 300px;">' +
                  '</div>' +
                '<!-- end All Test Client RTT Graph TCP -->' +
              '</div>' +
              '<!-- Up row -->' +
              '<div class="row">' +
                '<!-- All Test Server Bandwidth Graph TCP -->' +
                  '<div id="containerTestParametersGraph_bandwidth_server_tcp_all" style="height: 300px;">' +
                  '</div>' +
                '<!-- end All Test Server Bandwidth Graph TCP -->' +
              '</div>'
            );
          }

          $.ajax({
            method: "POST",
            url: "{{ url_for('netcast.getIperfAllTest_TCP_average') }}",
            data: { tests: JSON.stringify(array_testID), campaign_name : $('#campaignName').text()},
            success: function (response) {
              iperf_all_test_tcp_average = JSON.parse(response);
              
              //list of TCP test
              iperf_all_test_tcp_test_client = iperf_all_test_tcp_average['tests_client'];
              //list of average bandwidth server TCP tests
              iperf_all_test_tcp_bandwidth_client = iperf_all_test_tcp_average['bandwidth_client'];
              //average pre-injection bandwidth TCP tests
              iperf_all_test_tcp_bandwidth_pre_client = iperf_all_test_tcp_average['pre_bandwidth_client'];
              //list of average rtt server TCP tests
              iperf_all_test_tcp_rtt_client = iperf_all_test_tcp_average['rtt_client'];
              //average pre-injection rtt server TCP tests
              iperf_all_test_tcp_rtt_pre_client = iperf_all_test_tcp_average['pre_rtt_client'];

              //list of average bandwidth server TCP tests
              iperf_all_test_tcp_bandwidth_server = iperf_all_test_tcp_average['bandwidth_server'];
              //average pre-injection bandwidth TCP tests
              iperf_all_test_tcp_bandwidth_pre_server = iperf_all_test_tcp_average['pre_bandwidth_server'];

              //console.log(iperf_all_test_tcp_average);

              draw_iperf_graph_average_all("TCP", 1, 2, iperf_all_test_tcp_test_client,iperf_all_test_tcp_bandwidth_client, iperf_all_test_tcp_bandwidth_pre_client);

              draw_iperf_graph_average_all("TCP", 1, 8, iperf_all_test_tcp_test_client,iperf_all_test_tcp_rtt_client, iperf_all_test_tcp_rtt_pre_client);

              draw_iperf_graph_average_all("TCP", 2, 2, iperf_all_test_tcp_test_client,iperf_all_test_tcp_bandwidth_server, iperf_all_test_tcp_bandwidth_pre_server);

            },
            statusCode: {
              500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
              501: function (response) { alert('An error occurred while calculating iperf all_test TCP statistics.'); },
              400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
              404: function (response) { alert('File *injection_setup.json* or some *iperf_client.log* or some *iperf_server.log* not found. Please check NetCAST master agent logs.'); },
              0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
            }
          });
        }
      },

      statusCode: {
        500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        404: function (response) { 
          alert('Test_' + first_testID + '/iperf_client.log not found. Please check NetCAST master agent logs.');
          $('#analytics_details').html('');
          $('#analytics_test_checkbox').html('');
          iperf_last_test_protocol_client = null;
          view_changed = "all";
          last_pressed_button = null;
          },
        0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
      }
    });
  }
});


/***** START - IPERF GRAPH variable *****/
  var testParametersGraph_transferChart_client;
  var testParametersGraph_bandwidthChart_client;

  //only TCP protocol
    var testParametersGraph_snd_cwndChart_client;
    var testParametersGraph_retransmitsChart_client;
    var testParametersGraph_rttChart_client;

  var testParametersGraph_transferChart_server;
  var testParametersGraph_bandwidthChart_server;

  //only UDP protocol
    var testParametersGraph_jitterChart_server;
    var testParametersGraph_lost_percentageChart_server;
    var testParametersGraph_sent_lostChart_server

  var testAverageBarGraph_bandwidthChart_server;
  var testAverageBarGraph_lostChart_server;

  var testAverageBarGraph_bandwidthChart_server_all_udp;
  var testAverageBarGraph_sent_lostChart_server_all_udp;

  var testAverageBarGraph_bandwidthChart_client_all_tcp;
  var testAverageBarGraph_rttChart_client_all_tcp;
  var testAverageBarGraph_bandwidthChart_server_all_tcp;

  var getTestAnalyticsID;
  var testAnalyticsID;
  var getTestAnalyticsSTOP;

/***** END - IPERF GRAPH variable *****/

/***** START - JMETER GRAPH variable *****/

  var testAverageBarGraph_throughput_req_secChart_all;
  var testAverageBarGraph_error_rateChart_all;
  var testAverageBarGraph_throughput_bytes_secChart_all;
  var testAverageBarGraph_elapsed_timeChart_all;
  var testAverageBarGraph_conn_timeoutChart_all;
  var testAverageBarGraph_resp_timeoutChart_all;
  
  var testParametersGraph_throughput_req_secChart_;
  var testParametersGraph_error_rateChart_;
  var testParametersGraph_throughput_bytes_secChart_;
  var testParametersGraph_elapsed_timeChart_;
  var testParametersGraph_conn_timeoutChart_;
  var testParametersGraph_resp_timeoutChart_;


/***** END - JMETER GRAPH variable *****/


  function getTestAnalytics () {
    clearInterval(getTestAnalyticsID);
    $.ajax({
      method: "POST",
      url: "{{ url_for('netcast.getStatusTestCases') }}",
      data: { campaign_name : $('#campaignName').text() },
      success: function (response) {
        var completed_array = [];
        $('#exp-list_analytics').html('');
        $.each(JSON.parse(response), function (j, obj) {
          var test = obj[0];
          //console.log(test);

          if (test[1] === 'completed') {
            $('#exp-list_analytics').append(
              '<label class="btn btn-default">' +
                '<input type="radio" name="options" id="test_' + test[0] +'" autocomplete="off" style="display:none;">Test: '+ test[0] + 
              '</label>'
              );
            completed_array.push("test_"+test[0]);

            getTestAnalyticsSTOP = true;
          } 
          else if (test[1] === 'error') {getTestAnalyticsSTOP = true;}
          else { getTestAnalyticsSTOP = false;}
        });

        if (completed_array.length > 0 ) {
          if ( completed_array.length != all_test_analytics_iperf.length) {

            //a new test is completed => update all_test_analytics_iperf and all_average_graph
            all_test_analytics_iperf = [];
            for (var i = 0; i < completed_array.length; i++) {
              all_test_analytics_iperf.push(completed_array[i]);
            }
            if (view_changed == null || view_changed == "all") {
              $('#all_test_analytics').parent().removeClass('active');
              $('#all_test_analytics').parent().click();
              last_pressed_button = "all_test_analytics";
            }
          }
          $('#' + last_pressed_button).parent().click();
        }

        if (getTestAnalyticsSTOP || changeNetConfig) {
          //reset periodic task 
          clearInterval(getTestAnalyticsID);
        }
        else {
          //set periodic task 
          getTestAnalyticsID = setInterval(getTestAnalytics, 1000);
        }
      },
      statusCode: {
        500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        501: function (response) { 
                                    $.confirm({
                                                title: '<b>WARNING</b>',
                                                content: 'No test has completed yet! Please wait for completion of at least 1 test.',
                                                type: 'orange',
                                                typeAnimated: true,
                                                buttons: {
                                                    ok: function() { return; }
                                                }
                                    });
                                 },
        400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
      }
    });
  }

var top_col_2_analytics;
var prev_scoll_analytics;

var scrollHandler = function() {
    var scrollTop = $(window).scrollTop();
    //console.log(scrollTop);
    var height_col_2_analytics = $('#tabAnalytics > div > div.col-sm-2').height();
    var window_size = $(window).height();
    if (top_col_2_analytics + height_col_2_analytics < $(window).height()) {
      if (scrollTop < top_col_2_analytics) {
        $("#tabAnalytics > div > div.col-sm-2").css({"margin-top": "0px"});  
      }  
      else {
        $("#tabAnalytics > div > div.col-sm-2").css({"margin-top": (scrollTop - top_col_2_analytics) + "px"}); 
      } 
    }
    else {
      if (prev_scoll_analytics <= scrollTop) {
        //console.log("DIFF %s", $(document).scrollTop() - (top_col_2_analytics + height_col_2_analytics))
        $("#tabAnalytics > div > div.col-sm-2").css({"margin-top": Math.max(scrollTop - (height_col_2_analytics - window_size + top_col_2_analytics),0) + "px"});
      }
      else {
        if (scrollTop  <= $(document).height() - height_col_2_analytics) {
          $("#tabAnalytics > div > div.col-sm-2").css({"margin-top": Math.max(scrollTop - top_col_2_analytics, 0) + "px"});
        }
      }
      prev_scoll_analytics = scrollTop;
    }  
    
}

var last_pressed_button;
//var analyticsBtnClick = false;
$('#analyticsBtn > a').on('shown.bs.tab', function(event) {

  /**** exp-list_analytics ****/
  //this periodic task get completed tests and append these on exp-list_analytics
  getTestAnalytics();
  top_col_2_analytics = $('#tabAnalytics > div > div.col-sm-2').offset().top;
  //console.log(top_col_2_analytics);
  $(window).off("scroll",scrollHandler);
  $(window).scroll(scrollHandler);
});

$('#executeBtn > a').on('shown.bs.tab', function(event) {
  clearInterval(getTestAnalyticsID);
});


var iperf_graph_color = {
  1: "green",
  2: "red",
  3: "navy",
  4: "orange",
  5: ["green", "red"],
  6: "navy",
  7: "brown",
  8: "orange"
}

var iperf_graph_parameter = {
  1: "transfer",
  2: "bandwidth",
  3: "jitter",
  4: "lost_percentage",
  5: "sent_lost",
  6: "snd_cwnd",
  7: "retransmits",
  8: "rtt"
}

var iperf_graph_parameter_label = {
  1: "Transfer",
  2: "Bandwidth",
  3: "Jitter",
  4: "Lost",
  5: ["Sent","Lost"],
  6: "Send CWND",
  7: "Retransmits",
  8: "RTT"
}

var iperf_graph_unit = {
  1: "KBytes",
  2: "KBits/sec",
  3: "ms",
  4: "%",
  5: "number",
  6: "KBytes",
  7: "number",
  8: "sec"
}

var iperf_client_server_label = {
  1: "Client",
  2: "Server"
}


var iperf_average_xAxis = ['Pre-inection', 'During-injection', 'Post-injection'];

var iperf_average_parameter_label = {
  1: "Average bandwidth",
  2: "Average traffic lost"
}

var iperf_average_unit = {
  1: "KBits/sec",
  2: "%"
}

var iperf_average_color = {
  1: "navy",
  2: "red"
}

var iperf_average_parameter = {
  1: "bandwidth",
  2: "lost"
}

var graph_pre_injection_time, graph_injection_time, graph_post_injection_time;
var graph_test_fault_type, graph_test_target_resource;
var graph_workload_type;

var iperf_last_test_protocol_client; 
var iperf_last_test_protocol_server;


  /**** testParametersGraph_transferChart *****/
 $(document).on('change', '#exp-list_analytics label input', function () {
  //on test button click:
    // - update graph column with current test data
    // - send ajax request to get data from client and/or server iperf log (this attr is read from checkbox i.e. iperf-client, iperf-server)
    // - draw graphs for selected graph (this attr is read from checkbox i.e. iperf-client_transfer, iperf-client-bandwidth, iperf-server_jitter, ...)
    // set global testAnalyticsID with exp-number. This var is used on click "#showTestDetails" button. On click, send ajax request to "/getInfoTest" API.

    //console.log($(this).attr("id"));

  exp_id = $(this).attr("id");
  var exp_number = exp_id.replace('test_', '');


  if ( last_pressed_button != exp_id ) {

    last_pressed_button = exp_id;
    testAnalyticsID = exp_number;

    if (view_changed != "test") {
      $.ajax({
        method: "POST",
        url: "{{  url_for('netcast.getWorkloadType') }}",
        data: { campaign_name : $('#campaignName').text() },
        beforeSend: function() {
          graph_pre_injection_time = pre_injection_time;
          graph_injection_time = injection_time;
          graph_post_injection_time = post_injection_time;

          console.log("graph_pre_injection_time: %s", graph_pre_injection_time)
          console.log("graph_injection_time: %s", graph_injection_time)
          console.log("graph_post_injection_time: %s", graph_post_injection_time)
        },
        success: function (response) {
          resp = JSON.parse(response);
          graph_workload_type = resp['workload_type'];
          if ( graph_workload_type == 'iperf' ) {
            function_iperf_graph_test();
          } 
          else if ( graph_workload_type == 'jmeter' ) {
            function_jmeter_graph_test();
          }
        },
        statusCode: {
          500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          404: function (response) { alert("File *workload_type.json* not found. Please check NetCAST master agent logs."); },
          0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
        }
      });
    }
    else {
      if ( graph_workload_type == 'iperf' ) {
        function_iperf_graph_test();
      } 
      else if ( graph_workload_type == 'jmeter' ) {
        function_jmeter_graph_test();
      } 
    }


    function getInfoTest() {
      $.ajax({
        method: "POST",
        url: "{{ url_for('netcast.getInfoTest') }}",
        data: { id_test: testAnalyticsID, campaign_name : $('#campaignName').text() },
        success: function (response) {
          details = JSON.parse(response).split('#');

          var unit = "";
          if ( details[5] == "latency") {
            unit = "ms";
          }
          //else if (details[5] == "loss" || details[5] == "corrupt" || details[5] == "duplicate") {
          else if (details[5] == "duplicate") {
            unit = "%";
          }

          $('#analytics_test_details').html('');
          $('#analytics_test_details').append(
              '<p></p>' +
              '<p><b>Test Number:</b> ' + details[0] +
              ' </p><p><b>Domain:</b> ' + details[1] +
              ' </p><p><b>Resource Type:</b> ' + details[2] +
              ' </p><p><b>Resource Name:</b> ' + details[3] +
              ' </p><p><b>Fault Type:</b> ' + details[5] + ' ' + details[6] + '' + unit +
              ' </p><p><b>Description:</b> ' + details[7] + '</p>' +
              ' </p><p><b>Fault Pattern:</b> ' + details[8] + ' ' + details[9] + ' ' + details[10] + '</p>' +
              ' </p><p><b>Fault Target Traffic:</b> ' + details[11] + ' - protocol: ' + details[12] + ' - src ports: ' + details[13] + ' - dst ports: ' + details[14] + '</p>' 
            );

          graph_test_fault_type = details[5];
          graph_test_target_resource = details[2];
        }, 
        statusCode: {
          500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
        }
      });
    }
    

    function function_jmeter_graph_test() {
      if (view_changed != "test") {
        $('#analytics_details').html('');
        $('#analytics_details').append(
            '<!-- Test_X details -->' +
            '<div class="row">' +
              '<div id="analytics_test_details" class="panel panel-default" style="width: 100%; height: auto; text-align: center; background-color: #f5f5f5; margin-left: 5px;">' +
              '</div>' +
            '</div>' +
            '<div class="row">' +
              '<div id="analytics_test_graph_client">' +
              '</div>' +
            '</div>' 
          );

        $('#analytics_test_checkbox').append(
            '<div id="analytics_test_checkbox_client">' +
            '</div>'
        );
      }

      var jmeter_timeData = [];
      var jmeter_throughput_req_sec = [];
      var jmeter_error_rate = [];
      var jmeter_throughput_bytes_sec = [];
      var jmeter_elapsed_time = []
      var jmeter_conn_timeout_rate = []
      var jmeter_resp_timeout_rate = []

      $.ajax({
        method: "POST",
        url: "{{  url_for('netcast.getJmeterLog') }}",
        data: { test: testAnalyticsID, campaign_name : $('#campaignName').text() },
        beforeSend: function() {
          getInfoTest();
        },
        success: function(response) {
          jmeter_log = JSON.parse(response);

          if (view_changed != "test") {
            view_changed = "test";
            $('#analytics_test_checkbox_client').html('');
            $('#analytics_test_graph_client').html('');

            //console.log(jmeter_log);

            $('#analytics_test_checkbox_client').append(
                '<div class="panel panel-default">' +
                '<!-- Default panel contents -->' +
                  '<div class="panel-heading">JMeter' +
                    '<div class="material-switch pull-right">' +
                        '<input id="jmeter_all_switch" name="jmeter_all" type="checkbox" checked>' +
                        '<label for="jmeter_all_switch" class="label-default" style="background-color: grey;"></label>' + 
                    '</div>' +
                  '</div>' +
                  '<!-- List group -->' +
                  '<ul class="list-group">' +
                    '<li class="list-group-item"> Throughput (req)' +
                      '<div class="material-switch pull-right">' +
                          '<input id="jmeter_throughput_req_sec_switch" name="containerTestParametersGraph_throughput_req_sec" type="checkbox" checked>' +
                          '<label for="jmeter_throughput_req_sec_switch" class="label-default" style="background-color: green;"></label>' + 
                      '</div>' +
                    '</li>' +
                    '<li class="list-group-item"> Error' +
                      '<div class="material-switch pull-right">' +
                          '<input id="jmeter_error_rate_switch" name="containerTestParametersGraph_error_rate" type="checkbox" checked>' +
                          '<label for="jmeter_error_rate_switch" class="label-default" style="background-color: red;"></label>' + 
                      '</div>' +
                    '</li>' +
                    '<li class="list-group-item"> Throughput (MB)' +
                      '<div class="material-switch pull-right">' +
                          '<input id="jmeter_throughput_bytes_sec_switch" name="containerTestParametersGraph_throughput_bytes_sec" type="checkbox" checked>' +
                          '<label for="jmeter_throughput_bytes_sec_switch" class="label-default" style="background-color: cyan;"></label>' + 
                      '</div>' +
                    '</li>' +
                    '<li class="list-group-item"> Elapsed time' +
                      '<div class="material-switch pull-right">' +
                          '<input id="jmeter_elapsed_time_switch" name="containerTestParametersGraph_elapsed_time" type="checkbox" checked>' +
                          '<label for="jmeter_elapsed_time_switch" class="label-default" style="background-color: orange;"></label>' + 
                      '</div>' +
                    '</li>' +
                    '<li class="list-group-item" style="font-size: small"> Connection timeout' +
                      '<div class="material-switch pull-right">' +
                          '<input id="jmeter_conn_timeout_switch" name="containerTestParametersGraph_conn_timeout" type="checkbox" checked>' +
                          '<label for="jmeter_conn_timeout_switch" class="label-default" style="background-color: brown;"></label>' + 
                      '</div>' +
                    '</li>' +
                    '<li class="list-group-item"> Response timeout' +
                      '<div class="material-switch pull-right">' +
                          '<input id="jmeter_resp_timeout_switch" name="containerTestParametersGraph_resp_timeout" type="checkbox" checked>' +
                          '<label for="jmeter_resp_timeout_switch" class="label-default" style="background-color: purple;"></label>' + 
                      '</div>' +
                    '</li>' +
                  '</ul>' +
                '</div>'
              );
          
            $('#analytics_test_graph_client').append(
                '<!-- Up row -->' +
                '<div class="row">' +
                  '<!-- Test Throughput(req) Graph -->' +
                    '<div id="containerTestParametersGraph_throughput_req_sec" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test Throughput(req) graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<!-- Test Bandwidth Error TCP -->' +
                    '<div id="containerTestParametersGraph_error_rate" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test Error graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<!-- Test Throughput(MB) Graph -->' +
                    '<div id="containerTestParametersGraph_throughput_bytes_sec" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test Throughput(MB) graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<!-- Test Elapsed time Graph -->' +
                    '<div id="containerTestParametersGraph_elapsed_time" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test Elapsed time graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<!-- Test Connection timeout Graph -->' +
                    '<div id="containerTestParametersGraph_conn_timeout" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test Connection timeout graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<!-- Test Response timeout Graph -->' +
                    '<div id="containerTestParametersGraph_resp_timeout" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test Response timeout graph -->' +
                '</div>'
              );
          }

          $('#analytics_test_checkbox_client :checkbox').change(function(){
            if ($(this).attr('name') == "jmeter_all") {
              if ($(this).is(':checked')) {
                $('#analytics_test_checkbox_client :checkbox').each(function (index,item){
                  if (!$(this).is(':checked')) {
                    $(this).click();
                  }
                });
              }
              else {
                $('#analytics_test_checkbox_client :checkbox').each(function (index,item){
                  if ($(this).is(':checked')) {
                    $(this).click();
                  }
                });
              }
            }
            else {
              var id = $(this).attr('name');
              if($(this).is(':checked')) { 
                $('#' + id).show();
              } else {
                $('#' + id).hide();
              }
            }
          });

          try {
            draw_jmeter_graph(1, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, jmeter_log['time'], jmeter_log['throughput_req_sec']);

            draw_jmeter_graph(2, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, jmeter_log['time'], jmeter_log['error_rate']);

            draw_jmeter_graph(3, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, jmeter_log['time'], jmeter_log['throughput_bytes_sec']);

            draw_jmeter_graph(4, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, jmeter_log['time'], jmeter_log['elapsed_time']);

            draw_jmeter_graph(5, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, jmeter_log['time'], jmeter_log['conn_timeout']);

            draw_jmeter_graph(6, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, jmeter_log['time'], jmeter_log['resp_timeout']);  
          }
          catch(err) {
            alert('Test_' + testAnalyticsID + '/summary.csv is not valid.' );
            view_changed = null;
          }
          

        },
        statusCode: {
          500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          501: function (response) {
            alert('Test_' + testAnalyticsID + '/summary.csv is not valid.' );
            $('#analytics_test_checkbox_client').html('');
            $('#analytics_test_graph_client').html('');
            view_changed = "all";
            last_pressed_button = null;
          },
          400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          404: function (response) { 
            alert('Test_' + testAnalyticsID + '/summary.csv not found. Please check NetCAST master agent logs.');
            view_changed = null;
            $('#analytics_test_checkbox_client').html('');
            $('#analytics_test_graph_client').html('');
          },
          0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
        }
      });


    }

    function function_iperf_graph_test() {
      if (view_changed != "test") {
        $('#analytics_details').html('');
        $('#analytics_details').append(
            '<!-- Test_X details -->' +
            '<div class="row">' +
              '<div id="analytics_test_details" class="panel panel-default" style="width: 100%; height: auto; text-align: center; background-color: #f5f5f5; margin-left: 5px;">' +
              '</div>' +
            '</div>' +
            '<div class="row">' +
              '<div id="analytics_test_graph_client">' +
              '</div>'+
              '<div id="analytics_test_graph_server">' +
              '</div>' +
              '<div id="analytics_test_graph_average">' +
              '</div>' +
            '</div>' 
          );

        $('#analytics_test_checkbox').append(
            '<div id="analytics_test_checkbox_client">' +
            '</div>' +
            '<div id="analytics_test_checkbox_server">' +
            '</div>'
          );
      }
      


      
      var iperf_client_test_protocol;
      var iperf_server_test_protocol;

      var iperf_client_timeData = [];
      var iperf_client_transfer = [];
      var iperf_client_bandwidth = [];

      //only TCP protocol
        var iperf_client_cwnd = [];
        var iperf_client_retransmits = [];
        var iperf_client_rtt = [];


      var iperf_server_timeData = [];
      var iperf_server_transfer = [];
      var iperf_server_bandwidth = [];

      //only UDP protocol  
        var iperf_server_jitter = [];
        var iperf_server_lost_percent = [];
        var iperf_server_packets = [];
        var iperf_server_lost_packets = [];

      //var iperf_test_fault_type;
      //var iperf_test_target_resource;

      var iperf_average_bandwidth = [];
      var iperf_average_traffic_lost = [];

      var iperf_average_packets_lost = [];

      
      //iperf client log
      $.ajax({
        method: "POST",
        url: "{{ url_for('netcast.getIperfLog') }}",
        data: { test: testAnalyticsID , log_type: "client" , campaign_name : $('#campaignName').text() },
        beforeSend: function() {
          getInfoTest();
        },
        success: function (response) {
          iperf_client_log = JSON.parse(response);

          try {
            iperf_client_test_protocol = iperf_client_log['start']['test_start']['protocol'];  
          
          } 
          catch(err) {
            alert('Test_' + testAnalyticsID + '/iperf_client.log is not valid.' );
            $('#analytics_test_checkbox_client').html('');
            $('#analytics_test_graph_client').html('');
            iperf_last_test_protocol_client = null;
            iperf_last_test_protocol_server = null;
            view_changed = null;
            return;
          }

          //clear analytics_details if this is the first clicked test or the protocol is different from the last clicked
          if (iperf_last_test_protocol_client !== iperf_client_test_protocol) {
            iperf_last_test_protocol_client = iperf_client_test_protocol;
            view_changed = "test";
            $('#analytics_test_checkbox_client').html('');
            $('#analytics_test_graph_client').html('');

            if (iperf_client_test_protocol == "TCP") {
              //iperf TCP mode
              $('#analytics_test_checkbox_client').append(
                  '<div class="panel panel-default">' +
                  '<!-- Default panel contents -->' +
                    '<div class="panel-heading">iPerf TCP client' +
                      '<div class="material-switch pull-right">' +
                          '<input id="iperf_tcp_client_all_switch" name="iperf_tcp_client_all" type="checkbox" checked>' +
                          '<label for="iperf_tcp_client_all_switch" class="label-default" style="background-color: grey;"></label>' + 
                      '</div>' +
                    '</div>' +
                    '<!-- List group -->' +
                    '<ul class="list-group">' +
                      '<li class="list-group-item"> Transfer' +
                        '<div class="material-switch pull-right">' +
                            '<input id="iperf_tcp_client_transfer_switch" name="containerTestParametersGraph_transfer_client_tcp" type="checkbox" checked>' +
                            '<label for="iperf_tcp_client_transfer_switch" class="label-default" style="background-color: green;"></label>' + 
                        '</div>' +
                      '</li>' +
                      '<li class="list-group-item"> Bandwidth' +
                        '<div class="material-switch pull-right">' +
                            '<input id="iperf_tcp_client_bandwidth_switch" name="containerTestParametersGraph_bandwidth_client_tcp" type="checkbox" checked>' +
                            '<label for="iperf_tcp_client_bandwidth_switch" class="label-default" style="background-color: red;"></label>' + 
                        '</div>' +
                      '</li>' +
                      '<li class="list-group-item"> CWND' +
                        '<div class="material-switch pull-right">' +
                            '<input id="iperf_tcp_client_cwnd_switch" name="containerTestParametersGraph_snd_cwnd_client_tcp" type="checkbox" checked>' +
                            '<label for="iperf_tcp_client_cwnd_switch" class="label-default" style="background-color: navy;"></label>' + 
                        '</div>' +
                      '</li>' +
                      '<li class="list-group-item"> Retransmits' +
                        '<div class="material-switch pull-right">' +
                            '<input id="iperf_tcp_client_retransmits_switch" name="containerTestParametersGraph_retransmits_client_tcp" type="checkbox" checked>' +
                            '<label for="iperf_tcp_client_retransmits_switch" class="label-default" style="background-color: brown;"></label>' + 
                        '</div>' +
                      '</li>' +
                      '<li class="list-group-item"> RTT' +
                        '<div class="material-switch pull-right">' +
                            '<input id="iperf_tcp_client_rtt_switch" name="containerTestParametersGraph_rtt_client_tcp" type="checkbox" checked>' +
                            '<label for="iperf_tcp_client_rtt_switch" class="label-default" style="background-color: orange;"></label>' + 
                        '</div>' +
                      '</li>' +
                    '</ul>' +
                  '</div>'
                );

              $('#analytics_test_graph_client').append(
                '<!-- Up row -->' +
                '<div class="row">' +
                  '<!-- Test Transfer Graph TCP -->' +
                    '<div id="containerTestParametersGraph_transfer_client_tcp" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test Transfer graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<!-- Test Bandwidth Graph TCP -->' +
                    '<div id="containerTestParametersGraph_bandwidth_client_tcp" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test Bandwidth graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<!-- Test CWND Graph -->' +
                    '<div id="containerTestParametersGraph_snd_cwnd_client_tcp" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test CWND graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<!-- Test Retransmits Graph -->' +
                    '<div id="containerTestParametersGraph_retransmits_client_tcp" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test Retransmits graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<!-- Test RTT Graph -->' +
                    '<div id="containerTestParametersGraph_rtt_client_tcp" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test RTT graph -->' +
                '</div>'
              );
            } 

            else {
              //iperf UDP mode
              $('#analytics_test_checkbox_client').append(
                '<div class="panel panel-default">' +
                '<!-- Default panel contents -->' +
                  '<div class="panel-heading">iPerf UDP client' +
                    '<div class="material-switch pull-right">' +
                      '<input id="iperf_udp_client_all_switch" name="iperf_udp_client_all" type="checkbox" checked>' +
                      '<label for="iperf_udp_client_all_switch" class="label-default" style="background-color: grey;"></label>' + 
                    '</div>' +
                  '</div>' +
                  '<!-- List group -->' +
                  '<ul class="list-group">' +
                    '<li class="list-group-item"> Transfer' +
                      '<div class="material-switch pull-right">' +
                          '<input id="iperf_udp_client_transfer_switch" name="containerTestParametersGraph_transfer_client_udp" type="checkbox" checked>' +
                          '<label for="iperf_udp_client_transfer_switch" class="label-default" style="background-color: green;"></label>' + 
                      '</div>' +
                    '</li>' +
                    '<li class="list-group-item"> Bandwidth' +
                      '<div class="material-switch pull-right">' +
                          '<input id="iperf_udp_client_bandwidth_switch" name="containerTestParametersGraph_bandwidth_client_udp" type="checkbox" checked>' +
                          '<label for="iperf_udp_client_bandwidth_switch" class="label-default" style="background-color: red;"></label>' + 
                      '</div>' +
                    '</li>' +
                  '</ul>' +
                '</div>'
              );

              $('#analytics_test_graph_client').append(
                '<!-- Up row -->' +
                '<div class="row">' +
                  '<!-- Test Transfer Graph -->' +
                    '<div id="containerTestParametersGraph_transfer_client_udp" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test transfer graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<!-- Test Transfer Graph -->' +
                    '<div id="containerTestParametersGraph_bandwidth_client_udp" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test transfer graph -->' +
                '</div>'
              );   
            }
          }

          $('#analytics_test_checkbox_client :checkbox').change(function(){
            if ($(this).attr('name') == "iperf_tcp_client_all" || $(this).attr('name') == "iperf_udp_client_all") {
              if ($(this).is(':checked')) {
                $('#analytics_test_checkbox_client :checkbox').each(function (index,item){
                  if (!$(this).is(':checked')) {
                    $(this).click();
                  }
                });
              }
              else {
                $('#analytics_test_checkbox_client :checkbox').each(function (index,item){
                  if ($(this).is(':checked')) {
                    $(this).click();
                  }
                });
              }
            }
            else {
              var id = $(this).attr('name');
              if($(this).is(':checked')) { 
                $('#' + id).show();
              } else {
                $('#' + id).hide();
              }
            }
          });

          iperf_client_timeData.push(0);
          iperf_client_transfer.push(0);
          iperf_client_bandwidth.push(0);

          for (var i = 0; i < iperf_client_log['intervals'].length; i++) {
          
            iperf_client_timeData.push(Math.floor(iperf_client_log['intervals'][i]['streams'][0]['end']));
            iperf_client_transfer.push(Math.floor(iperf_client_log['intervals'][i]['streams'][0]['bytes'] / 1024));
            iperf_client_bandwidth.push(Math.floor(iperf_client_log['intervals'][i]['streams'][0]['bits_per_second'] / 1024));

          }

          draw_iperf_graph(iperf_client_test_protocol, 1,testAnalyticsID, graph_test_fault_type, graph_test_target_resource, 1, iperf_client_timeData, iperf_client_transfer);
          
          draw_iperf_graph(iperf_client_test_protocol, 1,testAnalyticsID, graph_test_fault_type, graph_test_target_resource, 2, iperf_client_timeData, iperf_client_bandwidth);

          if (iperf_client_test_protocol == "TCP") {
            iperf_client_cwnd.push(0);
            iperf_client_retransmits.push(0);
            iperf_client_rtt.push(0);

            for (var i = 0; i < iperf_client_log['intervals'].length; i++ ) {

              //snd_cwnd is in bytes -> MBytes
              iperf_client_cwnd.push(Math.floor(iperf_client_log['intervals'][i]['streams'][0]['snd_cwnd'] / 1024));
              iperf_client_retransmits.push(iperf_client_log['intervals'][i]['streams'][0]['retransmits']);
              //rtt is in milliseconds -> seconds
              iperf_client_rtt.push(iperf_client_log['intervals'][i]['streams'][0]['rtt'] / 1000000);
            }

            draw_iperf_graph(iperf_client_test_protocol, 1, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, 6, iperf_client_timeData, iperf_client_cwnd);

            draw_iperf_graph(iperf_client_test_protocol, 1, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, 7, iperf_client_timeData, iperf_client_retransmits);

            draw_iperf_graph(iperf_client_test_protocol, 1, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, 8, iperf_client_timeData, iperf_client_rtt);              
          }
        
        },
        statusCode: {
          500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          404: function (response) { 
            alert('Test_' + testAnalyticsID + '/iperf_client.log not found. Please check NetCAST master agent logs.');
            iperf_last_test_protocol_client = null;
            $('#analytics_test_checkbox_client').html('');
            $('#analytics_test_graph_client').html('');
          },
          0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
        }
      });


      //iperf server log
      $.ajax({
        method: "POST",
        url: "{{ url_for('netcast.getIperfLog') }}",
        data: { test: testAnalyticsID , log_type: "server" , campaign_name : $('#campaignName').text() },
        success: function (response) {
          iperf_server_log = JSON.parse(response);

          try {
            iperf_server_test_protocol = iperf_server_log['start']['test_start']['protocol'];
          }
          catch(err) {
            alert('Test_' + testAnalyticsID + '/iperf_server.log is not valid.');
            iperf_last_test_protocol_client = null;
            iperf_last_test_protocol_server = null;
            view_changed = null;
            $('#analytics_test_checkbox_server').html('');
            $('#analytics_test_graph_server').html('');
            $('#analytics_test_graph_average').html('');
            //return false;
            return;
          }


          if (iperf_last_test_protocol_server !== iperf_server_test_protocol) {
            iperf_last_test_protocol_server = iperf_server_test_protocol;
            view_changed = "test";
            $('#analytics_test_checkbox_server').html('');
            $('#analytics_test_graph_server').html('');
            $('#analytics_test_graph_average').html('');

            if (iperf_server_test_protocol == "TCP") {
              //iperf TCP mode
              $('#analytics_test_checkbox_server').append(
                '<div class="panel panel-default">' +
                '<!-- Default panel contents -->' +
                  '<div class="panel-heading">iPerf TCP server' +
                    '<div class="material-switch pull-right">' +
                      '<input id="iperf_tcp_server_all_switch" name="iperf_tcp_server_all" type="checkbox" checked>' +
                      '<label for="iperf_tcp_server_all_switch" class="label-default" style="background-color: grey;"></label>' + 
                    '</div>' +
                  '</div>' +
                  '<!-- List group -->' +
                  '<ul class="list-group">' +
                    '<li class="list-group-item"> Transfer' +
                      '<div class="material-switch pull-right">' +
                          '<input id="iperf_tcp_server_transfer_switch" name="containerTestParametersGraph_transfer_server_tcp" type="checkbox" checked>' +
                          '<label for="iperf_tcp_server_transfer_switch" class="label-default" style="background-color: green;"></label>' + 
                      '</div>' +
                    '</li>' +
                    '<li class="list-group-item"> Bandwidth' +
                      '<div class="material-switch pull-right">' +
                          '<input id="iperf_tcp_server_bandwidth_switch" name="containerTestParametersGraph_bandwidth_server_tcp" type="checkbox" checked>' +
                          '<label for="iperf_tcp_server_bandwidth_switch" class="label-default" style="background-color: red;"></label>' + 
                      '</div>' +
                    '</li>' +
                  '</ul>' +
                '</div>'
              );

              $('#analytics_test_graph_server').append(
                '<div class="row">' +
                '<!-- Test Transfer Graph -->' +
                  '<div id="containerTestParametersGraph_transfer_server_tcp" style="height: 300px;">' +
                  '</div>' +
                '<!-- end test Transfer graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<!-- Test Bandwidth Graph -->' +
                    '<div id="containerTestParametersGraph_bandwidth_server_tcp" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test Bandwidth graph -->' +
                '</div>'
              );

              $('#analytics_test_graph_average').append(
                '<div class="row">' +
                  '<div class="col-sm-6">' +
                    '<!-- Average Bandwidth Bar Graph -->' +
                      '<div id="containerAverageBarGraph_bandwidth_server_tcp" style="height:300px;" hidden>' +
                      '</div>' +
                    '<!-- end average Bandwidth bar graph -->' +
                  '</div>' +

                  '<div class="col-sm-6">' +
                    '<!-- Average Sent/Lost Loss Bar Graph-->' +
                      '<div id="containerAverageBarGraph_lost_server_tcp" style="height:300px;" hidden>' +
                      '</div>' +
                    '<!-- end average Sent/Lost bar graph -->' +
                  '</div>' +
                '</div>' 
              );
            }

            else {
              //iperf UDP mode
              $('#analytics_test_checkbox_server').append(
                '<div class="panel panel-default">' +
                '<!-- Default panel contents -->' +
                  '<div class="panel-heading">iPerf UDP server' +
                  '<div class="material-switch pull-right">' +
                      '<input id="iperf_udp_server_all_switch" name="iperf_udp_server_all" type="checkbox" checked>' +
                      '<label for="iperf_udp_server_all_switch" class="label-default" style="background-color: grey;"></label>' + 
                    '</div>' +
                  '</div>' +
                  '<!-- List group -->' +
                  '<ul class="list-group">' +
                    '<li class="list-group-item"> Transfer' +
                      '<div class="material-switch pull-right">' +
                          '<input id="iperf_udp_server_transfer_switch" name="containerTestParametersGraph_transfer_server_udp" type="checkbox" checked>' +
                          '<label for="iperf_udp_server_transfer_switch" class="label-default" style="background-color: green;"></label>' + 
                      '</div>' +
                    '</li>' +
                    '<li class="list-group-item"> Bandwidth' +
                      '<div class="material-switch pull-right">' +
                          '<input id="iperf_udp_server_bandwidth_switch" name="containerTestParametersGraph_bandwidth_server_udp" type="checkbox" checked>' +
                          '<label for="iperf_udp_server_bandwidth_switch" class="label-default" style="background-color: red;"></label>' + 
                      '</div>' +
                    '</li>' +
                    '<li class="list-group-item"> Jitter' +
                      '<div class="material-switch pull-right">' +
                          '<input id="iperf_udp_server_jitter_switch" name="containerTestParametersGraph_jitter_server_udp" type="checkbox" checked>' +
                          '<label for="iperf_udp_server_jitter_switch" class="label-default" style="background-color: navy;"></label>' + 
                      '</div>' +
                    '</li>' +
                    '<li class="list-group-item"> Sent / Lost' +
                      '<div class="material-switch pull-right">' +
                          '<input id="iperf_udp_server_sent_lost_switch" name="containerTestParametersGraph_sent_lost_server_udp" type="checkbox" checked>' +
                          '<label for="iperf_udp_server_sent_lost_switch" class="label-default" style="background-color: brown;"></label>' + 
                      '</div>' +
                    '</li>' +
                    '<li class="list-group-item"> Percentage loss' +
                      '<div class="material-switch pull-right">' +
                          '<input id="iperf_udp_server_lost_switch" name="containerTestParametersGraph_lost_percentage_server_udp" type="checkbox" checked>' +
                          '<label for="iperf_udp_server_lost_switch" class="label-default" style="background-color: orange;"></label>' + 
                      '</div>' +
                    '</li>' +
                  '</ul>' +
                '</div>'
              );

              $('#analytics_test_graph_server').append(
                '<div class="row">' +
                  '<!-- Test Transfer Graph -->' +
                    '<div id="containerTestParametersGraph_transfer_server_udp" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test transfer graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<!-- Test Transfer Graph -->' +
                    '<div id="containerTestParametersGraph_bandwidth_server_udp" style="height: 300px;">' +
                    '</div>' +
                  '<!-- end test transfer graph -->' +
                '</div>' +
                '<div class="row">' +
                  '<div id="containerTestParametersGraph_jitter_server_udp" style="height: 300px;">' +
                  '</div>' +
                '</div>' +
                '<div class="row">' +
                  '<div id="containerTestParametersGraph_sent_lost_server_udp" style="height: 300px;">' +
                  '</div>' +
                '</div>' +
                '<div id="row">' +
                  '<div id="containerTestParametersGraph_lost_percentage_server_udp" style="height: 300px;">' +
                  '</div>' +
                '</div>'
              );

              $('#analytics_test_graph_average').append(
                '<!-- Down row -->' +
                '<div class="row">' +
                  '<div class="col-sm-6">' +
                    '<!-- Average Bandwidth Bar Graph -->' +
                      '<div id="containerAverageBarGraph_bandwidth_server_udp" style="height:300px;">' +
                      '</div>' +
                    '<!-- end average bandwidth bar graph -->' +
                  '</div>' +

                  '<div class="col-sm-6">' +
                    '<!-- Average Traffic Loss Bar Graph-->' +
                      '<div id="containerAverageBarGraph_lost_server_udp" style="height:300px;">' +
                      '</div>' +
                    '<!-- end average traffic loss bar graph -->' +
                  '</div>' +
                '</div>' 
              );
            }
          }



          $('#analytics_test_checkbox_server :checkbox').change(function(){
            if ($(this).attr('name') == "iperf_tcp_server_all" || $(this).attr('name') == "iperf_udp_server_all") {
              if ($(this).is(':checked')) {
                $('#analytics_test_checkbox_server :checkbox').each(function (index,item){
                  if (!$(this).is(':checked')) {
                    $(this).click();
                  }
                });
              }
              else {
                $('#analytics_test_checkbox_server :checkbox').each(function (index,item){
                  if ($(this).is(':checked')) {
                    $(this).click();
                  }
                });
              }
            }
            else {
              var id = $(this).attr('name');
              if($(this).is(':checked')) { 
                $('#' + id).show();
              } else {
                $('#' + id).hide();
              }
            }
          });

          iperf_server_timeData.push(0);
          iperf_server_transfer.push(0);
          iperf_server_bandwidth.push(0);

          for (var i = 0; i < iperf_server_log['intervals'].length; i++) {
          
            iperf_server_timeData.push(Math.floor(iperf_server_log['intervals'][i]['streams'][0]['end']));
            iperf_server_transfer.push(Math.floor(iperf_server_log['intervals'][i]['streams'][0]['bytes'] / 1024));
            iperf_server_bandwidth.push(Math.floor(iperf_server_log['intervals'][i]['streams'][0]['bits_per_second'] / 1024));

          }

          draw_iperf_graph(iperf_server_test_protocol, 2, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, 1, iperf_server_timeData, iperf_server_transfer);
          
          draw_iperf_graph(iperf_server_test_protocol, 2, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, 2, iperf_server_timeData, iperf_server_bandwidth);

          if (iperf_server_test_protocol == "UDP") {
            
            iperf_server_jitter.push(0);
            iperf_server_lost_percent.push(0);
            iperf_server_packets.push(0);
            iperf_server_lost_packets.push(0);  
          
            for (var i = 0; i < iperf_server_log['intervals'].length; i++) {
          
              iperf_server_jitter.push(iperf_server_log['intervals'][i]['streams'][0]['jitter_ms']);
              iperf_server_lost_percent.push(iperf_server_log['intervals'][i]['streams'][0]['lost_percent']);

              iperf_server_packets.push(iperf_server_log['intervals'][i]['streams'][0]['packets']);
              iperf_server_lost_packets.push(iperf_server_log['intervals'][i]['streams'][0]['lost_packets']);

            }

            draw_iperf_graph(iperf_server_test_protocol, 2, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, 3, iperf_server_timeData, iperf_server_jitter);

            draw_iperf_graph(iperf_server_test_protocol, 2, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, 4, iperf_server_timeData, iperf_server_lost_percent);

            draw_iperf_graph_double(iperf_server_test_protocol, 2, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, 5, iperf_server_timeData, iperf_server_packets, iperf_server_lost_packets);


          
            var iperf_server_timeData_preInjection = [];
            var iperf_server_timeData_inInjection = [];
            var iperf_server_timeData_postInjection = [];

            var iperf_server_bandwidth_preInjection = [];
            var iperf_server_bandwidth_inInjection = [];
            var iperf_server_bandwidth_postInjection = [];

            //var iperf_server_lost_preInjection = [];
            //var iperf_server_lost_inInjection = [];
            //var iperf_server_lost_postInjection = [];

            var iperf_server_packets_preInjection = [];
            var iperf_server_packets_inInjection = [];
            var iperf_server_packets_postInjection = [];

            var iperf_server_lost_packets_preInjection = [];
            var iperf_server_lost_packets_inInjection = [];
            var iperf_server_lost_packets_postInjection = [];

            for ( var i = 0; i < iperf_server_timeData.length; i++ ) {
              if ( iperf_server_timeData[i] < eval(graph_pre_injection_time) ) {
                iperf_server_timeData_preInjection.push(iperf_server_timeData[i]);
                iperf_server_bandwidth_preInjection.push(iperf_server_bandwidth[i]);
                //iperf_server_lost_preInjection.push(iperf_server_lost_percent[i]);

                iperf_server_packets_preInjection.push(iperf_server_packets[i]);
                iperf_server_lost_packets_preInjection.push(iperf_server_lost_packets[i]);
              } 
              else if ( iperf_server_timeData[i] >= eval(graph_pre_injection_time) && iperf_server_timeData[i] <= (eval(graph_pre_injection_time)+eval(graph_injection_time)) ) {
                iperf_server_timeData_inInjection.push(iperf_server_timeData[i]);
                iperf_server_bandwidth_inInjection.push(iperf_server_bandwidth[i]);
                //iperf_server_lost_inInjection.push(iperf_server_lost_percent[i]);

                iperf_server_packets_inInjection.push(iperf_server_packets[i]);
                iperf_server_lost_packets_inInjection.push(iperf_server_lost_packets[i]);
              }
              else {
                iperf_server_timeData_postInjection.push(iperf_server_timeData[i]);
                iperf_server_bandwidth_postInjection.push(iperf_server_bandwidth[i]);  
                //iperf_server_lost_postInjection.push(iperf_server_lost_percent[i]);

                iperf_server_packets_postInjection.push(iperf_server_packets[i]);
                iperf_server_lost_packets_postInjection.push(iperf_server_lost_packets[i]);
              } 
            }

            //average bandwidth bar graph
            var sum, avg = 0;
            if (iperf_server_bandwidth_preInjection.length){
              sum = iperf_server_bandwidth_preInjection.reduce(function (a, b) { return a + b;});
              avg = Math.floor(sum / (iperf_server_bandwidth_preInjection.length - 1));
            }
            iperf_average_bandwidth.push(avg);

            var sum, avg = 0;
            if (iperf_server_bandwidth_inInjection.length){
              sum = iperf_server_bandwidth_inInjection.reduce(function (a, b) { return a + b;});
              avg = Math.floor(sum / iperf_server_bandwidth_inInjection.length);
            }
            iperf_average_bandwidth.push(avg);

            var sum, avg = 0;
            if (iperf_server_bandwidth_postInjection.length){
              sum = iperf_server_bandwidth_postInjection.reduce(function (a, b) { return a + b;});
              avg = Math.floor(sum / iperf_server_bandwidth_postInjection.length);
            }
            iperf_average_bandwidth.push(avg);


            draw_iperf_graph_average(iperf_server_test_protocol, 2, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, 1, iperf_average_xAxis, iperf_average_bandwidth);


            var sum_packets, sum_lost_packets, avg = 0;
            if (iperf_server_packets_preInjection.length && iperf_server_lost_packets_preInjection) {
              sum_packets = iperf_server_packets_preInjection.reduce(function (a, b) { return a + b;});
              sum_lost_packets = iperf_server_lost_packets_preInjection.reduce(function (a, b) { return a + b;});
              if (sum_lost_packets) {
                avg = ((sum_lost_packets / sum_packets) * 100).toFixed(2);  
              }
            }
            iperf_average_packets_lost.push(avg);

            var sum_packets, sum_lost_packets, avg = 0;
            if (iperf_server_packets_inInjection.length && iperf_server_lost_packets_inInjection) {
              sum_packets = iperf_server_packets_inInjection.reduce(function (a, b) { return a + b;});
              sum_lost_packets = iperf_server_lost_packets_inInjection.reduce(function (a, b) { return a + b;});
              if (sum_lost_packets) {
                avg = ((sum_lost_packets / sum_packets) * 100).toFixed(2);  
              }
            }
            iperf_average_packets_lost.push(avg);

            var sum_packets, sum_lost_packets, avg = 0;
            if (iperf_server_packets_postInjection.length && iperf_server_lost_packets_postInjection) {
              sum_packets = iperf_server_packets_postInjection.reduce(function (a, b) { return a + b;});
              sum_lost_packets = iperf_server_lost_packets_postInjection.reduce(function (a, b) { return a + b;});
              if (sum_lost_packets) {
                avg = ((sum_lost_packets / sum_packets) * 100).toFixed(2);  
              }
            }
            iperf_average_packets_lost.push(avg);  

            draw_iperf_graph_average(iperf_server_test_protocol, 2, testAnalyticsID, graph_test_fault_type, graph_test_target_resource, 2, iperf_average_xAxis, iperf_average_packets_lost);

          }
        },
        statusCode: {
          500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          404: function (response) { 
            alert('Test_' + testAnalyticsID + '/iperf_server.log not found. Please check NetCAST master agent logs.');
            iperf_last_test_protocol_server = null;
            $('#analytics_test_checkbox_server').html('');
            $('#analytics_test_graph_server').html('');
            $('#analytics_test_graph_average').html('');
          },
          0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
        }
      });

    }
  }
});


/******** START - ECharts Iperf Graph ********/
function draw_iperf_graph_average_all(protocol, client_server_label, parameter_id, x_data, y_data, pre_average) {
  domTarget = "containerTestParametersGraph_" + iperf_graph_parameter[parameter_id] + "_" + iperf_client_server_label[client_server_label].toLowerCase()+ "_" + protocol.toLowerCase()+ "_all";
  var baseVar = 'testAverageBarGraph_';
  this[baseVar+iperf_graph_parameter[parameter_id]+'Chart_'+iperf_client_server_label[client_server_label].toLowerCase()+"_all_"+protocol.toLowerCase()] = echarts.init(document.getElementById(domTarget));

  var max_y = null;
  
  if (iperf_graph_unit[parameter_id] == "%") {
    max_y = 100;
  } else {
    if (Math.max.apply(Math, y_data) < pre_average) { 
      max_y = pre_average;}
  }

  // specify chart configuration item and data
  var option = {
      title: {
          text: 'iPerf '+protocol+' '+iperf_client_server_label[client_server_label]+' - Average '+ iperf_graph_parameter_label[parameter_id],
          subtext: 'All Tests',
        x: 'center'
      },
      tooltip: {},
      toolbox: {
        feature: {
            saveAsImage: {
              title : 'save as\nimage'
            }
        },
        right : '3%'
      },
      legend: {
          data: [iperf_graph_parameter_label[parameter_id]],
          right : '1%',
          top : '17%'
      },
      grid : {
          top : '25%',
          right : 30 
        },
      xAxis : [
        {
          type : 'category',
          data : x_data
        }
      ],
      yAxis : [ 
        {
          name : iperf_graph_parameter_label[parameter_id] + '\n' + '(' + iperf_graph_unit[parameter_id] + ')',
          type: 'value',
          max : max_y
        }
      ],
      series : [
        {
          name: iperf_graph_parameter_label[parameter_id],
          type: 'bar',
          barWidth : '50%', 
          color: iperf_graph_color[parameter_id],
          data: y_data,
          markLine: { 
            data: [{
              yAxis: pre_average, 
              lineStyle: {color: 'navy'}, 
              label: {
                position: 'middle',
                formatter: 'Average ' + iperf_graph_parameter_label[parameter_id] + ' (pre injection time)'
              } 
            }] 
          }
        }
      ]
  };

  // use configuration item and data specified to show chart
  this[baseVar+iperf_graph_parameter[parameter_id]+'Chart_'+iperf_client_server_label[client_server_label].toLowerCase()+"_all_"+protocol.toLowerCase()].setOption(option);

  this[baseVar+iperf_graph_parameter[parameter_id]+'Chart_'+iperf_client_server_label[client_server_label].toLowerCase()+"_all_"+protocol.toLowerCase()].on('click', function(params) {
      //console.log(params.name);
      $('#' + params.name).click();
      //scroll exp-list_analytics on clicked test
      $('#exp-list_analytics').scrollTop(0);
      exp_off = $('#'+params.name).parent().offset().top;
      exp_list_max_height = eval($('#exp-list_analytics').css('max-height').replace("px","")) + 1;
      exp_list_base = $('#exp-list_analytics').offset().top;
      exp_height = eval($('#'+params.name).parent().css('height').replace("px",""));
      $('#exp-list_analytics').scrollTop(exp_off - exp_list_max_height - exp_list_base + exp_height + 1)
    });
}

function draw_iperf_graph_average(protocol, client_server_label, exp_id, fault_type, target_resource, parameter_id, x_data, y_data){
  domTarget = "containerAverageBarGraph_" + iperf_average_parameter[parameter_id] + "_" + iperf_client_server_label[client_server_label].toLowerCase()+ "_" + protocol.toLowerCase();
  var baseVar = 'testAverageBarGraph_';
  this[baseVar+iperf_average_parameter[parameter_id]+'Chart_'+iperf_client_server_label[client_server_label].toLowerCase()] = echarts.init(document.getElementById(domTarget));
                  
  var max_y = null;
  
  if (iperf_average_unit[parameter_id] == "%") {
    max_y = 100;
  }
  // specify chart configuration item and data
  var option = {
      title: {
          text: 'iPerf '+protocol+' '+iperf_client_server_label[client_server_label]+' - '+ iperf_average_parameter_label[parameter_id],
          subtext: 'Test '+ exp_id +' - ' + fault_type + ' ' + target_resource,
        x: 'center'
      },
      tooltip: {},
      toolbox: {
        feature: {
            saveAsImage: {
              title : 'save as\nimage'
            }
        },
        right : '3%'
      },
      legend: {
          data: [iperf_average_parameter_label[parameter_id]],
          right : '1%',
          top : '17%'
      },
      grid : {
          top : '25%',
          right : 10 
        },
      xAxis : [
        {
          type : 'category',
          data : x_data
        }
      ],
      yAxis : [ 
        {
          name : iperf_average_parameter_label[parameter_id] + '\n' + '(' + iperf_average_unit[parameter_id] + ')',
          type: 'value',
          max : max_y
        }
      ],
      series : [
        {
          name: iperf_average_parameter_label[parameter_id],
          type: 'bar',
          barWidth : '50%',
          color: iperf_average_color[parameter_id],
          data: y_data
        }
      ]
  };

  // use configuration item and data specified to show chart
  this[baseVar+iperf_average_parameter[parameter_id]+'Chart_'+iperf_client_server_label[client_server_label].toLowerCase()].setOption(option);
}


function draw_iperf_graph(protocol, client_server_label, exp_id, fault_type, target_resource, parameter_id, time_data_array, parameter_array) {
  domTarget = "containerTestParametersGraph_" + iperf_graph_parameter[parameter_id] + "_" + iperf_client_server_label[client_server_label].toLowerCase() + "_" + protocol.toLowerCase();
  var baseVar = 'testParametersGraph_';
  this[baseVar+iperf_graph_parameter[parameter_id]+'Chart_'+iperf_client_server_label[client_server_label].toLowerCase()] = echarts.init(document.getElementById(domTarget));


  var max_y = null;
  
  if (iperf_graph_unit[parameter_id] == "%") {
    max_y = 100;
  }

  option = {
    title: {
        text: 'iPerf '+protocol+' '+iperf_client_server_label[client_server_label] +' - ' + iperf_graph_parameter_label[parameter_id],
        subtext: 'Test '+ exp_id +' - ' + fault_type + ' ' + target_resource,
        x: 'center'
    },
    tooltip: {
        trigger: 'axis',
        axisPointer: {
            animation: false
        }
    },
    legend: {
        data:[iperf_graph_parameter_label[parameter_id]],
        right : '1%',
        top : '17%'
    },
    toolbox: {
        feature: {
            dataZoom: {
                yAxisIndex: 'none',
                title : {
                  zoom : 'area\nzooming',
                  back : 'restore area\nzooming'
                }
            },
            restore: {
              title : 'restore'
            },
            saveAsImage: {
              title : 'save as\nimage'
            }
        },
        right : '1%'
    },
    axisPointer: {
        link: {xAxisIndex: 'all'}
    },
    dataZoom: [
        {
            show: true,
            type: 'inside', 
            realtime: true,
            start: 0,
            end: 100,
        }
    ],
    grid: [{
        left: 50,
        right: 50,
        top : '25%'
    }],
    xAxis : [
        {
            name : 'time\n(sec)',
            type : 'category',
            boundaryGap : false,
            axisLine: {onZero: true},
            data: time_data_array
        }
    ],
    yAxis : [
        {
            name : iperf_graph_parameter_label[parameter_id] + '\n' + '(' + iperf_graph_unit[parameter_id] + ')',
            type : 'value',
            max : max_y
            //animationThreshold = Math.floor(Math.max.apply(null, parameter_array) + Math.max.apply(null, parameter_array) * 0.1) 
        }
    ],
    series : [
        {
            name: iperf_graph_parameter_label[parameter_id],
            type:'line',
            symbolSize: 1,
            color: iperf_graph_color[parameter_id],
            hoverAnimation: true,
            markArea: {
                silent: true,
                data: [[{
                    xAxis: parseInt(graph_pre_injection_time)
                }, {
                    xAxis: parseInt(graph_pre_injection_time) + parseInt(graph_injection_time)
                }]]
            },
            data: parameter_array
        }
    ]
  };
  this[baseVar+iperf_graph_parameter[parameter_id]+'Chart_'+iperf_client_server_label[client_server_label].toLowerCase()].setOption(option);

  if (!$('input[name='+domTarget+']').is(':checked')) {
    $('#' + domTarget).hide();
  }
}


function draw_iperf_graph_double(protocol, client_server_label, exp_id, fault_type, target_resource, parameter_id, time_data_array, parameter_array_1, parameter_array_2) {
  domTarget = "containerTestParametersGraph_" + iperf_graph_parameter[parameter_id] + "_" + iperf_client_server_label[client_server_label].toLowerCase() + "_" + protocol.toLowerCase();
  var baseVar = 'testParametersGraph_';
  this[baseVar+iperf_graph_parameter[parameter_id]+'Chart_'+iperf_client_server_label[client_server_label].toLowerCase()] = echarts.init(document.getElementById(domTarget));


  option = {
    title: {
        text: 'iPerf '+protocol+' '+iperf_client_server_label[client_server_label] +' - ' + iperf_graph_parameter_label[parameter_id][0] + ' / ' + iperf_graph_parameter_label[parameter_id][1],
        subtext: 'Test '+ exp_id +' - ' + fault_type + ' ' + target_resource,
        x: 'center'
    },
    tooltip: {
        trigger: 'axis',
        axisPointer: {
            animation: false
        }
    },
    legend: {
        data: iperf_graph_parameter_label[parameter_id],
        right : '1%',
        top : '17%'
    },
    toolbox: {
        feature: {
            dataZoom: {
                yAxisIndex: 'none',
                title : {
                  zoom : 'area\nzooming',
                  back : 'restore area\nzooming'
                }
            },
            restore: {
              title : 'restore'
            },
            saveAsImage: {
              title : 'save as\nimage'
            }
        },
        right : '1%'
    },
    axisPointer: {
        link: {xAxisIndex: 'all'}
    },
    dataZoom: [
        {
            show: true,
            type: 'inside', 
            realtime: true,
            start: 0,
            end: 100,
        }
    ],
    grid: [{
        left: 50,
        right: 50,
        top : '25%'
    }],
    xAxis : [
        {
            name : 'time\n(sec)',
            type : 'category',
            boundaryGap : false,
            axisLine: {onZero: true},
            data: time_data_array
        }
    ],
    yAxis : [
        {
            name : iperf_graph_parameter_label[parameter_id][0] + ' / ' + iperf_graph_parameter_label[parameter_id][1] + '\n' + '(' + iperf_graph_unit[parameter_id] + ')',
            type : 'value'
            //max : max_y
            //animationThreshold = Math.floor(Math.max.apply(null, parameter_array) + Math.max.apply(null, parameter_array) * 0.1) 
        }
    ],
    series : [
        {
            name: iperf_graph_parameter_label[parameter_id][0],
            type:'line',
            symbolSize: 1,
            color: iperf_graph_color[parameter_id][0],
            hoverAnimation: true,
            markArea: {
                silent: true,
                data: [[{
                    xAxis: parseInt(graph_pre_injection_time)
                }, {
                    xAxis: parseInt(graph_pre_injection_time) + parseInt(graph_injection_time)
                }]]
            },
            data: parameter_array_1
        },

        {
            name: iperf_graph_parameter_label[parameter_id][1],
            type:'line',
            symbolSize: 1,
            color: iperf_graph_color[parameter_id][1],
            hoverAnimation: true,
            data: parameter_array_2
        }        
    ]
  };
  this[baseVar+iperf_graph_parameter[parameter_id]+'Chart_'+iperf_client_server_label[client_server_label].toLowerCase()].setOption(option);

  if (!$('input[name='+domTarget+']').is(':checked')) {
    $('#' + domTarget).hide();
  }
}
/******** END - ECharts Iperf Graph ********/
  

/******** START - ECharts Jmeter Graph ********/

var jmeter_graph_parameter = {
  1: "throughput_req_sec",
  2: "error_rate",
  3: "throughput_bytes_sec",
  4: "elapsed_time",
  5: "conn_timeout",
  6: "resp_timeout"
}

var jmeter_graph_unit_all = {
  1: "req/sec",
  2: "%",
  3: "MB/sec",
  4: "ms",
  5: "%",
  6: "%"
}

var jmeter_graph_unit = {
  1: "req/sec",
  2: "number",
  3: "MB/sec",
  4: "ms",
  5: "number",
  6: "number"
}

var jmeter_graph_parameter_label = {
  1: "Throughput-req/sec",
  2: "Error Rate",
  3: "Throughput-MB/sec",
  4: "Elapsed Time",
  5: "Connection Timeout",
  6: "Response Timeout"
}

var jmeter_graph_color = {
  1: "green",
  2: "red",
  3: "cyan",
  4: "orange",
  5: "brown",
  6: "purple"
}

function draw_jmeter_graph_average_all(parameter_id, x_data, y_data, pre_average) {
  domTarget = "containerTestParametersGraph_" + jmeter_graph_parameter[parameter_id] + "_all";
  var baseVar = 'testAverageBarGraph_';
  this[baseVar+jmeter_graph_parameter[parameter_id]+'Chart_all'] = echarts.init(document.getElementById(domTarget));

  var max_y = null;
  
  if (jmeter_graph_unit_all[parameter_id] == "%") {
    max_y = 100;
  } 
  else {
    if (Math.max.apply(Math, y_data) < pre_average) { 
      max_y = pre_average;
    }
  }


  // specify chart configuration item and data
  var option = {
      title: {
          text: 'JMeter - Average '+ jmeter_graph_parameter_label[parameter_id],
          subtext: 'All Tests',
        x: 'center'
      },
      tooltip: {},
      toolbox: {
        feature: {
            saveAsImage: {
              title : 'save as\nimage'
            }
        },
        right : '3%'
      },
      legend: {
          data: [jmeter_graph_parameter_label[parameter_id]],
          right : '1%',
          top : '17%'
      },
      grid : {
          top : '25%',
          right : 30 
        },
      xAxis : [
        {
          type : 'category',
          data : x_data
        }
      ],
      yAxis : [ 
        {
          name : jmeter_graph_parameter_label[parameter_id] + '\n' + '(' + jmeter_graph_unit_all[parameter_id] + ')',
          type: 'value',
          max : max_y
        }
      ],
      series : [
        {
          name: jmeter_graph_parameter_label[parameter_id],
          type: 'bar',
          barWidth : '50%', 
          color: jmeter_graph_color[parameter_id],
          data: y_data,
          markLine: { 
            data: [{
              yAxis: pre_average, 
              lineStyle: {color: 'navy'}, 
              label: {
                position: 'middle',
                formatter: 'Average ' + jmeter_graph_parameter_label[parameter_id] + ' (pre injection time)'
              } 
            }] 
          }
        }
      ]
  };

  // use configuration item and data specified to show chart
  this[baseVar+jmeter_graph_parameter[parameter_id]+'Chart_all'].setOption(option);

  this[baseVar+jmeter_graph_parameter[parameter_id]+'Chart_all'].on('click', function(params) {
      //console.log(params.name);
      $('#' + params.name).click();
      //scroll exp-list_analytics on clicked test
      $('#exp-list_analytics').scrollTop(0);
      exp_off = $('#'+params.name).parent().offset().top;
      exp_list_max_height = eval($('#exp-list_analytics').css('max-height').replace("px","")) + 1;
      exp_list_base = $('#exp-list_analytics').offset().top;
      exp_height = eval($('#'+params.name).parent().css('height').replace("px",""));
      $('#exp-list_analytics').scrollTop(exp_off - exp_list_max_height - exp_list_base + exp_height + 1)
    });
}


function draw_jmeter_graph(parameter_id, exp_id, fault_type, target_resource, time_data_array, parameter_array) {
  domTarget = "containerTestParametersGraph_" + jmeter_graph_parameter[parameter_id];
  var baseVar = 'testParametersGraph_';
  this[baseVar+jmeter_graph_parameter[parameter_id]+'Chart_'] = echarts.init(document.getElementById(domTarget));


  var max_y = null;
  
  if (jmeter_graph_unit[parameter_id] == "%") {
    max_y = 100;
  }

  option = {
    title: {
        text: 'JMeter - ' + jmeter_graph_parameter_label[parameter_id],
        subtext: 'Test '+ exp_id +' - ' + fault_type + ' ' + target_resource,
        x: 'center'
    },
    tooltip: {
        trigger: 'axis',
        axisPointer: {
            animation: false
        }
    },
    legend: {
        data:[jmeter_graph_parameter_label[parameter_id]],
        right : '1%',
        top : '17%'
    },
    toolbox: {
        feature: {
            dataZoom: {
                yAxisIndex: 'none',
                title : {
                  zoom : 'area\nzooming',
                  back : 'restore area\nzooming'
                }
            },
            restore: {
              title : 'restore'
            },
            saveAsImage: {
              title : 'save as\nimage'
            }
        },
        right : '1%'
    },
    axisPointer: {
        link: {xAxisIndex: 'all'}
    },
    dataZoom: [
        {
            show: true,
            type: 'inside', 
            realtime: true,
            start: 0,
            end: 100,
        }
    ],
    grid: [{
        left: 50,
        right: 50,
        top : '25%'
    }],
    xAxis : [
        {
            name : 'time\n(sec)',
            type : 'category',
            boundaryGap : false,
            axisLine: {onZero: true},
            data: time_data_array
        }
    ],
    yAxis : [
        {
            name : jmeter_graph_parameter_label[parameter_id] + '\n' + '(' + jmeter_graph_unit[parameter_id] + ')',
            type : 'value',
            max : max_y
            //animationThreshold = Math.floor(Math.max.apply(null, parameter_array) + Math.max.apply(null, parameter_array) * 0.1) 
        }
    ],
    series : [
        {
            name: jmeter_graph_parameter_label[parameter_id],
            type:'line',
            symbolSize: 1,
            color: jmeter_graph_color[parameter_id],
            hoverAnimation: true,
            markArea: {
                silent: true,
                data: [[{
                    xAxis: parseInt(graph_pre_injection_time)
                }, {
                    xAxis: parseInt(graph_pre_injection_time) + parseInt(graph_injection_time)
                }]]
            },
            data: parameter_array
        }
    ]
  };
  this[baseVar+jmeter_graph_parameter[parameter_id]+'Chart_'].setOption(option);

  if (!$('input[name='+domTarget+']').is(':checked')) {
    $('#' + domTarget).hide();
  }
}


/******** END - ECharts JMeter Graph ********/


window.onresize = function() {
  if (testParametersGraph_transferChart_client) {
    testParametersGraph_transferChart_client.resize();
  }

  if(testParametersGraph_bandwidthChart_client) {
    testParametersGraph_bandwidthChart_client.resize();  
  }
  
  //only TCP protocol
    if (testParametersGraph_snd_cwndChart_client) {
      testParametersGraph_snd_cwndChart_client.resize();
    }

    if (testParametersGraph_retransmitsChart_client) {
      testParametersGraph_retransmitsChart_client.resize();
    }

    if (testParametersGraph_rttChart_client) {
      testParametersGraph_rttChart_client.resize();
    }

  if (testParametersGraph_transferChart_server) {
    testParametersGraph_transferChart_server.resize();
  }

  if (testParametersGraph_bandwidthChart_server) {
    testParametersGraph_bandwidthChart_server.resize();
  }

  //only UDP protocol
    if (testParametersGraph_jitterChart_server) {
      testParametersGraph_jitterChart_server.resize();
    }

    if (testParametersGraph_lost_percentageChart_server) {
      testParametersGraph_lost_percentageChart_server.resize();
    }

    if (testParametersGraph_sent_lostChart_server) {
      testParametersGraph_sent_lostChart_server.resize();
    }
  
  if (testAverageBarGraph_bandwidthChart_server) {
    testAverageBarGraph_bandwidthChart_server.resize();
  }

  if (testAverageBarGraph_lostChart_server) {
    testAverageBarGraph_lostChart_server.resize();
  }

  if (testAverageBarGraph_bandwidthChart_server_all_udp) {
    testAverageBarGraph_bandwidthChart_server_all_udp.resize();
  }

  if (testAverageBarGraph_sent_lostChart_server_all_udp) {
    testAverageBarGraph_sent_lostChart_server_all_udp.resize();
  }

  if (testAverageBarGraph_bandwidthChart_client_all_tcp) {
    testAverageBarGraph_bandwidthChart_client_all_tcp.resize();
  }

  if (testAverageBarGraph_rttChart_client_all_tcp) {
    testAverageBarGraph_rttChart_client_all_tcp.resize();
  }

  if (testAverageBarGraph_bandwidthChart_server_all_tcp) {
    testAverageBarGraph_bandwidthChart_server_all_tcp.resize();
  }

  // JMETER
  if (testAverageBarGraph_throughput_req_secChart_all) {
    testAverageBarGraph_throughput_req_secChart_all.resize();
  }

  if (testAverageBarGraph_error_rateChart_all) {
    testAverageBarGraph_error_rateChart_all.resize();
  }

  if (testAverageBarGraph_throughput_bytes_secChart_all) {
    testAverageBarGraph_throughput_bytes_secChart_all.resize();
  }

  if (testAverageBarGraph_elapsed_timeChart_all) {
    testAverageBarGraph_elapsed_timeChart_all.resize();
  }

  if (testAverageBarGraph_conn_timeoutChart_all) {
    testAverageBarGraph_conn_timeoutChart_all.resize()
  }  

  if (testAverageBarGraph_resp_timeoutChart_all) {
    testAverageBarGraph_resp_timeoutChart_all.resize()
  }

  if (testParametersGraph_throughput_req_secChart_) {
    testParametersGraph_throughput_req_secChart_.resize()
  }

  if (testParametersGraph_error_rateChart_) {
    testParametersGraph_error_rateChart_.resize()
  }

  if (testParametersGraph_throughput_bytes_secChart_) {
    testParametersGraph_throughput_bytes_secChart_.resize()
  }

  if (testParametersGraph_elapsed_timeChart_) {
    testParametersGraph_elapsed_timeChart_.resize()
  }

  if (testParametersGraph_conn_timeoutChart_) {
    testParametersGraph_conn_timeoutChart_.resize()
  }

  if (testParametersGraph_resp_timeoutChart_) {
    testParametersGraph_resp_timeoutChart_.resize()
  }

}


/****** END - JS for iPerfAnalytics - ******/



/****** START - JS for showNetworkTopology - ******/
$('#fastConfiguration').click( function () {
  $('#fast_configuration_modal').show();
});

$('#fast_configuration_header_close').click( function () {
  $('#fast_configuration_modal').hide();
});

$('#fast_configuration_add').click( function () {
  //add selected faults to network topology
  $('#fast_configuration_modal').hide();
}); 

$('#ProjectResourcesModal').on('show.bs.modal', function() {
  setTimeout(function(){
    $('#showNetworkTopology').click()
  },300);
});

$('#showNetworkTopology_help_conf').popover({
  html:true,
  title: "Workload configuration help",
  content: function(){
    if ($('#uRole').text() == " virtual ") {
      return '<text style="font-size: small;">' +
                '<ol style="padding-left: 20px;">' +
                  '<li><p>Grab a workload generator (yellow node)</p></li>' +
                  '<li><p>Drag it on a subnet node (a green circle will appear)</p></li>' +
                  '<li><p>Drop the node to attach the workload to the subnet (the node will become green)</p></li>' +
                  '<li><p>To remove the workload, grab the attached generator, and drag it away from the subnet</p></li>' +
                '</ol>' +
              '</text>'
    }
    else {
     return '<text style="font-size: small;">' +
                '<ol style="padding-left: 20px;">' +
                  '<li><p>Grab a workload generator (yellow node)</p></li>' +
                  '<li><p>Drag it on a physical node (a green circle will appear)</p></li>' +
                  '<li><p>Drop the node to attach the workload to the physical node (the node will become green)</p></li>' +
                  '<li><p>To remove the workload, grab the attached generator, and drag it away from the physical node</p></li>' +
                '</ol>' +
              '</text>' 
    }
  }
}).on("show.bs.popover", function() { $(this).data("bs.popover").tip().css({"maxWidth": "300px", "width": "300px"}); });

$('#showNetworkTopology_help_1').popover({
  html:true,
  title: "Network topology legend",
  content: function() { 
    if ($('#uRole').text() == " virtual ") {
      return  '<div class="row">' +
                '<div class="col-sm-6">' +
                  '<b><center style="font-size: small; "> Resource type</center><hr style="margin-top: 5px; margin-bottom: 5px;"></b>' +
                  '<p><img src={{ url_for('static', filename="globe_icon.png") }} style="width:20px;"><text style="font-size: small;"> public network</text></p>' +
                  '<p><img src={{ url_for('static', filename="router_icon.png") }} style="width:25px;"><text style="font-size: small;"> router</text></p>' +
                  '<p><img src={{ url_for('static', filename="cloud_icon.png") }} style="width:25px;"><text style="font-size: small;"> private network</text></p>' +
                  '<p><img src={{ url_for('static', filename="subnet_icon.png") }} style="width:18px;"><text style="font-size: small;">  private subnet</text></p>' +
                  '<p><img src={{ url_for('static', filename="workstation_icon.png") }} style="width:18px;"><text style="font-size: small;"> instance</text></p>' +
                '</div>' +
                '<div class="col-sm-6">' +
                '<b><center style="font-size: small; "> Fault type</center><hr style="margin-top: 5px; margin-bottom: 5px;"></b>' +
                  '<p><img src={{ url_for('static', filename="latency_icon.png") }} style="width:20px;"><text style="font-size: small;"> latency fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="loss_icon.png") }} style="width:20px;"><text style="font-size: small;"> loss fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="corruption_icon.png") }} style="width:20px;"><text style="font-size: small;"> corrupt fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="delete_icon.png") }} style="width:20px;"><text style="font-size: small;"> delete fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="duplicate_icon.png") }} style="width:20px;"><text style="font-size: small;"> duplicate fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="bottleneck_icon.png") }} style="width:20px;"><text style="font-size: small;"> bottleneck fault</text></p>' +
                '</div>' +
              '</div>'
    }
    else {
      return  '<div class="row">' +
                '<div class="col-sm-6">' +
                  '<b><center style="font-size: small; "> Resource type</center><hr style="margin-top: 5px; margin-bottom: 5px;"></b>' +
                  '<p><img src={{ url_for('static', filename="switch_icon.png") }} style="width:20px;"><text style="font-size: small;"> physical switch</text></p>' +
                  '<p><img src={{ url_for('static', filename="workstation_icon2.png") }} style="width:25px;"><text style="font-size: small;"> physical node</text></p>' +
                '</div>' +
                '<div class="col-sm-6">' +
                '<b><center style="font-size: small; "> Fault type</center><hr style="margin-top: 5px; margin-bottom: 5px;"></b>' +
                  '<p><img src={{ url_for('static', filename="latency_icon.png") }} style="width:20px;"><text style="font-size: small;"> latency fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="loss_icon.png") }} style="width:20px;"><text style="font-size: small;"> loss fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="corruption_icon.png") }} style="width:20px;"><text style="font-size: small;"> corrupt fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="delete_icon.png") }} style="width:20px;"><text style="font-size: small;"> delete fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="duplicate_icon.png") }} style="width:20px;"><text style="font-size: small;"> duplicate fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="bottleneck_icon.png") }} style="width:20px;"><text style="font-size: small;"> bottleneck fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="down_icon.png") }} style="width:20px;"><text style="font-size: small;"> down fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="reboot_icon.png") }} style="width:20px;"><text style="font-size: small;"> reboot fault</text></p>' +
                '</div>' +
              '</div>'
    }

  },
 }).on("show.bs.popover", function() { $(this).data("bs.popover").tip().css({"maxWidth": "300px", "width": "300px"}); });


$('#showNetworkTopology_help_2').popover({
  html:true,
  title: "Network topology legend",
  content: function() { 
    if ($('#uRole').text() == " virtual ") {
      return  '<div class="row">' +
                '<div class="col-sm-6">' +
                  '<b><center style="font-size: small; "> Resource type</center><hr style="margin-top: 5px; margin-bottom: 5px;"></b>' +
                  '<p><img src={{ url_for('static', filename="globe_icon.png") }} style="width:20px;"><text style="font-size: small;"> public network</text></p>' +
                  '<p><img src={{ url_for('static', filename="router_icon.png") }} style="width:25px;"><text style="font-size: small;"> router</text></p>' +
                  '<p><img src={{ url_for('static', filename="cloud_icon.png") }} style="width:25px;"><text style="font-size: small;"> private network</text></p>' +
                  '<p><img src={{ url_for('static', filename="subnet_icon.png") }} style="width:18px;"><text style="font-size: small;">  private subnet</text></p>' +
                  '<p><img src={{ url_for('static', filename="workstation_icon.png") }} style="width:18px;"><text style="font-size: small;"> instance</text></p>' +
                  '<p><img src={{ url_for('static', filename="detached-workload.png") }} style="width:18px;"><text style="font-size: small;"> workload OFF</text></p>' +
                  '<p><img src={{ url_for('static', filename="attached-workload.png") }} style="width:18px;"><text style="font-size: small;"> workload ON</text></p>' +
                '</div>' +
                '<div class="col-sm-6">' +
                '<b><center style="font-size: small; "> Fault type</center><hr style="margin-top: 5px; margin-bottom: 5px;"></b>' +
                  '<p><img src={{ url_for('static', filename="latency_icon.png") }} style="width:20px;"><text style="font-size: small;"> latency fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="loss_icon.png") }} style="width:20px;"><text style="font-size: small;"> loss fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="corruption_icon.png") }} style="width:20px;"><text style="font-size: small;"> corrupt fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="delete_icon.png") }} style="width:20px;"><text style="font-size: small;"> delete fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="duplicate_icon.png") }} style="width:20px;"><text style="font-size: small;"> duplicate fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="bottleneck_icon.png") }} style="width:20px;"><text style="font-size: small;"> bottleneck fault</text></p>' +
                '</div>' +
              '</div>'
    }
    else {
      return  '<div class="row">' +
                '<div class="col-sm-6" style="padding-left: 10">' +
                  '<b><center style="font-size: small; "> Resource type</center><hr style="margin-top: 5px; margin-bottom: 5px;"></b>' +
                  '<p><img src={{ url_for('static', filename="switch_icon.png") }} style="width:20px;"><text style="font-size: small;"> physical switch</text></p>' +
                  '<p><img src={{ url_for('static', filename="workstation_icon2.png") }} style="width:25px;"><text style="font-size: small;"> physical node</text></p>' +
                  '<p><img src={{ url_for('static', filename="detached-workload.png") }} style="width:18px;"><text style="font-size: small;"> workload OFF</text></p>' +
                  '<p><img src={{ url_for('static', filename="attached-workload.png") }} style="width:18px;"><text style="font-size: small;"> workload ON</text></p>' +
                '</div>' +
                '<div class="col-sm-6">' +
                '<b><center style="font-size: small; "> Fault type</center><hr style="margin-top: 5px; margin-bottom: 5px;"></b>' +
                  '<p><img src={{ url_for('static', filename="latency_icon.png") }} style="width:20px;"><text style="font-size: small;"> latency fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="loss_icon.png") }} style="width:20px;"><text style="font-size: small;"> loss fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="corruption_icon.png") }} style="width:20px;"><text style="font-size: small;"> corrupt fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="delete_icon.png") }} style="width:20px;"><text style="font-size: small;"> delete fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="duplicate_icon.png") }} style="width:20px;"><text style="font-size: small;"> duplicate fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="bottleneck_icon.png") }} style="width:20px;"><text style="font-size: small;"> bottleneck fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="down_icon.png") }} style="width:20px;"><text style="font-size: small;"> down fault</text></p>' +
                  '<p><img src={{ url_for('static', filename="reboot_icon.png") }} style="width:20px;"><text style="font-size: small;"> reboot fault</text></p>' +
                '</div>' +
              '</div>'
    }

  },
 }).on("show.bs.popover", function() { $(this).data("bs.popover").tip().css({"maxWidth": "300px", "width": "300px"}); });



var data_network_topology;

$('#showNetworkTopology').click( function() {

  $('#faultload_configuration').html("");
  $('#showNetworkTopologyObject').html("");
  $('#showNetworkTopology_faultload').show();
  
  $('#showNetworkTopology_faultload').css("height", "500px");
  $('#showNetworkTopologyObject').css("height", "500px");
  $('#faultload_configuration').css("height", "500px");



 var faultDict = {
  'latency' : 10,
  'loss' : 11,
  'corrupt' : 12,
  'delete' : 13,
  'duplicate' : 14,
  'bottleneck' : 15,
  'down' : 16,
  'reboot' : 17
 }

  var groupResources = {
    1: "public_network",
    2: "router",
    3: "private_network",
    4: "subnet",
    5: "vm",
    7: "switch",
    8: "vmPhysical",
    10: "latency",
    11: "loss",
    12: "corrupt",
    13: "delete",
    14: "duplicate",
    15: "bottleneck",
    16: "down",
    17: "reboot"
  }
  var groupLogo = {
    1: "{{ url_for('static', filename="globe_icon.png") }}",
    2: "{{ url_for('static', filename="router_icon.png") }}",
    3: "{{ url_for('static', filename="cloud_icon.png") }}",
    4: "{{ url_for('static', filename="subnet_icon.png") }}",
    5: "{{ url_for('static', filename="workstation_icon.png") }}",
    7: "{{ url_for('static', filename="switch_icon.png") }}",
    8: "{{ url_for('static', filename="workstation_icon2.png") }}",
    10: "{{ url_for('static', filename="latency_icon.png") }}",
    11: "{{ url_for('static', filename="loss_icon.png") }}",
    12: "{{ url_for('static', filename="corruption_icon.png") }}",
    13: "{{ url_for('static', filename="delete_icon.png") }}",
    14: "{{ url_for('static', filename="duplicate_icon.png") }}",
    15: "{{ url_for('static', filename="bottleneck_icon.png") }}",
    16: "{{ url_for('static', filename="down_icon.png") }}",
    17: "{{ url_for('static', filename="reboot_icon.png") }}"
  }

  var groupLogoSize = {
    1: 26,
    2: 24,
    3: 24,
    4: 15,
    5: 19,
    7: 19,
    8: 19,
    10: 12,
    11: 12,
    12: 12,
    13: 12,
    14: 12,
    15: 16,
    16: 12,
    17: 12
  }

  var groupCircleColor = {
    1: "white",
    2: "white",
    3: "white",
    4: "white",
    5: "white",
    7: "white",
    8: "white",
    10: "#ff000080",
    11: "#ff000080",
    12: "#ff000080",
    13: "#ff000080",
    14: "#ff000080",
    15: "#ff000080",
    16: "#ff000080",
    17: "#ff000080"
  }

  var groupLogoXY = {
    1: -13,
    2: -12,
    3: -12,
    4: -7.5,
    5: -9.5,
    7: -9.5,
    8: -9.5,
    10: -6,
    11: -6,
    12: -6,
    13: -6,
    14: -6,
    15: -8,
    16: -6,
    17: -6
  }

  var groupCircleSize = {
    1: 18,
    2: 18,
    3: 18,
    4: 15,
    5: 18,
    7: 18,
    8: 18,
    10: 12,
    11: 12,
    12: 12,
    13: 12,
    14: 12,
    15: 12,
    16: 12,
    17: 12
  }

  
  var statusNodeIcon = {
    'NotCompleted' : "{{ url_for('static', filename="NotCompleted.png") }}",
    'completed' : "{{ url_for('static', filename="completed.png") }}",
    'error' : "{{ url_for('static', filename="error.png") }}"
  }


  var width = $('#showNetworkTopologyContainer').width(),
      height = $('#showNetworkTopologyObject').height();

  var color = d3.scale.category20();

  var force = d3.layout.force()
      .charge(-500)
      .linkDistance(50)
      .size([width, height]);

  var zoom = d3.behavior.zoom()
            .scaleExtent([1/5, 10])
            .on("zoom", zoomed);

  var drag = d3.behavior.drag()
            .origin(function(d) { return d; })
            .on("dragstart", dragstarted)
            .on("drag", dragged)
            .on("dragend", dragended);

  var svg = d3.select("#showNetworkTopologyObject").append("svg")
            .attr("width", width)
            .attr("height", height)
            .call(zoom);

  var zoomContainer = svg.append("g");
  
  var node, link = [];

  getNetTopologyURL = null;
  scanProjectURL = null;

  if ($('#uRole').text() == " virtual ") {
    getNetTopologyURL = "{{ url_for('netcast.getNetworkTopology') }}";
    scanProjectURL = "{{ url_for('netcast.scanProject') }}";
  }
  else {
    getNetTopologyURL = "{{ url_for('netcast.scanPhyNetworkTopology') }}";
    scanProjectURL = "{{ url_for('netcast.scanProjectPhysical') }}";
  }


  $.ajax({
    method: "POST",
    url: getNetTopologyURL, 
    data: { campaign_name : $('#campaignName').text() },
    beforeSend: function () {
        $('#showNetworkTopologyContainer').append(
          '<div id="showNetworkTopologySpinner" class="panel-default" style="position: absolute; text-align: center; top: 50%; width: 561px; height: 500px;">' +
            '<span class="field-label" style="font-size:32px;color:#555;">Loading...</span>' +
            '<br>' +
            '<span class="fa fa-spinner fa-spin" style="font-size:64px;color:#555;"></span>' +
          '</div>'
        );

    },    
    success: function(response) {
      $('#showNetworkTopologySpinner').fadeOut(300, function() { $('#showNetworkTopologySpinner').remove();});
      data_network_topology = JSON.parse(response);

      $.d3render();

      var t = $('#table1').DataTable();
      if (t.rows('.selected').data().length != 0) {
        selected_test_case = []
        $.each(t.rows('.selected').data(), function(i, obj) { 
          table_fip = obj.slice(1);
          string_fip = table_fip[0];
          $.each(table_fip.slice(1), function (i, e) {
            string_fip += "#";
            string_fip += e; 
          });
          selected_test_case.push(string_fip.toString());
        });

        $.ajax({
          method: "POST",
          url: "{{ url_for('netcast.updateNetworkTopologyFromTable') }}",
          data: { testcases: JSON.stringify(selected_test_case),
                  nodes: JSON.stringify(data_network_topology['nodes']),
                  links: JSON.stringify(data_network_topology['links'])
                  },
          success: function (response) {
            //push new nodes and links to data_network_topology
            resp = JSON.parse(response);

            nodes = resp['nodes'];
            links = resp['links'];

            for (var i = 0; i < nodes.length; i++ ) {
              data_network_topology['nodes'].push(nodes[i])
            }

            for (var i = 0; i < links.length; i++ ) {
              data_network_topology['links'].push(links[i])
            }
            $.d3render();
          },
          statusCode: {
            500:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
            400:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
            0:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          }
        });
      }
      else {
        $.d3render();
      }

      // call scan to populate advanced configuration
      $('#FL_args_save').prop("disabled", true);
      $('#FL_args').prop("disabled", true);
      $('#FL_args_unit').html("");

        /***** Project Resources Tree *****/
      $('#PR_tree').remove();
      $('#PR_description').html("");
      $('#PR_tree_container').append('<div id="PR_tree"></div>');

      $('#PR_tree').fancytree({
        checkbox: true,
        extention: ["edit", "filter"],
        selectMode: 3,
        source: $.ajax({
                    type: "GET",
                    url: scanProjectURL,
                    dataType: "json"
                  }),
      select: function (event, data) {
                if (!data.node.folder) {
                  if(data.node.selected) { 
                    data.node.setFocus(true);
                    data.node.setActive(true);
                    $('#PR_description').html('<b>Name:  </b>' + data.node.title + '<br />' + '<b>ID:  </b>' + data.node.data.id);
                  }
                  else {
                    data.node.setFocus(false);
                    data.node.setActive(false);
                    $('#PR_description').html("");
                  }
                }
              },
      click:  function(event, data) {
                var node = data.node;
                if (node.folder){
                  $('#PR_description').html("");
                } else {
                    if (data.targetType !== 'checkbox') {
                      $('#PR_description').html('<b>Name:  </b>' + node.title + '<br />' + '<b>ID:  </b>' + node.data.id);
                    }
                }
              }
      });
    },
    statusCode: {
      500:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      501:  function (response) { alert('Error during scan for network resources. Please check NetCAST master agent logs.'); location.reload(); },
      403: function (response) { 

        $.confirm({
                      title: '<b>ERROR</b>',
                      content: 'The network topology is changed. The user can only view analytics results.',
                      type: 'red',
                      typeAnimated: true,
                      buttons: {
                          logout: function () { logout(); },
                          ok: function() { 
                            $('#ProjectResourcesModal').modal('hide');
                            $('.nav-tabs a[href="#tabScan"]').prop('disabled',true);
                            $('.nav-tabs a[href="#tabAnalytics"]').click();
                            changeNetConfig = true;
                          }
                      }
                  });
      },
      400:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      0:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
    }
  });

  var node_index = null;

  function d3recolor() {
    d3.selectAll('circle')
      .filter(function(d, i) { return (i%2) == 0  })
      .style("opacity", 0);
  }

  function handleClickNode(d, i) {
    console.log(data_network_topology);
    node_index = i;
    $('#faultload_configuration').html("");
    /**** emphasized_node ****/
    //turn off another active node
    d3.selectAll('circle')
        .filter(function(d, i) { return (i%2) == 0  })
        .style("opacity", 0);
        
    //active clicked node
    d3.select(this).selectAll('circle')
      .filter(function(d, i) { return i == 0 })
      .style("opacity", 1);

    node_resource_group = null;
    node_fault_group = null;
    //console.log(data_network_topology);
    if ( data_network_topology['nodes'][node_index]['type'] == "fault" ) {
      //get correspondent resource
      data_link = data_network_topology['links'];
      for ( var i = 0; i < data_link.length; i++ ) {
        if ( data_link[i]['target']['index'] == node_index ) {
          node_resource_group = data_link[i]['source']['group'];
          node_fault_group = data_link[i]['target']['group'];
          break;
        }
      }

      var default_args_value = null;
      /**** create faultload panel ****/
      $('#faultload_configuration').append(
        '<div id="faultload_configuration_content" class="modal-dialog modal-content" style="top: 15px; width: 300px; background-color: aliceblue; border: 1px #555 solid; margin-top: 0px;">' +
          '<div class="modal-header">' +
            '<h5 class="modal-title" style="display: inline";>Fault configuration</h5>' +
            '<button id="faultload_configuration_header_close" type="button" class="close">' +
              '<span aria-hidden="true">×</span>' +
            '</button>' +
          '</div>' +
          '<div class="modal-body">' +
            
            '<div class="row">' +
              '<div class="col-sm-6" style="text-align: center">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label">' +
                    '<span class="field-label">Resource type:</span>' +
                  '</label>' +
                  '<br> ' +
                  '<text id="faultload_configuration_RS" type="text">' + data_network_topology['nodes'][node_index]['fault_target']['resource_type'] + '<br>' + data_network_topology['nodes'][node_index]['fault_target']['resource_name'] + '</text>' +
                '</div>' +
              '</div>' +
              '<div class="col-sm-6" style="text-align: center">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label" style="display: block;">' +
                    '<span class="field-label">Fault type:</span>' +
                  '</label>' +
                  '<text id="faultload_configuration_FL" type="text">' + groupResources[node_fault_group] + '</input>' +
                '</div>' +
              '</div>' +
            '</div>' +

            '<div class="row" style="text-align: center;">' +
              '<a data-toggle="collapse" data-target="#fault_conf_details_faultload" class="collapsed">show details ' +
                '<span class="glyphicon glyphicon-chevron-down" style="font-size: small;"></span> ' +
              '</a>' +
            '</div>' +

            '<div id="fault_conf_details_faultload" class="collapse"> '+
              '<label class="control-label">' +
                '<span class="field-label">Description:</span>' +
              '</label>' +
              '<div class="panel panel-default">' +
                '<div id="faultload_configuration_FL_description" class="panel-body">' +
                '</div>' +
              '</div>' +

              '<label class="control-label">' +
                '<span id="faultload_configuration_FL_args_unit" class="field-label">N/A:</span>' +
              '</label>' +
              '<div class="form-group">' +
                '<input id="faultload_configuration_FL_args" type="text">' +
              '</div>' +

              //
              '<hr>' +
              '<div class="row">' +
                '<div class="col-sm-4" style="text-align: center">' +
                  '<div class="form-group" style="display: inline-block;">' +
                    '<label class="control-label">' +
                      '<span class="field-label">Fault pattern:</span>' +
                    '</label>' +
                    '<text id="faultload_configuration_FL_pattern_name" type="text">' + data_network_topology['nodes'][node_index]['fault_pattern']['name'] + '</text>' +
                  '</div>' +
                '</div>' +
                '<div class="col-sm-8" style="text-align: center">' +
                  '<div id="faultload_configuration_FL_args_pattern_container">' +
                    //input fields set properly on node['fault_pattern']['name']
                  '</div>' +  
                '</div>' +
              '</div>' +

              '<hr>' +
              '<div class="row">' +
                '<div class="col-sm-5" style="text-align: center">' +
                  '<div class="form-group" style="display: inline-block;">' +
                    '<label class="control-label">' +
                      '<span class="field-label">Fault target:</span>' +
                    '</label>' +
                    '<text id="faultload_configuration_FL_target_name" type="text">' + data_network_topology['nodes'][node_index]['fault_target_traffic']['name'] + '</text>' +
                  '</div>' +
                '</div>' +
                '<div class="col-sm-7" style="text-align: center">' +
                  '<div id="faultload_configuration_FL_args_target_container">' +
                    //input fields set properly on node['fault_target_traffic']['name'] 
                  '</div>' +  
                '</div>' +
              '</div>' +

            '</div>' +

            '<div id="faultload_configuration_alertArgs">' +
            '</div>' +
            
          '</div>' +
          '<div class="modal-footer" style="margin-top: 0px;">'+
            '<button id="faultload_configuration_remove" type="button" class="btn btn-danger">Remove</button>' +
            '<button id="faultload_configuration_update" type="button" class="btn btn-primary">Update</button>' +
          '</div>' +
        '</div>'
      );

      if ( data_network_topology['nodes'][node_index]['fault_pattern']['name']  == "random") {
        $('#faultload_configuration_FL_args_pattern_container').append(
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_pattern_unit" class="field-label">Probability of faulty packet (%):</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<input id="faultload_configuration_FL_args_pattern" type="text" size="10" placeholder="Insert percentage">' +
            '</div>'
          );
        $('#faultload_configuration_FL_args_pattern').val(data_network_topology['nodes'][node_index]['fault_pattern']['args']['arg1']);  
      } 
      else if ( data_network_topology['nodes'][node_index]['fault_pattern']['name'] == "persistent" ) {
        $('#faultload_configuration_FL_args_pattern_container').append(
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_pattern_unit" class="field-label">N/A</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_pattern_name" type="text">Empty</text>' +
            '</div>'
          );
      }
      else if ( data_network_topology['nodes'][node_index]['fault_pattern']['name'] == "burst" ) {
        $('#faultload_configuration_FL_args_pattern_container').append(
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_pattern_unit" class="field-label">Burst duration (ms):</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<input id="faultload_configuration_FL_args_pattern" type="text" size="10" placeholder="Insert duration">' +
            '</div>' +
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_pattern_1_unit" class="field-label">Burst periodicity (ms):</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<input id="faultload_configuration_FL_args_pattern_1" type="text" size="10" placeholder="Insert periodicity">' +
            '</div>'
          );
        $('#faultload_configuration_FL_args_pattern').val(data_network_topology['nodes'][node_index]['fault_pattern']['args']['arg1']);
        $('#faultload_configuration_FL_args_pattern_1').val(data_network_topology['nodes'][node_index]['fault_pattern']['args']['arg2']);            
      }
      else if ( data_network_topology['nodes'][node_index]['fault_pattern']['name'] == "degradation" ) {
        $('#faultload_configuration_FL_args_pattern_container').append(
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_pattern_unit" class="field-label">Rate of packet degradation (%):</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<input id="faultload_configuration_FL_args_pattern" type="text"  size="10" placeholder="Insert degradation rate">' +
            '</div>'
          );
        $('#faultload_configuration_FL_args_pattern').val(data_network_topology['nodes'][node_index]['fault_pattern']['args']['arg1']);  
      }

      if ( data_network_topology['nodes'][node_index]['fault_target_traffic']['name'] !== "User-specified traffic" ) {
        $('#faultload_configuration_FL_args_target_container').html("");
        $('#faultload_configuration_FL_args_target_container').append(
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_taget_unit" class="field-label">Protocol:</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_target" type="text"></text>' +
            '</div>' +  
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_taget_1_unit" class="field-label">SRC Ports:</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_target_1" type="text" size="15"></text>' +
            '</div>' +
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_taget_2_unit" class="field-label">DST Ports:</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_target_2" type="text" size="15"></text>' +
            '</div>'
          );

        $('#faultload_configuration_FL_args_target_1').html("Empty");

        if ( data_network_topology['nodes'][node_index]['fault_target_traffic']['name'] == "any traffic" ) {
          $('#faultload_configuration_FL_args_target').html("Empty");
          $('#faultload_configuration_FL_args_target_2').html("Empty");
        }
        else {
          $('#faultload_configuration_FL_args_target').html(data_network_topology['nodes'][node_index]['fault_target_traffic']['args']['protocol']);
          $('#faultload_configuration_FL_args_target_2').html(data_network_topology['nodes'][node_index]['fault_target_traffic']['args']['dst_ports']);
        }
      }
      else {
        //TODO: ADD properly input filed. Protocol is defined
        $('#faultload_configuration_FL_args_target_container').html("");
        $('#faultload_configuration_FL_args_target_container').append(
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_taget_unit" class="field-label">Protocol:</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<text id="faultload_configuration_FL_args_target" type="text">' + data_network_topology['nodes'][node_index]['fault_target_traffic']['args']['protocol'] + '</text>' +
            '</div>' +
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_taget_1_unit" class="field-label">SRC Ports:</span>' +
            '</label>' +
            '<div class="form-group">' +
              '<input id="faultload_configuration_FL_args_target_1" type="text" placeholder="Insert src ports" size="15">' +
            '</div>' +
            '<label class="control-label">' +
              '<span id="faultload_configuration_FL_args_taget_2_unit" class="field-label">DST Ports:</span>' +
            '</label>' +
            '<div class="form-group">' +
                '<input id="faultload_configuration_FL_args_target_2" type="text" placeholder="Insert dst ports" size="15">' +
            '</div>'
          );

         $('#faultload_configuration_FL_args_target_1').val(data_network_topology['nodes'][node_index]['fault_target_traffic']['args']['src_ports']);
         $('#faultload_configuration_FL_args_target_2').val(data_network_topology['nodes'][node_index]['fault_target_traffic']['args']['dst_ports']);
      }

      if ( groupResources[node_fault_group] != "delete" && groupResources[node_fault_group] != "loss" && groupResources[node_fault_group] != "corrupt" && groupResources[node_fault_group] != "duplicate" && groupResources[node_fault_group] != "down" && groupResources[node_fault_group] != "reboot" ) {
        if ( groupResources[node_fault_group] == "latency" ) {
          $('#faultload_configuration_FL_args_unit').html("Args (ms): ");  
        } 
        else if ( groupResources[node_fault_group] == "bottleneck" ) {
          $('#faultload_configuration_FL_args_unit').html("Args (KBits): ");
        }
        else {
          $('#faultload_configuration_FL_args_unit').html("Args (%): ");
        }
      }


      $('#faultload_configuration_FL_description').html(data_network_topology['nodes'][node_index]['description']);
      $('#faultload_configuration_FL_args').val(data_network_topology['nodes'][node_index]['args']); 

      $('#faultload_configuration_FL_args').prop("disabled", true);

      if ( groupResources[node_fault_group] != "delete" && groupResources[node_fault_group] != "loss" && groupResources[node_fault_group] != "corrupt" && groupResources[node_fault_group] != "duplicate" && groupResources[node_fault_group] != "down" && groupResources[node_fault_group] != "reboot" ) {
        $('#faultload_configuration_FL_args').prop("disabled", false);
        default_args_value = $('#faultload_configuration_FL_args').val();
      }

  
      $('#faultload_configuration_header_close').click( function () {
        $('#faultload_configuration').html("");
        d3recolor();
      });


      $('#faultload_configuration_update').click( function () {
        $('#faultload_configuration_alertArgsCheck').remove();
        //########### for loaded campaigns, tests can not be updated
        if ( LOADED && data_network_topology['nodes'][node_index]['status'] == "completed") {
          $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Completed tests can not be reconfigured. </div> ');
          return false;  
        }
        if ( LOADED && data_network_topology['nodes'][node_index]['status'] == "error") {
          $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Tests in error state can not be reconfigured. </div> ');
          return false;  
        }
        //########### 
        // 1) check fault args if the fault is latency or bottleneck
        if ( $('#faultload_configuration_FL').text() == "latency" || $('#faultload_configuration_FL').text() == "bottleneck" ) {
          var value = $('#faultload_configuration_FL_args').val();            
          if ( isNaN(value) ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a number for the fault args. </div> ');
            $('#faultload_configuration_FL_args').val(default_args_value);
            return false;
          }  
          
          if ( value <= 0 ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert positive value for the fault args. </div> ');
            $('#faultload_configuration_FL_args').val(default_args_value);
            return false;
          }
        }

        // 2) check on fault pattern args value
        if ( $('#faultload_configuration_FL_pattern_name').text() == "random" || $('#faultload_configuration_FL_pattern_name').text() == "degradation") {
          if ( isNaN($('#faultload_configuration_FL_args_pattern').val()) ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a number for the fault pattern args. </div> ');
            return false;
          }
          else if ( $('#faultload_configuration_FL_args_pattern').val() <= 0 || $('#faultload_configuration_FL_args_pattern').val() > 100 ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert value in range [0.1 , 100] for the fault pattern args. </div> ');
            return false;
          }
        }
        else if ( $('#faultload_configuration_FL_pattern_name').text() == "burst" ) {
          if ( isNaN($('#faultload_configuration_FL_args_pattern').val()) || isNaN($('#faultload_configuration_FL_args_pattern_1').val()) ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a number for the fault pattern args. </div> ');
            return false;  
          }
          else if ( $('#faultload_configuration_FL_args_pattern').val() <= 0 || $('#faultload_configuration_FL_args_pattern_1').val() <= 0 ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert positive value for the fault pattern args. </div> ');
            return false;
          }
          else if ( $('#faultload_configuration_FL_args_pattern').val() > $('#faultload_configuration_FL_args_pattern_1').val() ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Burst duration must be less or equal to burst periodicity. </div> ');
            return false;  
          }  
        }

        // 3) check on fault target (user-specified traffic)
        if ( $('#faultload_configuration_FL_target_name').text() == "User-specified traffic" ) {
                   
          if ( $('#faultload_configuration_FL_args_target_1').val().replace(/ /g,'') ) {
            //SRC Ports input is not empty...
            var ports = $('#faultload_configuration_FL_args_target_1').val().replace(/ /g,'').split(';');
            var re = /^()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$/i;
            for ( var i = 0; i < ports.length; i++ ) {
              if ( !re.test(ports[i]) || ports[i] == 0 ) {
                $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a valid list of ports (semicolon separated) for SRC ports. </div> ');
                return false;
              }
            }
          }
          
          if ( $('#faultload_configuration_FL_args_target_2').val().replace(/ /g,'') ) {
            //DST Ports input is not empty...
            var ports = $('#faultload_configuration_FL_args_target_2').val().replace(/ /g,'').split(';');
            var re = /^()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$/i;
            for ( var i = 0; i < ports.length; i++ ) {
              if ( !re.test(ports[i]) || ports[i] == 0 ) {
                $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a valid list of ports (semicolon separated) for DST ports. </div> ');
                return false;
              }
            }            
          }

        }

        data_network_topology['nodes'][node_index]['args'] = $('#faultload_configuration_FL_args').val();
        if ( $('#faultload_configuration_FL_args_pattern').val() ) {
          data_network_topology['nodes'][node_index]['fault_pattern']['args']['arg1'] = $('#faultload_configuration_FL_args_pattern').val();  
        }
        
        if ( data_network_topology['nodes'][node_index]['fault_pattern']['name'] == "burst" ) {
          data_network_topology['nodes'][node_index]['fault_pattern']['args']['arg2'] = $('#faultload_configuration_FL_args_pattern_1').val();
        }

        if ( data_network_topology['nodes'][node_index]['fault_target_traffic']['name'] == "User-specified traffic") {
          data_network_topology['nodes'][node_index]['fault_target_traffic']['args']['src_ports'] = $('#faultload_configuration_FL_args_target_1').val().replace(/ /g,'');
          data_network_topology['nodes'][node_index]['fault_target_traffic']['args']['dst_ports'] = $('#faultload_configuration_FL_args_target_2').val().replace(/ /g,'');
        }

        data_network_topology['nodes'][node_index]['status'] = "NotCompleted"

        $('#faultload_configuration').html("");
        d3recolor();
        $.d3render();
      });

      $('#faultload_configuration_remove').click ( function () {
        if ( LOADED && data_network_topology['nodes'][node_index]['status'] == "completed") {
          $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Completed tests can not be removed. </div> ');
          return false;  
        }
        if ( LOADED && data_network_topology['nodes'][node_index]['status'] == "error") {
          $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Tests in error state can not be removed. </div> ');
          return false;  
        }
        //remove correspondent fault
        data_network_topology['nodes'].splice(node_index, 1);
        //remove correspondent link
        data_link = data_network_topology['links'];
        for ( var i = 0; i < data_link.length; i++ ) {
          if ( data_link[i]['target']['index'] == node_index ) {
            data_network_topology['links'].splice(i, 1);
            break;
          }
        }
        $.d3render();
        d3recolor();
        $('#faultload_configuration').html("");
      });
    }
    else {
      /**** create faultload panel for resource ****/
      $('#faultload_configuration').append(
        '<div id="faultload_configuration_content" class="modal-dialog modal-content" style="top: 15px; width: 300px; background-color: aliceblue; border: 1px #555 solid; margin-top: 0px;">' +
          '<div class="modal-header">' +
            '<h5 class="modal-title" style="display: inline";>Fault configuration</h5>' +
            '<button id="faultload_configuration_header_close" type="button" class="close">' +
              '<span aria-hidden="true">×</span>' +
            '</button>' +
          '</div>' +
          '<div class="modal-body">' +
            
            '<div class="row">' +
              '<div class="col-sm-6" style="text-align: center">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label">' +
                    '<span class="field-label">Resource type:</span>' +
                  '</label>' +
                  '<br>' +
                  '<div id="faultload_configuration_RS">' + 
                  //insert a dropdown menu if resource is vm or router (the user can choose between port or floatingip or all)
                  '</div>' +
                '</div>' +
              '</div>' +
              '<div class="col-sm-6">' +
                '<div class="form-group" style="display: inline-block;">' +
                  '<label class="control-label">' +
                    '<span class="field-label">Fault type:</span>' +
                  '</label>' +
                  '<div id="faultload_configuration_FL_dropdown" class="dropdown">' +
                    '<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">' +
                      '<span id="faultload_configuration_FL_Label" class="dropdown-title">select fault </span>' +
                      '<span class="fa fa-caret-down"></span>' +
                    '</button>' +
                    '<ul id="faultload_configuration_FL_dropdown_menu" class="dropdown-menu">' +
                    //code generated from faultload_configuration_ajax() function
                    '</ul>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +

            '<div class="row" style="text-align: center;">' +
              '<a data-toggle="collapse" data-target="#fault_conf_details_faultload" class="collapsed">show details ' +
                '<span class="glyphicon glyphicon-chevron-down" style="font-size: small;"></span> ' +
              '</a>' +
            '</div>' +

            '<div id="fault_conf_details_faultload" class="collapse"> '+
              '<label class="control-label">' +
                '<span class="field-label">Description:</span>' +
              '</label>' +
              '<div class="panel panel-default">' +
                '<div id="faultload_configuration_FL_description" class="panel-body">' +
                '</div>' +
              '</div>' +

              '<label class="control-label">' +
                '<span id="faultload_configuration_FL_args_unit" class="field-label">N/A:</span>' +
              '</label>' +
              '<div class="form-group">' +
                '<input id="faultload_configuration_FL_args" type="text">' +
              '</div>' +
              
              '<hr>' +
              '<div class="row">' +
                '<div class="col-sm-6">' +
                  '<div class="form-group" style="display: inline-block;">' +
                    '<label class="control-label">' +
                      '<span class="field-label">Fault pattern:</span>' +
                    '</label>' +
                    '<div id="faultload_configuration_FL_dropdown_pattern" class="dropdown">' +
                      '<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false" disabled>' +
                        '<span id="faultload_configuration_FL_Label_pattern" class="dropdown-title">select pattern </span>' +
                        '<span class="fa fa-caret-down"></span>' +
                      '</button>' +
                      '<ul id="faultload_configuration_FL_dropdown_menu_pattern" class="dropdown-menu">' +
                        '<li data-original-index="0" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="persistent">persistent ' +
                            '<span class="pull-right">' +
                              '<img src={{ url_for('static', filename="fault_pattern_icon/persistent_icon.png") }} style="width: 30px;">' +
                            '</span>' +
                          '</a>' +
                        '</li>' +
                        '<li data-original-index="1" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="random">random ' +
                            '<span class="pull-right">' +
                              '<img src={{ url_for('static', filename="fault_pattern_icon/random_icon.png") }} style="width: 30px;">' +
                            '</span>' +
                          '</a>' +
                        '</li>' +
                        '<li data-original-index="2" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="burst">burst ' +
                            '<span img src={{ url_for('static', filename="fault_pattern_icon/burst_icon.png") }}</span>' +
                            '<span class="pull-right">' +
                              '<img src={{ url_for('static', filename="fault_pattern_icon/burst_icon.png") }} style="width: 30px;">' +
                            '</span>' +
                          '</a>' +
                        '</li>' +
                        '<li data-original-index="3" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="degradation">degradation ' +
                            '<span img src={{ url_for('static', filename="fault_pattern_icon/degradation_icon.png") }}</span>' +
                            '<span class="pull-right">' +
                              '<img src={{ url_for('static', filename="fault_pattern_icon/degradation_icon.png") }} style="width: 30px;">' +
                            '</span>' +
                          '</a>' +
                        '</li>' +
                      '</ul>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
              '</div>' +
              '<div id="faultload_configuration_FL_args_pattern_container">' +
              //input fields set properly after pattern selection
              '</div>' +
              

              '<hr>' +
              '<div class="row">' +
                '<div class="col-sm-6">' +
                  '<div class="form-group" style="display: inline-block;">' +
                    '<label class="control-label">' +
                      '<span class="field-label">Fault target:</span>' +
                    '</label>' +
                    '<div id="faultload_configuration_FL_dropdown_target" class="dropdown">' +
                      '<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false" disabled>' +
                        '<span id="faultload_configuration_FL_Label_target" class="dropdown-title">select target </span>' +
                        '<span class="fa fa-caret-down"></span>' +
                      '</button>' +
                      '<ul id="faultload_configuration_FL_dropdown_menu_target" class="dropdown-menu">' +
                        //'<li data-original-index="0" data-toggle="tooltip" data-placement="top">' +
                        //  '<a data-select-value="">select target </a>' +
                        //'</li>' +
                        '<li data-original-index="0" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="Any">any traffic </a>' +
                        '</li>' +
                        '<li data-original-index="1" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="HTTP">HTTP traffic </a>' +
                        '</li>' +
                        '<li data-original-index="1" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="DNS">DNS traffic </a>' +
                        '</li>' +
                        '<li data-original-index="1" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="DHCP">DHCP traffic </a>' +
                        '</li>' +
                        '<li data-original-index="2" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="MySQL">MySQL traffic </a>' +
                        '</li>' +
                        '<li data-original-index="3" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="Memcached">Memcached traffic </a>' +
                        '</li>' +
                        '<li data-original-index="4" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="MongoDB">MongoDB traffic </a>' +
                        '</li>' +
                        '<li data-original-index="5" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="MongoDB">Cassandra traffic </a>' +
                        '</li>' +
                        '<li data-original-index="6" data-toggle="tooltip" data-placement="top">' +
                          '<a data-select-value="user_specified_traffic">User-specified traffic </a>' +
                        '</li>' +
                      '</ul>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
              '</div>' +
              '<div id="faultload_configuration_FL_args_target_container">' +
              //input fields set properly after target selection
              '</div>' +

            '</div>' +
            '<div id="faultload_configuration_alertArgs">' +
            '</div>' +
            
          '</div>' +
          '<div class="modal-footer" style="margin-top: 0px;">'+
            '<button id="faultload_configuration_add" type="button" class="btn btn-primary">Add</button>' +
          '</div>' +
        '</div>'
      );

      $('#faultload_configuration_FL_dropdown_menu_pattern li a').click( function () {
        if ($('#faultload_configuration_FL_Label_pattern').text() !== $(this).text()) {
          $('#faultload_configuration_FL_Label_pattern').html($(this).html());
          $('#faultload_configuration_FL_Label_pattern span').toggleClass();
        }

        if ($('#faultload_configuration_FL_Label_pattern').text() !== "select pattern ") {
          //TODO: append pattern args properly
          $('#faultload_configuration_FL_args_pattern_container').html("");
          //random pattern
          if ( $('#faultload_configuration_FL_Label_pattern').text() == "random " ) {
            $('#faultload_configuration_FL_args_pattern_container').append(
                '<label class="control-label">' +
                  '<span id="faultload_configuration_FL_args_pattern_unit" class="field-label">Probability of faulty packet (%):</span>' +
                '</label>' +
                '<div class="form-group">' +
                  '<input id="faultload_configuration_FL_args_pattern" type="text" value="10" placeholder="Insert percentage">' +
                '</div>'
              );  
          }
          else if ( $('#faultload_configuration_FL_Label_pattern').text() == "persistent " ) {
            $('#faultload_configuration_FL_args_pattern_container').append(
                '<label class="control-label">' +
                  '<span id="faultload_configuration_FL_args_pattern_unit" class="field-label">N/A</span>' +
                '</label>' +
                '<div class="form-group">' +
                  '<input id="faultload_configuration_FL_args_pattern" type="text" disabled>' +
                '</div>'
              );  
          }
          else if ( $('#faultload_configuration_FL_Label_pattern').text() == "burst " ) {
            $('#faultload_configuration_FL_args_pattern_container').append(
                '<label class="control-label">' +
                  '<span id="faultload_configuration_FL_args_pattern_unit" class="field-label">Burst duration (ms):</span>' +
                '</label>' +
                '<div class="form-group">' +
                  '<input id="faultload_configuration_FL_args_pattern" type="text" value="10" placeholder="Insert duration">' +
                '</div>' +
                '<label class="control-label">' +
                  '<span id="faultload_configuration_FL_args_pattern_1_unit" class="field-label">Burst periodicity (ms):</span>' +
                '</label>' +
                '<div class="form-group">' +
                  '<input id="faultload_configuration_FL_args_pattern_1" type="text" value="10" placeholder="Insert periodicity">' +
                '</div>'
              );  
          }
          else if ( $('#faultload_configuration_FL_Label_pattern').text() == "degradation " ) {
            $('#faultload_configuration_FL_args_pattern_container').append(
                '<label class="control-label">' +
                  '<span id="faultload_configuration_FL_args_pattern_unit" class="field-label">Rate of packet degradation (%):</span>' +
                '</label>' +
                '<div class="form-group">' +
                  '<input id="faultload_configuration_FL_args_pattern" type="text"  value="10" placeholder="Insert degradation rate">' +
                '</div>'
              );  
          }  
        }
        else {
          $('#faultload_configuration_FL_args_pattern_container').html("");
        }
      });


      $('#faultload_configuration_FL_dropdown_menu_target li a').click( function () {
        if ($('#faultload_configuration_FL_Label_target').text() !== $(this).text()) {
          $('#faultload_configuration_FL_Label_target').html($(this).html());
        }

        if ($('#faultload_configuration_FL_Label_target').text() !== "select target " && $('#faultload_configuration_FL_Label_target').text() !== "User-specified traffic ") {
          //TODO: append target args properly
          $('#faultload_configuration_FL_args_target_container').html("");
          $('#faultload_configuration_FL_args_target_container').append(
              '<label class="control-label">' +
                '<span id="faultload_configuration_FL_args_taget_unit" class="field-label">Protocol:</span>' +
              '</label>' +
              '<div class="form-group">' +
                '<input id="faultload_configuration_FL_args_target" type="text" disabled placeholder="empty">' +
              '</div>' +
              '<label class="control-label">' +
                '<span id="faultload_configuration_FL_args_taget_1_unit" class="field-label">SRC Ports:</span>' +
              '</label>' +
              '<div class="form-group">' +
                '<input id="faultload_configuration_FL_args_target_1" type="text" disabled placeholder="empty">' +
              '</div>' +
              '<label class="control-label">' +
                '<span id="faultload_configuration_FL_args_taget_2_unit" class="field-label">DST Ports:</span>' +
              '</label>' +
              '<div class="form-group">' +
                '<input id="faultload_configuration_FL_args_target_2" type="text" disabled placeholder="empty">' +
              '</div>'
            );
          if ( $('#faultload_configuration_FL_Label_target').text() == "any traffic " ) {
            $('#faultload_configuration_FL_args_target').val("");
            $('#faultload_configuration_FL_args_target_1').val("");
            $('#faultload_configuration_FL_args_target_2').val("");
          }
          else if ( $('#faultload_configuration_FL_Label_target').text() == "HTTP traffic " ) {
            $('#faultload_configuration_FL_args_target').val("TCP");
            $('#faultload_configuration_FL_args_target_1').val("");
            $('#faultload_configuration_FL_args_target_2').val("80;8080;443"); 
          }
          else if ( $('#faultload_configuration_FL_Label_target').text() == "DNS traffic " ) {
            $('#faultload_configuration_FL_args_target').val("UDP");
            $('#faultload_configuration_FL_args_target_1').val("");
            $('#faultload_configuration_FL_args_target_2').val("53"); 
          }
          else if ( $('#faultload_configuration_FL_Label_target').text() == "DHCP traffic " ) {
            $('#faultload_configuration_FL_args_target').val("UDP");
            $('#faultload_configuration_FL_args_target_1').val("");
            $('#faultload_configuration_FL_args_target_2').val("67;68"); 
          }
          else if ( $('#faultload_configuration_FL_Label_target').text() == "MySQL traffic " ) {
            $('#faultload_configuration_FL_args_target').val("TCP");
            $('#faultload_configuration_FL_args_target_1').val("");
            $('#faultload_configuration_FL_args_target_2').val("3306");
          }
          else if ( $('#faultload_configuration_FL_Label_target').text() == "Memcached traffic " ) {
            $('#faultload_configuration_FL_args_target').val("TCP");
            $('#faultload_configuration_FL_args_target_1').val("");
            $('#faultload_configuration_FL_args_target_2').val("11211");
          }
          else if ( $('#faultload_configuration_FL_Label_target').text() == "MongoDB traffic " ) {
            $('#faultload_configuration_FL_args_target').val("TCP");
            $('#faultload_configuration_FL_args_target_1').val("");
            $('#faultload_configuration_FL_args_target_2').val("27017;27018;27019");
          }
          else if ( $('#faultload_configuration_FL_Label_target').text() == "Cassandra traffic " ) {
            $('#faultload_configuration_FL_args_target').val("TCP");
            $('#faultload_configuration_FL_args_target_1').val("");
            $('#faultload_configuration_FL_args_target_2').val("7000;7001;9042");
          }
        }

        else if ($('#faultload_configuration_FL_Label_target').text() == "User-specified traffic ") {
          $('#faultload_configuration_FL_args_target_container').html("");
          $('#faultload_configuration_FL_args_target_container').append(
              '<label class="control-label">' +
                '<span id="faultload_configuration_FL_args_taget_unit" class="field-label">Protocol:</span>' +
              '</label>' +
              '<div id="faultload_configuration_FL_dropdown_target_protocol" class="dropdown">' +
                '<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false" style = "margin-bottom: 15px;">' +
                  '<span id="faultload_configuration_FL_args_target" class="dropdown-title">select target protocol </span>' +
                  '<span class="fa fa-caret-down"></span>' +
                '</button>' +
                '<ul id="faultload_configuration_FL_dropdown_menu_target_protocol" class="dropdown-menu">' +
                  '<li data-original-index="0" data-toggle="tooltip" data-placement="top">' +
                    '<a data-select-value="">select target protocol </a>' +
                  '</li>' +
                  '<li data-original-index="1" data-toggle="tooltip" data-placement="top">' +
                    '<a data-select-value="target_protocol_ICMP">ICMP </a>' +
                  '</li>' +
                  '<li data-original-index="2" data-toggle="tooltip" data-placement="top">' +
                    '<a data-select-value="target_protocol_IGMP">IGMP </a>' +
                  '</li>' +
                  '<li data-original-index="3" data-toggle="tooltip" data-placement="top">' +
                    '<a data-select-value="target_protocol_IP">IP </a>' +
                  '</li>' +
                  '<li data-original-index="4" data-toggle="tooltip" data-placement="top">' +
                    '<a data-select-value="target_protocol_TCP">TCP </a>' +
                  '</li>' +
                  '<li data-original-index="5" data-toggle="tooltip" data-placement="top">' +
                    '<a data-select-value="target_protocol_UDP">UDP </a>' +
                  '</li>' +
                  '<li data-original-index="6" data-toggle="tooltip" data-placement="top">' +
                    '<a data-select-value="target_protocol_IPv6">IPv6 </a>' +
                  '</li>' +
                  '<li data-original-index="7" data-toggle="tooltip" data-placement="top">' +
                    '<a data-select-value="target_protocol_IPv6-ICMP">IPv6-ICMP </a>' +
                  '</li>' +
                '</ul>' +
              '</div>' +
              '<label class="control-label">' +
                '<span id="faultload_configuration_FL_args_taget_1_unit" class="field-label">SRC Ports:</span>' +
              '</label>' +
              '<div class="form-group">' +
                '<input id="faultload_configuration_FL_args_target_1" type="text" placeholder="Insert src ports" value="" disabled>' +
              '</div>' +
              '<label class="control-label">' +
                '<span id="faultload_configuration_FL_args_taget_2_unit" class="field-label">DST Ports:</span>' +
              '</label>' +
              '<div class="form-group">' +
                '<input id="faultload_configuration_FL_args_target_2" type="text" placeholder="Insert dst ports" value=""disabled>' +
              '</div>'
            );

          $('#faultload_configuration_FL_dropdown_menu_target_protocol li a').click ( function () {
            if ($('#faultload_configuration_FL_args_target').text() !== $(this).text()) {
              $('#faultload_configuration_FL_args_target').html($(this).html());
            }

            if ($('#faultload_configuration_FL_args_target').text() !== "select target protocol "){
              $('#faultload_configuration_FL_args_target_1').val("");
              $('#faultload_configuration_FL_args_target_1').prop('disabled', false);
              $('#faultload_configuration_FL_args_target_2').val("");
              $('#faultload_configuration_FL_args_target_2').prop('disabled', false);
            }
            else {
              $('#faultload_configuration_FL_args_target_1').val("");
              $('#faultload_configuration_FL_args_target_1').prop('disabled', true);
              $('#faultload_configuration_FL_args_target_2').val("");
              $('#faultload_configuration_FL_args_target_2').prop('disabled', true);
            }

          });
        }
        else {
          $('#faultload_configuration_FL_args_target_container').html("");
        }
      });


      $('#faultload_configuration_FL_args').prop("disabled", true);
      $('#faultload_configuration_FL_dropdown_pattern li a:first').click();
      $('#faultload_configuration_FL_dropdown_target li a:first').click();

      if ( groupResources[d.group] == "vm" || groupResources[d.group] == "router" || groupResources[d.group] == "switch" || groupResources[d.group] == "vmPhysical" ) {
        $('#faultload_configuration_FL_dropdown button').prop("disabled", true);
          // append dropdown if the resources has ports or floatingip. Append "all" for select all ports.
        $('#faultload_configuration_RS').append(
          '<div id="faultload_configuration_RS_dropdown" class="dropdown">' +
            '<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">' +
              '<span id="faultload_configuration_RS_Label" class="dropdown-title">select resource </span>' +
              '<span class="fa fa-caret-down"></span>' +
            '</button>' +
            '<ul id="faultload_configuration_RS_dropdown_menu" class="dropdown-menu">' +
            //code generated from faultload_configuration_RS_function() function
            '</ul>' +
          '</div>'
        );
        faultload_configuration_RS_dropdown_menu();

              function faultload_configuration_RS_dropdown_menu() {
                $('#faultload_configuration_RS_dropdown_menu').html("")
      
                $('#faultload_configuration_RS_dropdown_menu').append(
                  '<li data-original-index="0" data-toggle="tooltip" data-placement="top">'+
                    '<a data-select-value="">select resource </a>'+
                  '</li>'
                  );

                if ( groupResources[d.group] == "router" ) {
                  $('#faultload_configuration_RS_dropdown_menu').append(
                    '<li data-original-index="1" data-toggle="tooltip" data-placement="top">'+
                      '<a data-select-value="'+ data_network_topology['nodes'][node_index]['ID'] +'">'+ groupResources[d.group] +' </a>' +
                    '</li>'
                  );
                }

                if ( groupResources[d.group] == "switch" ) {
                  $('#faultload_configuration_RS_dropdown_menu').append(
                    '<li data-original-index="1" data-toggle="tooltip" data-placement="top">'+
                      '<a data-select-value="'+ data_network_topology['nodes'][node_index]['ID'] +'">'+ groupResources[d.group] +' </a>' +
                    '</li>'
                  );  
                }

                if ( groupResources[d.group] == "vmPhysical" ) {
                  $('#faultload_configuration_RS_dropdown_menu').append(
                    '<li data-original-index="1" data-toggle="tooltip" data-placement="top">'+
                      '<a data-select-value="'+ data_network_topology['nodes'][node_index]['ID'] +'">node </a>' +
                    '</li>'
                  );  
                }                

                for ( var i = 0; i < data_network_topology['nodes'][node_index]['fault_target'].length; i++) {
                  $('#faultload_configuration_RS_dropdown_menu').append(
                    '<li data-original-index="'+ i+2 +'" data-toggle="tooltip" data-placement="top">'+
                      '<a data-select-value="'+ data_network_topology['nodes'][node_index]['fault_target'][i]['value']+'">'+ data_network_topology['nodes'][node_index]['fault_target'][i]['subtarget'] +': <br>'+data_network_topology['nodes'][node_index]['fault_target'][i]['name'] +' </a>'+
                    '</li>'
                  );
                }
              }

        $('#faultload_configuration_RS_dropdown_menu li a').click( function () {
          //on change faultload_configuration_RS_Label content
          if ($('#faultload_configuration_RS_Label').text() !== $(this).text()){
            $('#faultload_configuration_RS_Label').html($(this).html());  
          }

          if ($('#faultload_configuration_RS_Label').text() !== "select resource ") {
            $('#faultload_configuration_FL_dropdown li a:first').click();
            $('#faultload_configuration_FL_dropdown button').prop("disabled", false);
            if ( $('#faultload_configuration_FL_Label').text() !== "select fault " && $('#faultload_configuration_FL_Label').text() !== "delete " && $('#faultload_configuration_FL_Label').text() !== "loss " && $('#faultload_configuration_FL_Label').text() !== "corrupt " && $('#faultload_configuration_FL_Label').text() !== "duplicate " && $('#faultload_configuration_FL_Label').text() !== "down " && $('#faultload_configuration_FL_Label').text() !== "reboot " ) {
              $('#faultload_configuration_FL_dropdown_pattern button').prop("disabled", false);
              $('#faultload_configuration_FL_dropdown_target button').prop("disabled", false);
            }
            resource_faultload_configuration_ajax['resource_type'] = $('#faultload_configuration_RS_Label').text().replace(/ /g,'').split(':')[0];
            resource_faultload_configuration_ajax['resource_faultID'] = $(this)[0].attributes[0].value;
            if ($('#faultload_configuration_RS_Label').text().slice(0,-1) == "router" || $('#faultload_configuration_RS_Label').text().slice(0,-1) == "node" || $('#faultload_configuration_RS_Label').text().slice(0,-1) == "switch") {
              resource_faultload_configuration_ajax['resource_name'] = data_network_topology['nodes'][node_index]['name'];   
            }
            else {
              resource_faultload_configuration_ajax['resource_name'] = $('#faultload_configuration_RS_Label').text().replace(/ /g,'').split(':')[1];  
            }
          }
          else {
            $('#faultload_configuration_FL_dropdown li a:first').click();
            $('#faultload_configuration_FL_dropdown button').prop("disabled", true);
            $('#faultload_configuration_FL_dropdown_pattern li a:first').click();
            $('#faultload_configuration_FL_dropdown_pattern button').prop("disabled", true);
            $('#faultload_configuration_FL_dropdown_target li a:first').click();
            $('#faultload_configuration_FL_dropdown_target button').prop("disabled", true);
          }
        });

      } 
      else 
      {
        //append text with target type
        $('#faultload_configuration_RS').append(
          '<text>' + groupResources[d.group] + '</text>'
        );
        resource_faultload_configuration_ajax['resource_type'] = $('#faultload_configuration_RS').text();
        resource_faultload_configuration_ajax['resource_name'] = data_network_topology['nodes'][node_index]['name'];
        resource_faultload_configuration_ajax['resource_faultID'] = data_network_topology['nodes'][node_index]['ID'];
      }

      $('#faultload_configuration_FL_dropdown').on('show.bs.dropdown', function () {
        faultload_configuration_ajax(resource_faultload_configuration_ajax);
      });

      var default_args_value = null;
      $('#faultload_configuration_FL_dropdown').on('hidden.bs.dropdown', function () {
        default_args_value = $('#faultload_configuration_FL_args').val();
        console.log("default_args_value: %s", default_args_value);
      } )

      $('#faultload_configuration_header_close').click( function () {
        $('#faultload_configuration').html("");
        d3recolor();
      });


      $('#faultload_configuration_add').click( function () {
        $('#faultload_configuration_alertArgsCheck').remove();

        // 1) check on select resource
        if ( groupResources[d.group] == "vm" || groupResources[d.group] == "router" || groupResources[d.group] == "vmPhysical" || groupResources[d.group] == "switch" ) {
          if ($('#faultload_configuration_RS_Label').text() == "select resource ") {
            console.log("ERROR: Selecta a resource.");
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Select a resource. </div> ');
            return false;
          }
        }

        // 2) check on select fault
        if ( $('#faultload_configuration_FL_Label').text() == "select fault " ) {
          console.log("ERROR: Selecta a fault for resource: %s.", resource_faultload_configuration_ajax['resource_type']);
          $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Select a fault. </div> ');
          return false;
        }
        // 3) check on fault args value
        else {
          var value = $('#faultload_configuration_FL_args').val();
          var fault = $('#faultload_configuration_FL_Label').text().slice(0,-1);
          if ( fault != "delete" && fault != "loss" && fault != "corrupt" && fault != "duplicate" && fault != "down" && fault != "reboot" ) {
            
            if ( isNaN(value) ) {
              $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a number for the fault args. </div> ');
              $('#faultload_configuration_FL_args').val(default_args_value);
              return false;
            }  
            
            if ( value <= 0 ) {
              $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert positive value for the fault args. </div> ');
              $('#faultload_configuration_FL_args').val(default_args_value);
              return false;
            }
          }
        }

        // 4) check on fault pattern args value
        if ( $('#faultload_configuration_FL_Label_pattern').text() == "random " || $('#faultload_configuration_FL_Label_pattern').text() == "degradation ") {
          if ( isNaN($('#faultload_configuration_FL_args_pattern').val()) ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a number for the fault pattern args. </div> ');
            return false;
          }
          else if ( $('#faultload_configuration_FL_args_pattern').val() <= 0 || $('#faultload_configuration_FL_args_pattern').val() > 100 ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert value in range [0.1 , 100] for the fault pattern args. </div> ');
            return false;
          }
        }
        else if ( $('#faultload_configuration_FL_Label_pattern').text() == "burst " ) {
          if ( isNaN($('#faultload_configuration_FL_args_pattern').val()) || isNaN($('#faultload_configuration_FL_args_pattern_1').val()) ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a number for the fault pattern args. </div> ');
            return false;  
          }
          else if ( $('#faultload_configuration_FL_args_pattern').val() <= 0 || $('#faultload_configuration_FL_args_pattern_1').val() <= 0 ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert positive value for the fault pattern args. </div> ');
            return false;
          }
          else if ( $('#faultload_configuration_FL_args_pattern').val() > $('#faultload_configuration_FL_args_pattern_1').val() ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Burst duration must be less or equal to burst periodicity. </div> ');
            return false;  
          } 
        }

        // 5) check on fault target (user-specified traffic)
        if ( $('#faultload_configuration_FL_Label_target').text() == "User-specified traffic " ) {
          
          if ( $('#faultload_configuration_FL_args_target').text() == "select target protocol " ) {
            $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Select a target protocol. </div> ');
            return false;
          }
          
          if ( $('#faultload_configuration_FL_args_target_1').val().replace(/ /g,'') ) {
            //SRC Ports input is not empty...
            var ports = $('#faultload_configuration_FL_args_target_1').val().replace(/ /g,'').split(';');
            var re = /^()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$/i;
            for ( var i = 0; i < ports.length; i++ ) {
              if ( !re.test(ports[i]) || ports[i] == 0 ) {
                $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a valid list of ports (semicolon separated) for SRC ports. </div> ');
                return false;
              }
            }
          }
          
          if ( $('#faultload_configuration_FL_args_target_2').val().replace(/ /g,'') ) {
            //DST Ports input is not empty...
            var ports = $('#faultload_configuration_FL_args_target_2').val().replace(/ /g,'').split(';');
            var re = /^()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$/i;
            for ( var i = 0; i < ports.length; i++ ) {
              if ( !re.test(ports[i]) || ports[i] == 0 ) {
                $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">Insert a valid list of ports (semicolon separated) for DST ports. </div> ');
                return false;
              }
            }            
          }

        }
        //$('#faultload_configuration_alertArgs').html("");

        new_node = {};
        new_node['group'] = faultDict[$('#faultload_configuration_FL_Label').text().slice(0,-1)];
        new_node['name'] = groupResources[faultDict[$('#faultload_configuration_FL_Label').text().slice(0,-1)]];
        new_node['type'] = "fault";
        new_node['fault_target'] = {}
        new_node['fault_target']['resource_type'] = resource_faultload_configuration_ajax['resource_type'];
        new_node['fault_target']['resource_name'] = resource_faultload_configuration_ajax['resource_name'];
        new_node['fault_target']['resource_faultID'] = resource_faultload_configuration_ajax['resource_faultID'];
        new_node['args'] = $('#faultload_configuration_FL_args').val();
        new_node['description'] = $('#faultload_configuration_FL_description').text();
        
        //added with new faul configuration
        new_node['fault_pattern'] = {}
        new_node['fault_pattern']['name'] = $('#faultload_configuration_FL_Label_pattern').text().slice(0,-1);
        new_node['fault_pattern']['args'] = {}
        new_node['fault_pattern']['args']['arg1'] = $('#faultload_configuration_FL_args_pattern').val();
        if ( new_node['fault_pattern']['name'] == "burst") {
          new_node['fault_pattern']['args']['arg2'] = $('#faultload_configuration_FL_args_pattern_1').val();
        }
        else {
          new_node['fault_pattern']['args']['arg2'] = "";
        }

        new_node['fault_target_traffic'] = {}
        new_node['fault_target_traffic']['name'] = $('#faultload_configuration_FL_Label_target').text().slice(0,-1);
        new_node['fault_target_traffic']['args'] = {}
        if ( new_node['fault_target_traffic']['name'] == "User-specified traffic" ) {
          new_node['fault_target_traffic']['args']['protocol'] = $('#faultload_configuration_FL_args_target').text().slice(0,-1);  
        }
        else
        {
          new_node['fault_target_traffic']['args']['protocol'] = $('#faultload_configuration_FL_args_target').val();  
        }
        
        if ( $('#faultload_configuration_FL_args_target_1').val() ) {
          new_node['fault_target_traffic']['args']['src_ports'] = $('#faultload_configuration_FL_args_target_1').val().replace(/ /g,'');
        } 
        else {
          new_node['fault_target_traffic']['args']['src_ports'] = $('#faultload_configuration_FL_args_target_1').val();
        }

        if ( $('#faultload_configuration_FL_args_target_2').val() ) {
          new_node['fault_target_traffic']['args']['dst_ports'] = $('#faultload_configuration_FL_args_target_2').val().replace(/ /g,'');
        }
        else { 
          new_node['fault_target_traffic']['args']['dst_ports'] = $('#faultload_configuration_FL_args_target_2').val(); 
        }

        new_node['status'] = "NotCompleted"

        new_link = {}
        new_link['source'] = node_index;
        new_link['target'] = data_network_topology['nodes']["length"];
        new_link['value'] = 0;
        new_link['distance'] = 20;

        var found = false;
        for ( var i = 0; i < data_network_topology['nodes']["length"]; i++ ) {
          if ( data_network_topology['nodes'][i]['type'] == "fault" ) {
            if ( data_network_topology['nodes'][i]['name'] == new_node['name'] && 
                  data_network_topology['nodes'][i]['args'] == new_node['args'] &&
                  data_network_topology['nodes'][i]['fault_target']['resource_faultID'] == new_node['fault_target']['resource_faultID'] && data_network_topology['nodes'][i]['fault_pattern']['name'] == new_node['fault_pattern']['name'] && data_network_topology['nodes'][i]['fault_pattern']['args']['arg1'] == new_node['fault_pattern']['args']['arg1'] && data_network_topology['nodes'][i]['fault_pattern']['args']['arg2'] == new_node['fault_pattern']['args']['arg2'] && data_network_topology['nodes'][i]['fault_target_traffic']['name'] ==  new_node['fault_target_traffic']['name'] && data_network_topology['nodes'][i]['fault_target_traffic']['args']['protocol'] ==  new_node['fault_target_traffic']['args']['protocol'] && data_network_topology['nodes'][i]['fault_target_traffic']['args']['src_ports'] ==  new_node['fault_target_traffic']['args']['src_ports'] && data_network_topology['nodes'][i]['fault_target_traffic']['args']['dst_ports'] ==  new_node['fault_target_traffic']['args']['dst_ports'] ) {
              found = true;
              break;
            }
          }
        }

        if (!found) {
          data_network_topology['nodes'].push(new_node);
          data_network_topology['links'].push(new_link);

          $('#faultload_configuration').html("");
          $.d3render();
          d3recolor();

          //check undefined nodes
          for ( var i = 0; i < data_network_topology['nodes']['length']; i++ ) {
            if ( data_network_topology['nodes'][i]['type'] == "fault" ) {
              if ( data_network_topology['nodes'][i]['name'] != "delete" && data_network_topology['nodes'][i]['name'] != "loss" && data_network_topology['nodes'][i]['name'] != "corrupt" && data_network_topology['nodes'][i]['name'] != "duplicate" && data_network_topology['nodes'][i]['name'] != "down" && data_network_topology['nodes'][i]['name'] != "reboot" && !data_network_topology['nodes'][i]['args'] ) {
                console.log("Found undefined node...removing it...");
                data_network_topology['nodes'].splice(i, 1);
                for ( var j = 0; j < data_network_topology['links']['length']; j++ ) {
                  if ( data_network_topology['links'][j]['target']['index'] == i ) {
                    data_network_topology['links'].splice(j, 1);
                    break;
                  }
                }
                $.d3render();
              }
            }
          }
        }
        else {
          $('#faultload_configuration_alertArgs').append('<div id="faultload_configuration_alertArgsCheck" class="alert alert-danger" role="alert" style="margin-bottom: 0px;">This fault already exist !</div> ');  
        }
        
      });
    }

    //event on show/hide details in "Test plan configuration"
    $('#fault_conf_details_faultload').on('show.bs.collapse', function () {
      $('#faultload_configuration_content > div.modal-body > div:nth-child(2) > a').html('hide details <span class="glyphicon glyphicon-chevron-up" style="font-size: small;"></span>');
    });

    $('#fault_conf_details_faultload').on('hide.bs.collapse', function () {
      $('#faultload_configuration_content > div.modal-body > div:nth-child(2) > a').html('show details <span class="glyphicon glyphicon-chevron-down" style="font-size: small;"></span>');
    });
  }

  var resource_faultload_configuration_ajax = {};
  function faultload_configuration_ajax(resource) {
    if ( resource['resource_type'] == "private_network" || resource['resource_type'] == "public_network" ) { 
      resource['resource_type'] = "network";
    } 

    $.ajax({
      method: "GET",
      url:    "{{ url_for('netcast.getFaultLibrary') }}",
      beforeSend: function () {
          $('#faultload_configuration_FL_dropdown_menu').html('<li><a style="pointer-events:none;cursor:default;"><span class="fa fa-spinner fa-spin" style="font-size:16px;color:#000000;"></span><b> Loading...</b></a></li>');
      },
      success: function(response) {
          __fault_library = JSON.parse(response);
          
          fault_library = __fault_library[0]['children'];

          $('#faultload_configuration_FL_dropdown_menu').html("")
          
          $('#faultload_configuration_FL_dropdown_menu').append(
              '<li data-original-index="0" data-toggle="tooltip" data-placement="top">'+
                '<a data-select-value="">select fault </a>'+
              '</li>'
          );
          
          var target_faults = null;
          var selected_fault = null;
          for ( var i = 0; i < fault_library.length; i ++ ) {
            if ( fault_library[i]['title'] == resource['resource_type'] ) {
              target_faults = fault_library[i]['children'];
              break;
            }
          }
          
          for ( var i = 0; i < target_faults.length; i++ ) {
            if ( resource['resource_type'] == "network" ) {
              if ( $('#faultload_configuration_RS').text() == "public_network" ) {
                if ( target_faults[i]['title'] != "delete" ) {
                  $('#faultload_configuration_FL_dropdown_menu').append(
                    '<li data-original-index="'+ i+1 +'" data-toggle="tooltip" data-placement="top">'+
                    '<a data-select-value="'+ target_faults[i]['title'] +'">'+ target_faults[i]['title'] +' </a>'+
                    '</li>'
                  );
                }
              }
              else {
                $('#faultload_configuration_FL_dropdown_menu').append(
                  '<li data-original-index="'+ i+1 +'" data-toggle="tooltip" data-placement="top">'+
                  '<a data-select-value="'+ target_faults[i]['title'] +'">'+ target_faults[i]['title'] +' </a>'+
                  '</li>'
                );
              }
            }
            else {
              $('#faultload_configuration_FL_dropdown_menu').append(
                '<li data-original-index="'+ i+1 +'" data-toggle="tooltip" data-placement="top">'+
                  '<a data-select-value="'+ target_faults[i]['title'] +'">'+ target_faults[i]['title'] +' </a>'+
                '</li>'
              );
            }  
          }

          //var default_args_value = null;
          $('#faultload_configuration_FL_dropdown_menu li a').click( function () {
            //on change aultload_configuration_FL_Label content
            if ($('#faultload_configuration_FL_Label').text() !== $(this).text()){
              $('#faultload_configuration_FL_Label').text($(this).text());  
              $('#faultload_configuration_FL_description').html("");
              $('#faultload_configuration_FL_args').val("");
              $('#faultload_configuration_alertArgsCheck').remove();
            }

            if ($('#faultload_configuration_FL_Label').text() !== "select fault ") {
              
              if ( $('#faultload_configuration_FL_Label').text().slice(0,-1) != "delete" && $('#faultload_configuration_FL_Label').text().slice(0,-1) != "loss"  && $('#faultload_configuration_FL_Label').text().slice(0,-1) != "corrupt" && $('#faultload_configuration_FL_Label').text().slice(0,-1) != "duplicate" && $('#faultload_configuration_FL_Label').text().slice(0,-1) != "down" && $('#faultload_configuration_FL_Label').text().slice(0,-1) != "reboot" ) {
                if ( $('#faultload_configuration_FL_Label').text().slice(0,-1) == "latency" ) {
                  $('#faultload_configuration_FL_args_unit').html("Args (ms): ");  
                } 
                else if ( $('#faultload_configuration_FL_Label').text().slice(0,-1) == "bottleneck" ) {
                  $('#faultload_configuration_FL_args_unit').html("Args (KBits): ");
                }
                else {
                  $('#faultload_configuration_FL_args_unit').html("Args (%): "); 
                }
              }

              for ( var i = 0; i < target_faults.length; i++ ) {
                if ( target_faults[i]['title'] == $('#faultload_configuration_FL_Label').text().slice(0,-1) ) {
                  selected_fault = target_faults[i];
                  break;
                }
              }
              $('#faultload_configuration_FL_description').html(selected_fault['description']);
              $('#faultload_configuration_FL_args').val(selected_fault['args']);
              //default_args_value = selected_fault['args'];

              if ( $('#faultload_configuration_FL_Label').text() == "delete " || $('#faultload_configuration_FL_Label').text() == "down " || $('#faultload_configuration_FL_Label').text() == "reboot " ) {
                $('#faultload_configuration_FL_args').prop("disabled", true);
                $('#faultload_configuration_FL_args_unit').html("N/A");
                $('#faultload_configuration_FL_dropdown_pattern li a:first').click();
                $('#faultload_configuration_FL_dropdown_pattern button').prop("disabled", true);
                $('#faultload_configuration_FL_dropdown_target li a:first').click();
                $('#faultload_configuration_FL_dropdown_target button').prop("disabled", true);
              } 
              else if ( $('#faultload_configuration_FL_Label').text() == "loss " || $('#faultload_configuration_FL_Label').text() == "corrupt " || $('#faultload_configuration_FL_Label').text() == "duplicate " ) {
                $('#faultload_configuration_FL_args').prop("disabled", true);
                $('#faultload_configuration_FL_args_unit').html("N/A:");
                $('#faultload_configuration_FL_dropdown_pattern li a:first').click();
                $('#faultload_configuration_FL_dropdown_target li a:first').click();
                $('#faultload_configuration_FL_dropdown_pattern button').prop("disabled", false);
                $('#faultload_configuration_FL_dropdown_target button').prop("disabled", false);
              }
              else {
                $('#faultload_configuration_FL_args').prop("disabled", false);
                //$('#faultload_configuration_FL_args_unit').html("Configuration:");
                $('#faultload_configuration_FL_dropdown_pattern button').prop("disabled", false);
                $('#faultload_configuration_FL_dropdown_target button').prop("disabled", false);
              }
            } 
            else {
              $('#faultload_configuration_FL_args').prop("disabled", true);
              $('#faultload_configuration_FL_args_unit').html("N/A:");
              $('#faultload_configuration_FL_dropdown_pattern li a:first').click();
              $('#faultload_configuration_FL_dropdown_pattern button').prop("disabled", true);
              $('#faultload_configuration_FL_dropdown_target li a:first').click();
              $('#faultload_configuration_FL_dropdown_target button').prop("disabled", true);
            }
          });
          
      },

      statusCode: {
        500:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        400:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        404: function (response) { alert('File *NetCAST_fault_library.json* not found.'); location.reload();},
        0:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      }
    });
  }


/*
  var link = svg.selectAll(".link"),
      node = svg.selectAll(".node");
*/

  jQuery.d3render = function d3render() {
    

    my_node = data_network_topology['nodes'];
    my_link = data_network_topology['links'];

    force.nodes(my_node)
          .links(my_link)
          .linkDistance(d => d.distance)
          .start();

    var link = zoomContainer.selectAll(".link").remove();

    var link = zoomContainer.selectAll(".link").data(my_link);

    link.enter().append("line")
        .attr("class", "link")
        .style("stroke-width", function(d) { return Math.sqrt(d.value); });

    link.exit().remove();

    var node = zoomContainer.selectAll(".node").remove();
    var node = zoomContainer.selectAll(".node").data(my_node);

    var nodeEnter = node.enter().append("g")
        .attr("class", "node")
        .call(drag)
        .on("click", handleEditClickNode);

    nodeEnter.append("circle")
        .attr({ r : function(d) { return groupCircleSize[d.group] * 1.5 }})
        .attr("cx", 0)
        .attr("cy", 0)
        .style("fill", "orange")
        .style("opacity", 0);

    nodeEnter.append("circle")
        .attr("r", function(d) { return groupCircleSize[d.group] })
        .attr("cx", 0)
        .attr("cy", 0)
        .style("fill", function(d) { return groupCircleColor[d.group] });

    nodeEnter.append("png:image")
        .attr("xlink:href", function(d) { return groupLogo[d.group] })     
        .attr("x", function(d) { return groupLogoXY[d.group] })
        .attr("y", function(d) { return groupLogoXY[d.group] })
        .attr("width", function(d) { return groupLogoSize[d.group] })
        .attr("height", function(d) { return groupLogoSize[d.group] });

    nodeEnter.append("text")
        .attr("dx", +22)
        .attr("dy", +5)
        .text(function(d) { return d.name });

    nodeEnter.append("png:image")
        .attr("xlink:href", function(d, i) { 
          if ( data_network_topology['nodes'][i]['type'] == "fault" )
            return statusNodeIcon[ data_network_topology['nodes'][i]['status'] ];
          else
            return null;
          })     
        .attr("x", function(d) { return groupLogoXY[d.group] + 15 })
        .attr("y", function(d) { return groupLogoXY[d.group] - 15 })
        .attr("width", function(d) { return 12 })
        .attr("height", function(d) { return 12 });


    node.exit().remove();

    force.on("tick", function() {
      link.attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

      node.attr("transform", function(d) { return "translate(" + (d.x) + "," + (d.y) + ")"; });
    });
  }
  
  function dragstarted(d) {
    d3.event.sourceEvent.stopPropagation();
    d3.select(this).classed("fixed", d.fixed = true);
  }


  function dragged(d) {

    var link = zoomContainer.selectAll(".link");
    var node = zoomContainer.selectAll(".node");

    force.start();

    d.px += d3.event.dx;
    d.py += d3.event.dy;
    d.x += d3.event.dx;
    d.y += d3.event.dy;
    
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    
  }



  function dragended(d) {
    
    d3.select(this).classed("fixed", d.fixed = false);

    force.resume();
  }


  function zoomed() {
    zoomContainer.attr("transform", function () { return "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")";});
  }

  
});

/****** END - JS for showNetworkTopology - ******/



/****** START - JS for selectWorkloadModel - ******/

var setSelectWorkload;

$('#selectWorkload').click( function() {
  $('#selectWorkloadModal').modal({backdrop: 'static', keyboard: false});    
});

$('#selectWorkloadCancel').click( function() {
  $('#selectWorkloadModal').modal('hide');    
});

function getWorkloadConfigurationFromTopology() {
    for ( var i = 0; i < workload_network_topology['nodes']['length']; i++ ) {
      if ( workload_network_topology['nodes'][i]['name'] == "iperf client" && workload_network_topology['nodes'][i]['attached'] == "true" ) {
        iperf_client = true;
        workload_type = "iperf";

        if ( $('#uRole').text() == " virtual " ) {
          private_net_name_iperf_client = workload_network_topology['nodes'][i]['args']['net_name'];
          private_net_ID_iperf_client = workload_network_topology['nodes'][i]['args']['net_ID'];

          private_subnet_name_iperf_client = workload_network_topology['nodes'][i]['args']['subnet_name'];
          private_subnet_ID_iperf_client = workload_network_topology['nodes'][i]['args']['subnet_ID'];  
        }
        else {
          iperf_client_ip = workload_network_topology['nodes'][i]['args']['node_ip'];
        }

        iperf_bandwidth = workload_network_topology['nodes'][i]['args']['bandwidth'];
        iperf_protocol = workload_network_topology['nodes'][i]['args']['protocol'];
      }
      else if ( workload_network_topology['nodes'][i]['name'] == "iperf server" && workload_network_topology['nodes'][i]['attached'] == "true" ) {
        iperf_server = true;
        workload_type = "iperf";
        
        if ( $('#uRole').text() == " virtual " ) {
          private_net_name_iperf_server = workload_network_topology['nodes'][i]['args']['net_name'];
          private_net_ID_iperf_server = workload_network_topology['nodes'][i]['args']['net_ID'];

          private_subnet_name_iperf_server = workload_network_topology['nodes'][i]['args']['subnet_name'];
          private_subnet_ID_iperf_server = workload_network_topology['nodes'][i]['args']['subnet_ID'];
        }
        else {
          iperf_server_ip = workload_network_topology['nodes'][i]['args']['node_ip'];
        }

        iperf_server_port = workload_network_topology['nodes'][i]['args']['server_port'];
      }
      else if ( workload_network_topology['nodes'][i]['name'] == "jmeter client" && workload_network_topology['nodes'][i]['attached'] == "true" ) {
        jmeter_client = true;
        workload_type = "jmeter";

        if ( $('#uRole').text() == " virtual " ) {
          private_net_name_jmeter_client = workload_network_topology['nodes'][i]['args']['net_name'];
          private_net_ID_jmeter_client = workload_network_topology['nodes'][i]['args']['net_ID'];

          private_subnet_name_jmeter_client = workload_network_topology['nodes'][i]['args']['subnet_name'];
          private_subnet_ID_jmeter_client = workload_network_topology['nodes'][i]['args']['subnet_ID'];
        }
        else {
          jmeter_client_ip = workload_network_topology['nodes'][i]['args']['node_ip'];
        }

        server_IP_jmeter_client = workload_network_topology['nodes'][i]['args']['server_ip'];
        server_PORT_jmeter_client = workload_network_topology['nodes'][i]['args']['server_port'];
        request_method_jmeter_client = workload_network_topology['nodes'][i]['args']['requestMethod'];
        request_page_jmeter_client = workload_network_topology['nodes'][i]['args']['requestPage'];
        request_throughput_jmeter_client = workload_network_topology['nodes'][i]['args']['requestThroughput'];
        connect_timeout_jmeter_client = workload_network_topology['nodes'][i]['args']['connect_timeout'];
        response_timeout_jmeter_client = workload_network_topology['nodes'][i]['args']['response_timeout'];
      }
    }
  }


$('#selectWorkloadSave').click( function() {
  
  console.log("YESSA")
  //check if the user has added iperf_client and iperf_server vm-workload. 
  // TODO: add code for jmeter_client vm-workload

  iperf_client = false;
  iperf_server = false;
  jmeter_client = false;  
  
  getWorkloadConfigurationFromTopology();
  

  if ( iperf_client ) {
    if ( !(iperf_server) ) {
      workload_type = null;
      alert("Please select at least one vm-workload iPerf_Server");
      return false;  
    }
  }

  else if ( iperf_server ) {
    if ( !(iperf_client) ) {
      workload_type = null;
      alert("Please select at least one vm-workload iPerf_Client");
      return false;   
    }
  }

  else if ( !(iperf_client) && !(iperf_server) && !(jmeter_client)) {
    alert("Please select at least one vm-workload iPerf_Client and one vm-workload iPerf_Server or at least one vm-workload jmeter_Client");
    return false;   
  }   

    //save the workload configuration. If the user press on "Select workload" another, this configuration will be loaded in the tmp_* variables.
    workload_network_topology_iperf_client_node = Object.assign({}, tmp_workload_network_topology_iperf_client_node);
    workload_network_topology_iperf_client_link = Object.assign({}, tmp_workload_network_topology_iperf_client_link);

    workload_network_topology_iperf_server_node = Object.assign({}, tmp_workload_network_topology_iperf_server_node);
    workload_network_topology_iperf_server_link = Object.assign({}, tmp_workload_network_topology_iperf_server_link);

    workload_network_topology_jmeter_client_node = Object.assign({}, tmp_workload_network_topology_jmeter_client_node);
    workload_network_topology_jmeter_client_link = Object.assign({}, tmp_workload_network_topology_jmeter_client_link);


    console.log("workload_type : %s###", workload_type);

    if ( workload_type == 'iperf' ) {
      if ( $('#uRole').text() == " virtual " ) {
        console.log("private_net_name_iperf_client : %s###", private_net_name_iperf_client);
        console.log("private_net_ID_iperf_client : %s###", private_net_ID_iperf_client);

        console.log("private_subnet_name_iperf_client : %s###", private_subnet_name_iperf_client);
        console.log("private_subnet_ID_iperf_client : %s###", private_subnet_ID_iperf_client);

        console.log("private_net_name_iperf_server : %s###", private_net_name_iperf_server);
        console.log("private_net_ID_iperf_server : %s###", private_net_ID_iperf_server);

        console.log("private_subnet_name_iperf_server : %s###", private_subnet_name_iperf_server);
        console.log("private_subnet_ID_iperf_server : %s###", private_subnet_ID_iperf_server);  
      }
      else {
        console.log("iperf_client_ip : %s###", iperf_client_ip);
        console.log("iperf_server_ip : %s###", iperf_server_ip);
      }

      console.log("iperf_server_port : %s###", iperf_server_port);

      console.log("iperf_bandwidth : %s###", iperf_bandwidth);
      console.log("iperf_protocol : %s###", iperf_protocol);
    }
    else if ( workload_type == 'jmeter' ) {
      if ( $('#uRole').text() == " virtual " ) {
        console.log("private_net_name_jmeter_client : %s###", private_net_name_jmeter_client);
        console.log("private_net_ID_jmeter_client : %s###", private_net_ID_jmeter_client);

        console.log("private_subnet_name_jmeter_client : %s###", private_subnet_name_jmeter_client);
        console.log("private_subnet_ID_jmeter_client : %s###", private_subnet_ID_jmeter_client);
      }
      else {
        console.log("jmeter_client_ip : %s###", jmeter_client_ip);
      }

      console.log("server_IP_jmeter_client : %s###", server_IP_jmeter_client);
      console.log("server_PORT_jmeter_client : %s###", server_PORT_jmeter_client);
      console.log("request_method_jmeter_client : %s###", request_method_jmeter_client);
      console.log("request_page_jmeter_client : %s###", request_page_jmeter_client);
      console.log("request_throughput_jmeter_client : %s###", request_throughput_jmeter_client);
      console.log("connect_timeout_jmeter_client : %s###", connect_timeout_jmeter_client);
      console.log("response_timeout_jmeter_client : %s###", response_timeout_jmeter_client);
    }


    iperf_client_nodes = {}
    iperf_client_nodes['group'] = workload_network_topology_iperf_client_node['group']
    iperf_client_nodes['name'] = workload_network_topology_iperf_client_node['name']
    iperf_client_nodes['attached'] = workload_network_topology_iperf_client_node['attached']
    iperf_client_nodes['type'] = workload_network_topology_iperf_client_node['type']
    iperf_client_nodes['args'] = workload_network_topology_iperf_client_node['args']

    iperf_client_links = {}
    if ( iperf_client_nodes['attached'] == "true" ) {
      iperf_client_links['distance'] = 70
      iperf_client_links['value'] = workload_network_topology_iperf_client_link['value']
      iperf_client_links['source'] = workload_network_topology_iperf_client_link['source']['index']
      iperf_client_links['target'] = workload_network_topology_iperf_client_link['target']['index']
    }


    iperf_server_nodes = {}
    iperf_server_nodes['group'] = workload_network_topology_iperf_server_node['group']
    iperf_server_nodes['name'] = workload_network_topology_iperf_server_node['name']
    iperf_server_nodes['attached'] = workload_network_topology_iperf_server_node['attached']
    iperf_server_nodes['type'] = workload_network_topology_iperf_server_node['type']
    iperf_server_nodes['args'] = workload_network_topology_iperf_server_node['args']

    iperf_server_links = {}
    if ( iperf_server_nodes['attached'] == "true" ) {
      iperf_server_links['distance'] = 70
      iperf_server_links['value'] = workload_network_topology_iperf_server_link['value']
      iperf_server_links['source'] = workload_network_topology_iperf_server_link['source']['index']
      iperf_server_links['target'] = workload_network_topology_iperf_server_link['target']['index']
    }


    jmeter_client_nodes = {}
    jmeter_client_nodes['group'] = workload_network_topology_jmeter_client_node['group']
    jmeter_client_nodes['name'] = workload_network_topology_jmeter_client_node['name']
    jmeter_client_nodes['attached'] = workload_network_topology_jmeter_client_node['attached']
    jmeter_client_nodes['type'] = workload_network_topology_jmeter_client_node['type']
    jmeter_client_nodes['args'] = workload_network_topology_jmeter_client_node['args']

    jmeter_client_links = {}
    if ( jmeter_client_nodes['attached'] == "true" ) {
      jmeter_client_links['distance'] = 70
      jmeter_client_links['value'] = workload_network_topology_jmeter_client_link['value']
      jmeter_client_links['source'] = workload_network_topology_jmeter_client_link['source']['index']
      jmeter_client_links['target'] = workload_network_topology_jmeter_client_link['target']['index']
    }

    workload_network_topology_iperf_client_node = {}
    workload_network_topology_iperf_client_link = {}

    workload_network_topology_iperf_server_node = {}
    workload_network_topology_iperf_server_link = {}

    workload_network_topology_jmeter_client_node = {}
    workload_network_topology_jmeter_client_link = {}


    $.ajax({
      method: "POST",
      url : "{{ url_for('netcast.saveWorkloadConfiguration') }}",
      data : { 'campaign_name' : $('#campaignName').text(),
               'workload_type' : workload_type,
               'iperf_client_nodes' : JSON.stringify(iperf_client_nodes),
               'iperf_client_link' : JSON.stringify(iperf_client_links),
               'iperf_server_nodes' : JSON.stringify(iperf_server_nodes),
               'iperf_server_link' : JSON.stringify(iperf_server_links),
               'jmeter_client_nodes' : JSON.stringify(jmeter_client_nodes),
               'jmeter_client_link' : JSON.stringify(jmeter_client_links)
             },
      dataType: "json",
      success: function(response) {;},
      statusCode: {
            500:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
            501: function (response) { alert('Error when saving the workload configuration'); },
            400:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
            0:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
          }
          
      });
    
    
    $('#selectWorkloadModal').modal('hide');
    setSelectWorkload = true;

    //change disabled status of executeTestCases if the user has been set injection setup
    
    if (setInjectionSetup) {
      $('#executeTestCases').prop("disabled", false);
    }
    

});




/****** START - JS for injectSetupModel - ******/

//default injection time params
var pre_injection_time = 5;
var injection_time = 30;
var post_injection_time = 5;

var setInjectionSetup = true;

$('#injectionSetup').click( function() {
  $('#injectionSetupModal').modal('show');    
});

$('#injectionSetupModal').on('show.bs.modal', function () {

  if ( LOADED ) {
    for ( var i = 0; i < data_network_topology['nodes']['length']; i++ ) {
      if ( data_network_topology['nodes'][i]['type'] == "fault" && ( data_network_topology['nodes'][i]['status'] == "completed" || data_network_topology['nodes'][i]['status'] == "error") ) {

        $.confirm({
                      title: '<b>WARNING</b>',
                      content: 'For this campaign, there are some tests in completed or error status. The user can not reconfigure the injection setup.',
                      type: 'orange',
                      typeAnimated: true,
                      buttons: {
                          logout: function () { logout(); },
                          ok: function() { return; }
                      }
                  });
  
        $('#preInjectTime').prop('disabled', true)
        $('#InjectTime').prop('disabled', true)
        $('#postInjectTime').prop('disabled', true)
        $('#injectionSetupSave').hide();
        break;
      }
    }
  }
});

$('#injectionSetupCancel').click( function() {
  $('#preInjectTime').val(pre_injection_time);
  $('#InjectTime').val(injection_time);
  $('#postInjectTime').val(post_injection_time);
  $('#injectionSetupModal').modal('hide');    
});

$('#injectionSetupSave').click( function() {
  $('#alertArgsCheck').remove();
  
  //check parameters
  var tmp_pre_injection_time = $('#preInjectTime').val();
  var tmp_injection_time = $('#InjectTime').val();
  var tmp_post_injection_time = $('#postInjectTime').val();
  if ( isNaN(tmp_pre_injection_time) || isNaN(tmp_injection_time) || isNaN(tmp_post_injection_time) ) {
    //console.log("NON è un numero");
    $('#alertArgs_injection_parameters').append('<div id="alertArgsCheck" class="alert alert-danger" role="alert">Invalid parameters. </div> ');
    return false;
  } 
  else if ( tmp_pre_injection_time < 0 || tmp_injection_time < 0 || tmp_post_injection_time < 0 ) {
    $('#alertArgs_injection_parameters').append('<div id="alertArgsCheck" class="alert alert-danger" role="alert">Invalid parameters. </div> ');
    return false;
  }
  else {
    
    if ( tmp_pre_injection_time == '' ) {
      $('#preInjectTime').val(pre_injection_time);
    }
    
    if ( tmp_injection_time == '' ) {
      $('#InjectTime').val(injection_time); 
    }

    if ( tmp_post_injection_time == '' ) {
      $('#postInjectTime').val(post_injection_time);
    }

    console.log("Injection Parameter: preInjectTime: " + $('#preInjectTime').val() + " injectTime: " + $('#InjectTime').val() + " postInjectTime: " + $('#postInjectTime').val() );

    //save injector parameters

    pre_injection_time = $('#preInjectTime').val();
    injection_time = $('#InjectTime').val();
    post_injection_time = $('#postInjectTime').val();
    setInjectionSetup = true;

    $.ajax({
      method: "POST",
      data: { 'campaign_name' : $('#campaignName').text(), 'pre_injection_time' : pre_injection_time,  'injection_time' : injection_time, 'post_injection_time' : post_injection_time },
      url: "{{ url_for('netcast.setInjectorTime') }}",
      success: function (response) {;},
      statusCode: {
        500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        501: function (response) { alert('Error during save injection time configuration'); },
        400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
      } 
    });

    //change disabled status of executeTestCases if the user has been set workload setup
    if (setSelectWorkload) {
      $('#executeTestCases').prop("disabled", false);
      $('#selectWorkload').popover('hide');
    }
    else {
     $('#selectWorkload').popover('show'); 
    }
    
    $('#injectionSetupModal').modal('hide');
  }    
});
/****** END - JS for injectSetupModel - ******/

var instances_consoles = {};

$('#instancesConsole').click( function() {
   
    if ($.isEmptyObject(instances_consoles)){
        // on click populate the dropdown with links to instance consoles
        $('#consoles_dropdown_menu').html("")
        $.ajax({
          method: "GET",
          url:    "{{ url_for('netcast.getInstancesConsoles') }}",
          beforeSend: function () {
              $('#consoles_dropdown_menu').html('<li><a style="pointer-events:none;cursor:default;"><span class="fa fa-spinner fa-spin" style="font-size:16px;color:#000000;"></span><b> Loading...</b></a></li>');
          },
          success: function(response) {
              instances_consoles = JSON.parse(response);
              $('#consoles_dropdown_menu').html("")
              $.each(instances_consoles, function(instance, vnc_link) {
                    //console.log("instance: %s vnc_link: %s", instance, vnc_link)
                    if (vnc_link !='') {
                      $('#consoles_dropdown_menu').append(
                          '<li><a target="_blank" rel="noopener noreferrer" href="' + vnc_link + '"><span class="fa fa-circle" style="font-size:10px;color:green;"></span> ' + instance + '</a></li>'
                      )  
                    } 
                    else {
                      $('#consoles_dropdown_menu').append(
                          '<li><a style="pointer-events:none;cursor:default;"><span class="fa fa-circle" style="font-size:10px;color:red;"></span><i> ' + instance + ' (n/a)</i></a></li>'
                      )
                    }
                    
              });
              if ($.isEmptyObject(instances_consoles)) {
                $('#consoles_dropdown_menu').append('<li><a style="pointer-events:none;cursor:default;"> no instances... </a></li>');
              }
          },
          statusCode: {
            500:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
            400:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
            0:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          }
        });
    }
     


});

var all_test_done=false;
var getStatusTestCasesIntervalID;
var updateNetCASTLogsIntervalID;
var updateDeployNetCASTLogsIntervalID;
var execProgessID;

function logout(){

    $.ajax({
      method: "POST",
      url:    "{{ url_for('netcast.logout') }}",
      success: function(response) {
        //alert("Log out form NetCAST session done! Please click OK to reload page");
        location.reload();
      },
      statusCode: {
        500:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        400:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        0:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      }
    });  

}


$('#logoutBtn').click(function(){

      logout()
});


$('#showLogs').click(function () {
    $('#logs').toggleClass('hidden');
    $('#autoscrollCheckDiv').toggleClass('hidden');
});

/***** START- JS for Scan Resources and Fault Library Configuration - START *****/

$('#scanResources').click(function() {

  $("#ProjectResourcesModal").modal({backdrop: 'static', keyboard: false});

  /***** Fault Library Tree *****/
  $('#FL_tree').remove();
  $('#FL_description').html("");
  $('#FL_args').val("");
  $('#FL_args_unit').html("");

  $('#FL_tree_container').append('<div id="FL_tree"></div>');

  var getFaultLibraryURL = null;

  $('#FL_tree').fancytree({
      checkbox: true,
      extention: ["edit", "filter"],
      selectMode: 3,
      source: $.ajax({
                  type: "GET",
                  url: "{{ url_for('netcast.getFaultLibrary') }}",
                  dataType: "json"                  
                }),
      select: function (event, data) {
                if (!data.node.folder) { 
                  if (data.node.selected) {
                    data.node.setFocus(true);
                    data.node.setActive(true);
                    $('#FL_description').html(data.node.data.description);
                    $('#FL_args').val(data.node.data.args);
                    $('#FL_args_save').prop("disabled", false);
                    $('#FL_args').prop("disabled", false);
                    
                    if (data.node.title == "latency") {
                      $('#FL_args_unit').html(" (ms)");  
                    }
                    else if (data.node.title == "delete" || data.node.title == "loss" || data.node.title == "corrupt" || data.node.title == "duplicate" || data.node.title == "down" || data.node.title == "reboot") {
                      $('#FL_args_unit').html("");
                      $('#FL_args').prop("disabled", true);
                      $('#FL_args_save').prop("disabled", true);
                    }
                    else if ( data.node.title == "bottleneck" ) {
                      $('#FL_args_unit').html(" (KBits)");
                    }
                    else {
                      $('#FL_args_unit').html(" (%)");  
                    }
                  }
                  else {
                    data.node.setFocus(false);
                    data.node.setActive(false);
                    $('#FL_description').html("");
                    $('#FL_args').val("");
                    $('#FL_args_save').prop("disabled", true);
                    $('#FL_args').prop("disabled", true);
                    $('#FL_args_unit').html("");
                  }
                } 
              },
      click:  function (event, data) {
                var node = data.node;
                if (node.folder) {
                  $('#FL_description').html("");
                  $('#FL_args').val("");
                  $('#FL_args_save').prop("disabled", true);
                  $('#FL_args').prop("disabled", true);
                  $('#FL_args_unit').html("");
                } else {
                    if (data.targetType !== 'checkbox') {
                      $('#FL_description').html(node.data.description);
                      $('#FL_args').val(node.data.args);
                      $('#FL_args_save').prop("disabled", false);
                      $('#FL_args').prop("disabled", false);
                      if (node.title == "latency") {
                        $('#FL_args_unit').html(" (ms)");  
                      }
                      else if (node.title == "delete" || node.title == "loss" || node.title == "corrupt" || node.title == "duplicate" || node.title == "down" || node.title == "reboot") {
                        $('#FL_args_unit').html("");
                        $('#FL_args').prop("disabled", true);
                        $('#FL_args_save').prop("disabled", true);
                      }
                      else if ( data.node.title == "bottleneck" ) {
                        $('#FL_args_unit').html(" (KBits)");
                      }
                      else {
                        $('#FL_args_unit').html(" (%)");  
                      }
                    }
                }
              }
      });
});

//On change tab, disabled FL fields.
$('#ProjectResourcesModal').tabs({activate: function(event, ui) {
  $('#FL_description').html("");
  $('#FL_args').val("");
  $('#FL_args_save').prop("disabled", true);
  $('#FL_args').prop("disabled", true);
  $('#FL_args_unit').html("");
 }
});


// EventListener on click for "Fault Args" modification
$('#FL_args_save').click(function() {
    //console.log($(this).parent().context.id);
    $('#alertArgsCheck').remove();
    var node = $("#FL_tree").fancytree("getActiveNode");
    //if(node.selected) {
    var value = $('#FL_args').val();
    if (node.title != "delete" && node.title != "loss" && node.title != "corrupt" && node.title != "duplicate" && node.title != "down" && node.title != "reboot") {
      if (isNaN(value)) {
        //console.log("NON è un numero");
        $('#FL_args').val(node.data.args);
        $('#alertArgs').append('<div id="alertArgsCheck" class="alert alert-danger" role="alert">Insert a number. </div> ');
      }
      else {
        if ( value > 0 ) {  
          if ( node.title == "corrupt" || node.title == "loss" ) {
            if ( value >= 0.1 && value <= 100 ) {
              node.data.args = value;
              $('#alertArgs').append('<div id="alertArgsCheck" class="alert alert-success" role="alert">Value OK. </div> ');
            } 
            else {
              $('#FL_args').val(node.data.args);
              $('#alertArgs').append('<div id="alertArgsCheck" class="alert alert-danger" role="alert">Insert value in range [0.1 , 100]. </div> ');
            }
          } 
          else { 
            node.data.args = value;
            $('#alertArgs').append('<div id="alertArgsCheck" class="alert alert-success" role="alert">Value OK. </div> ');
          }
        }
        else {
          $('#FL_args').val(node.data.args);
          $('#alertArgs').append('<div id="alertArgsCheck" class="alert alert-danger" role="alert">Insert positive value. </div> ');
        }
      }
    }
    node.render();
    //}
});


$(document).click(function(event){
  var target = event.target || event.srcElement
  //console.log( target.id + " =====> " + $('#FL_args_save').attr('id') + " ====> " +  $('#FL_args').attr('id') );
  if ( target.id != $('#FL_args_save').attr('id') && target.id != $('#FL_args').attr('id') ) { $('#alertArgsCheck').remove(); }     
});


// Select/Deselect all resources
var selected_all_resources = false; 
$('#btnEnableResources').click(function() {
  $('#PR_description').html("");
  if(!selected_all_resources) {
    $('#PR_tree').fancytree("getTree").visit(function(node) {
      node.setSelected(true);
    });
    selected_all_resources = true;
  } else {
    $('#PR_tree').fancytree("getTree").visit(function(node) {
      node.setSelected(false);
    });
    selected_all_resources = false;
  }
  return false;
});

/** Select/Deselect all faults **/
var selected_all_faults = false;
  $('#btnEnableFaults').click(function() {
  $('#FL_description').html("");
  $('#FL_args').val("");
  $('#FL_args_save').prop("disabled", true);
  $('#FL_args').prop("disabled", true);
  $('#FL_args_unit').html("");

  if(!selected_all_faults) {
    $('#FL_tree').fancytree("getTree").visit(function(node) {
      node.setSelected(true);
    });
    selected_all_faults = true;
  } else {
    $('#FL_tree').fancytree("getTree").visit(function(node) {
      node.setSelected(false);
    });
    selected_all_faults = false;
  }
  return false;
});

$('#FL_cancel').click(function(){
    $('#ProjectResourcesModal').modal('hide');
    //$('.nav-tabs a[href="#tabScan_projectResources"]').tab('show');
});

$('#FL_save').click( function () {

  $.ajax ({
    method: "POST",
    url:  "{{ url_for('netcast.generateTestPlan') }}",
    data: {nodes: JSON.stringify(data_network_topology['nodes'])},
    dataType: "json",
    success: function(response) {
      var fip_list = JSON.parse(JSON.stringify(response));
      //var fips_list = JSON.parse(fip_list);

      //console.log(fip_list);
      t = $('#table1').DataTable();
      t.rows().remove().draw();
      t.rows.add(fip_list).draw();
      t.rows().select();

      //disable toggle checkbox for erro/completed row in dataTable 
      if ( LOADED ) {
        for (i = 0; i < $('#table1 > tbody')[0]['childElementCount']; i++) {
          if ( $('#table1 > tbody > tr:nth-child('+ (i+1) +') > td:nth-child(9)').text() != " NotCompleted" ) {
            $('#table1 > tbody > tr:nth-child('+ (i+1) +') > td:nth-child(1)').on('click', function() {
              alert('Tests in completed or error state can not be deselect.');
              return false;
            })
          }
        }
      }

      $('#ProjectResourcesModal').modal('hide');
      //console.log(fip_list);
      if ( fip_list.length == 0 ) {
        $('#executeSelectedFIP').prop('disabled', true);
      }
      else {
        $('#executeSelectedFIP').prop('disabled', false);  
      } 
    },
    statusCode: {
      400:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }, 
      401:  function (response) { alert('No faults !!!'); }, 
      500:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      0:    function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
    }
  });
});

$('#fast_configuration_add').click( function () {
  var selectedResources = getSelectedResources();
  var selectedFaults = getSelectedFaults();
    //console.log(JSON.stringify(selectedFaults));

  faults_selected = $("#FL_tree").fancytree("getTree").getSelectedNodes()
  resource_selected = $("#PR_tree").fancytree("getTree").getSelectedNodes()

  if (resource_selected.length == 0) {
      alert("Please select at least one resource to inject!");
      return false;
  }

  else if (faults_selected.length == 0){
      alert("Please select at least one fault type to inject!");
      return false;
  }


  //TODO: add code for take selected resources and selected fault in two json files. Send these to server, using '/fastConfiguration' call API.

  $.ajax({
    method: "POST",
    url:  "{{ url_for('netcast.fastConfiguration') }}",
    data: { resources: JSON.stringify(selectedResources),
            fault_library: JSON.stringify(selectedFaults),
            nodes: JSON.stringify(data_network_topology['nodes']),
            links: JSON.stringify(data_network_topology['links'])
          },
    dataType: "json",
    success: function(response) {

      resp = JSON.parse(JSON.stringify(response));

      nodes = resp['nodes']
      links = resp['links']

      for (var i = 0; i < nodes.length; i++ ) {
        data_network_topology['nodes'].push(nodes[i])
      }

      for (var i = 0; i < links.length; i++ ) {
        data_network_topology['links'].push(links[i])
      }

      $.d3render()
    },

    statusCode: {
      400:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }, 
      401:  function (response) { alert('Please select at least one resource type!'); }, 
      402:  function (response) { alert('Please select at least one fault type!'); }, 
      500:  function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      0:    function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
      }
    })  
});


function getSelectedFaults() {
  var tree = []
    var found = false;
    $('#FL_tree').fancytree("getRootNode").visit(function(domain_node){ 
        if(domain_node.folder) {
          var domain_folder = {}
          domain_folder['title'] = domain_node.title;
          domain_folder['folder'] = true;

          var domain_children = []

          domain_node.visit(function(type_node){
          
            if(type_node.folder) {
              found = true;
              var  type_folder= {}
              type_folder['title'] = type_node.title;
              type_folder['folder'] = true;

              var type_children = []

              type_node.visit(function(fault_node) {
                var fault_child = {}
                fault_child['title'] = fault_node.title;
              
                if(fault_node.data.description != undefined) 
                  fault_child['description'] = fault_node.data.description;
                else 
                  fautl_child['description'] = "";

                if(fault_node.data.args != undefined) 
                  fault_child['args'] = fault_node.data.args;
                else 
                  fault_child['args'] = ""; 

                if(fault_node.selected)  
                  fault_child['selected'] = true;
                else
                  fault_child['selected'] = false;
              
                type_children.push(fault_child)
              });
            
              type_folder['children'] = type_children;
              domain_children.push(type_folder);  
            }
            domain_folder['children'] = domain_children;
          });
          // push only complete path domain-type-fault and skip other possible node.
          if (found){
            tree.push(domain_folder);
            found=false;
          }
        }
    });
  //console.log(JSON.stringify(tree));
  return tree
}


function getSelectedResources() {
  var tree = []
  var found = false;
  $('#PR_tree').fancytree("getRootNode").visit(function(domain_node){
      if(domain_node.folder){
        var domain_folder = {}
        domain_folder['title'] = domain_node.title;
        domain_folder['folder'] = true;

        var domain_children = [];

        domain_node.visit(function(type_node) {

          if(type_node.folder) {
            found = true;
            var type_folder = {}
            type_folder['title'] = type_node.title;
            type_folder['folder'] = true;

            var type_children = []

            type_node.visit(function(res_node) {
              var res_child = {}
              res_child['title'] = res_node.title;

              if(res_node.data.name != undefined)
                res_child['name'] = res_node.data.name;
              else
                res_child['name'] = "";

              if(res_node.data.id != undefined)
                res_child['id'] = res_node.data.id;
              else
                res_child['id'] = "";

              if(res_node.selected)
                res_child['selected'] = true
              else
                res_child['selected'] = false

              type_children.push(res_child); 
            });

            type_folder['children'] = type_children;
            domain_children.push(type_folder);
          }
          domain_folder['children'] = domain_children;
        });
        // push only complete path domain-type-res and skip other possible node.
        if (found) {
          tree.push(domain_folder);
          found=false;
        }
      }
  });
  return tree;
}
/****** END - JS for Scan Resources and Fault Library Configuration - END *******/


  var table = $('#table1').DataTable({
    dom: 'Bfrtip',
    "pageLength": 25,
    "columnDefs": [
      {
        orderable: false,
        className: 'select-checkbox',
        targets: 0
      },
      {
        "render": function(data, type, row) {
          if (row[5] != "delete" && row[5] != "loss" && row[5] != "corrupt" && row[5] != "duplicate" && row[5] != "down" && row[5] != "reboot") {
            return data + ' (' + row[6] + ')'
          } else {
            return data
          }
        },
        "targets": 5
      },
      { "visible": false, "targets": [4] },
      { "visible": false, "targets": [6] },
      {
        "render": function(data, type, row) {
          if (row[5] != "delete" && row[5] != "down" && row[5] != "reboot") {
            return data + ' (' + row[9] + ',' + row[10] + ')'
          }
          else return null
        },
        "targets": 8
      },
      { "visible": false, "targets": [9] },
      { "visible": false, "targets": [10] },
      {
        "render": function(data, type, row) {
          if (row[5] != "delete" && row[5] != "down" && row[5] != "reboot") {
            return data + '<br> +protocol (' + row[12] + ')<br> +src_ports (' + row[13] + ')<br> +dst_ports (' + row[14] + ')'
          }
          else return null            
        },
        "targets": 11
      },
      { "visible": false, "targets": [12] },
      { "visible": false, "targets": [13] },
      { "visible": false, "targets": [14] },
      { 
        "render": function(data, type, row) {
          if (row[15] == "NotCompleted" ) {
            return '<i class="fa fa-circle" style="font-size:16px;color:red;"></i> ' + data
          }
          else if (row[15] == "completed" ) {
            return '<i class="fa fa-circle" style="font-size:16px;color:green;"></i> ' + data
          }
          else if (row[15] == "error" ) {
            return '<i class="fa fa-exclamation-triangle" style="font-size:16px;color:error;"></i> ' + data 
         }
        },
        "targets": 15 }
    ],
    select: {
      style: 'multi',
      selector: 'td:first-child'
    },
        buttons: [
            {
            text: 'Select all',
            action: function () {
              table.rows().select();
            }
          },
          {
            text: 'Select none',
            action: function () {
              table.rows().deselect();
            }
          },
          {
            text: 'Clear Table',
            action: function () {
              //reset_fips_table_and_tests();
              table.rows().clear().draw();
              //disabled "executeSelectedFIP" button
              $('#executeSelectedFIP').prop('disabled', true);
            }
          }
      ],
      scrollY: '45vh',
      "initComplete": function (settings, json) {
              $('.dataTables_scrollBody thead tr').css({ visibility: 'collapse' });
      },
  });

$('#executeSelectedFIP').click(function() {
    executeSelectedFIP_clicked = true;
    //TODO: take all selected fips from table1
    //TODO: check if selected_fip != null
    //TODO: go to tabDashboard and populate #exp-list 

    /******* take all selected fips from table1 *******/
    var t = $('#table1').DataTable();
    if(t.rows('.selected').data().length == 0){
      alert ('Select at least one test case !')
    } else {
      selected_test_case = []
      $.each(t.rows('.selected').data(), function(i, obj) {
        table_fip = obj.slice(1);
        string_fip = table_fip[0];
        $.each(table_fip.slice(1), function (i, e) {
          string_fip += "#";
          string_fip += e; 
        });
        selected_test_case.push(string_fip.toString());
        //console.log("obj.slice(1).toString() => %s", obj.slice(1).toString());
        });
      //console.log(selected_test_case);
      $.ajax({
        method: "POST",
        url: "{{ url_for('netcast.saveTestCase') }}",
        data: { testcases: JSON.stringify(selected_test_case), campaign_name: $('#campaignName').text() },
        success: function (response) {
          //console.log("RESPONSE OK");
          //TODO: draw table in tabDashboard with response data 
          $('#executeBtn a').attr( "data-toggle", "tab" );
          $('.nav-tabs a[href="#tabDashboard"]').tab('show');
          $('#selectWorkload').prop('disabled', false);
          $('#injectionSetup').prop('disabled', false);
          all_test_done = false;
          setSelectWorkload = false;
          createExpList();
        },
        statusCode: {
          500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          501: function (response) { alert('Error saving of test cases.'); },
          400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
        }
      });
    }
}); 

function createExpList(){
  $('#exp-list').html('');

  $('.progress').addClass('active');
  $('.progress .progress-bar').text('0.00%');
  $(".progress-bar").animate({width: '0%'}, 2500);
  
  $.ajax({
      method: "POST",
      url : "{{ url_for('netcast.getFipsList') }}",
      data: { campaign_name : $('#campaignName').text() },
      success: function (response){ 
        //console.log(JSON.parse(response));
        $.each(JSON.parse(response), function (j, obj) { 
          var fip = obj[0];
          
          var unit = "";
          if ( fip[5] == "latency") {
            unit = "ms";
          }
          else if (fip[5] == "loss" || fip[5] == "corrupt") {
            unit = "%";
          }

          if(fip[15] == 'NotCompleted'){
            $('#exp-list').append(
              '<button id="exp' + fip[0] + '" type="button" class="list-group-item list-group-item-action btn btn-default" style="width:100%;text-align:left;">Test: ' + fip[0] +
                ' - Inject in ' + fip[2] + ' <b><i>' + fip[3] + '</i></b> of <b><i>' + fip[5] + '</i></b> <b><i>' + fip[6] + '' + unit + '</i></b>' +   
              '<span class ="pull-right" id ="expStatus' + fip[0] + '"><i class="fa fa-circle" style="font-size:16px;color:red;"></i> Ready to execute </span></button>'
              )
          } 
          else if(fip[15] == 'completed') {
            $('#exp-list').append(
              '<button id="exp' + fip[0] + '" type="button" class="list-group-item list-group-item-action btn btn-default" style="width:100%;text-align:left;">Test: ' + fip[0] +
                ' - Inject in ' + fip[2] + ' <b><i>' + fip[3] + '</i></b> of <b><i>' + fip[5] + '</i></b> <b><i>' + fip[6] + '' + unit + '</i></b>' +
              '<span class ="pull-right" id ="expStatus' + fip[0] + '"><i class="fa fa-circle" style="font-size:16px;color:green;"></i> Completed </span></button>'
              )
          }

          else if (fip[15] == 'error') {
            $('#exp-list').append(
              '<button id="exp' + fip[0] + '" type="button" class="list-group-item list-group-item-action btn btn-default" style="width:100%;text-align:left;">Test: ' + fip[0] +
                ' - Inject in ' + fip[2] + ' <b><i>' + fip[3] + '</i></b> of <b><i>' + fip[5] + '</i></b> <b><i>' + fip[6] + '' + unit + '</i></b>' +
              '<span class ="pull-right" id ="expStatus' + fip[0] + '"><i class="fa fa-exclamation-triangle" style="font-size:16px;color:error;"></i> Error </span></button>'
              )
          }
        });
      //console.log(response);
      }
  });
}

$(document).on('click', '#exp-list button', function () {
  exp_id = $(this).attr("id");
  var exp_number = exp_id.replace('exp', '');
  $.ajax({
    method: "POST",
    url: "{{ url_for('netcast.getInfoTest') }}",
    data: { id_test: exp_number, campaign_name : $('#campaignName').text() },
    success: function(response) {
      details = JSON.parse(response).split('#');
      //console.log("DETAILS %s", details);
      var unit = "";
      if ( details[5] == "latency") {
        unit = "ms";
      }
      //else if (details[5] == "loss" || details[5] == "corrupt" || details[5] == "duplicate") {
        else if (details[5] == "duplicate") {
        unit = "%";
      }

      $('#exp-details').html('<p><b>Test Number:</b> ' + details[0] +
          ' </p><p><b>Domain:</b> ' + details[1] +
          ' </p><p><b>Resource Type:</b> ' + details[2] +
          ' </p><p><b>Resource Name:</b> ' + details[3] +
          ' </p><p><b>Fault Type:</b> ' + details[5] + ' ' + details[6] + '' + unit +
          ' </p><p><b>Description:</b> ' + details[7] + '</p>' +
          ' </p><p><b>Fault Pattern:</b> ' + details[8] + ' ' + details[9] + ' ' + details[10] + '</p>' +
          ' </p><p><b>Fault Target Traffic:</b> ' + details[11] + ' - protocol: ' + details[12] + ' - src ports: ' + details[13] + ' - dst ports: ' + details[14] + '</p>' 
        );

        $("#expListModal").modal('show');
    },
    statusCode: {
      500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }, 
      400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
    }
  });
});

$('#executeTestCases').click(function(){
  $('#confirmModalDeployWorkloadInstaces').modal({backdrop: 'static', keyboard: false});
});

$('#confirmModalDeployWorkloadInstaces_ok').click( function () {
  //disabled button until all test cases finished
  $('#executeTestCases').prop('disabled', true);
  $('#selectWorkload').prop('disabled', true);
  $('#injectionSetup').prop('disabled', true);

  //disabled scanTab
  $('.nav-tabs a[href="#tabScan"]').prop('disabled',true);

  updateDeployNetCASTLogsIntervalID = setInterval(updateDeployNetCASTLogs, 1000);

  var deploy_workload_instances_req = {}

  getWorkloadConfigurationFromTopology()
  
  deploy_workload_instances_req['workload_type'] = workload_type;
  
  var deploy_workload_instancesURL = null;
  if ( $('#uRole').text() == " virtual " ) {
    deploy_workload_instancesURL = "{{ url_for('netcast.deploy_workload_instances') }}"

    if ( workload_type == 'iperf' ) {  
      deploy_workload_instances_req['private_net_ID_iperf_client'] = private_net_ID_iperf_client,
      deploy_workload_instances_req['private_subnet_ID_iperf_client'] = private_subnet_ID_iperf_client,
      deploy_workload_instances_req['private_net_ID_iperf_server'] = private_net_ID_iperf_server,
      deploy_workload_instances_req['private_subnet_ID_iperf_server'] = private_subnet_ID_iperf_server,
      deploy_workload_instances_req['iperf_server_port'] = iperf_server_port,
      deploy_workload_instances_req['iperf_bandwidth'] = iperf_bandwidth,
      deploy_workload_instances_req['iperf_protocol'] = iperf_protocol
    }

    else if ( workload_type == 'jmeter' ) {
      deploy_workload_instances_req['private_net_ID_jmeter_client'] = private_net_ID_jmeter_client,
      deploy_workload_instances_req['private_subnet_ID_jmeter_client'] = private_subnet_ID_jmeter_client

      deploy_workload_instances_req['jmeter_server_ip'] = server_IP_jmeter_client;
      deploy_workload_instances_req['jmeter_server_port'] = server_PORT_jmeter_client;
      deploy_workload_instances_req['jmeter_http_method'] = request_method_jmeter_client;
      deploy_workload_instances_req['jmeter_page_file_path'] = request_page_jmeter_client;
      deploy_workload_instances_req['jmeter_troughput_value'] = request_throughput_jmeter_client;
      deploy_workload_instances_req['jmeter_connection_timeout'] = connect_timeout_jmeter_client;
      deploy_workload_instances_req['jmeter_response_timeout'] = response_timeout_jmeter_client;
    }
  }
  else {
   deploy_workload_instancesURL = "{{ url_for('netcast.deploy_workload_instances_phy') }}" 

   if ( workload_type == 'iperf' ) {
    deploy_workload_instances_req['iperf_client_ip'] = iperf_client_ip
    deploy_workload_instances_req['iperf_server_ip'] = iperf_server_ip
    deploy_workload_instances_req['iperf_server_port'] = iperf_server_port
    deploy_workload_instances_req['iperf_bandwidth'] = iperf_bandwidth
    deploy_workload_instances_req['iperf_protocol'] = iperf_protocol
   }

   else if ( workload_type == 'jmeter' ) {
    deploy_workload_instances_req['jmeter_client_ip'] = jmeter_client_ip
    deploy_workload_instances_req['jmeter_server_ip'] = server_IP_jmeter_client
    deploy_workload_instances_req['jmeter_server_port'] = server_PORT_jmeter_client
    deploy_workload_instances_req['jmeter_http_method'] = request_method_jmeter_client
    deploy_workload_instances_req['jmeter_page_file_path'] = request_page_jmeter_client
    deploy_workload_instances_req['jmeter_troughput_value'] = request_throughput_jmeter_client
    deploy_workload_instances_req['jmeter_connection_timeout'] = connect_timeout_jmeter_client
    deploy_workload_instances_req['jmeter_response_timeout'] = response_timeout_jmeter_client
   }
  }

  console.log ("Workload deployed %s", deploy_workload_instances_req);


  $.ajax({
    method: "POST",
    //url: "{{ url_for('netcast.deploy_workload_instances_fake') }}",
    url: deploy_workload_instancesURL,
    data: deploy_workload_instances_req,
    beforeSend: function() {
      $('#confirmModalDeployWorkloadInstaces').modal('hide');
      //$('#fa_fa_spinner_fa_spin').modal('show');
      $('#deployingModal').modal({backdrop: 'static', keyboard: false})
    },
    //success: function() {
    success: function(response) {

      console.log("deploy_workload_instances", response)

      // go ahead
      clearInterval(updateDeployNetCASTLogsIntervalID);
      $('#deployingModal').modal('hide');

    },
    statusCode: {
      500: function(response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      501: function(response) { alert('Error during deployment of NetCAST workload VMs! Please check NetCAST master agent logs.'); location.reload(); },
      400: function(response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      0: function(response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
    }
  });    
});

$('#confirmModalDeployWorkloadInstaces_cancel').click( function () {
  $('#confirmModalDeployWorkloadInstaces').modal('hide'); 
});


function continue_execute_tests(){
    $.ajax({
        method: "POST",
        //url : "{{ url_for('netcast.executeTests_fake') }}",
        url : "{{ url_for('netcast.executeTests') }}",
        data: {pre_injection_time: pre_injection_time, injection_time: injection_time, post_injection_time: post_injection_time, campaign_name : $('#campaignName').text() },
        beforeSend: function() {
          all_test_done = false;
          $('#confirmModalExecuteTests').modal('hide');
          $('#executeBtn > a > i').prop('hidden', false);
          getStatusTestCasesIntervalID = setInterval(getStatusTestCases, 1000);
          updateNetCASTLogsIntervalID = setInterval(updateNetCASTLogs, 1000);
          execProgessID = setInterval(updateExecProgess, 1000);
          $('#exp-list_analytics_col > label').append('<i class="fa fa-spinner fa-spin" style="font-size:16px;color:#000;"></i>');
          $('#exp-list_analytics_col > label').removeClass("btn-success").addClass("btn-danger");
          $('#stopTestCases').prop('disabled', false);
        },
        success: function () {
          all_test_done = true
          //console.log("Execution Completed !!!");
        },
        statusCode: {
          500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          501: function (response) { alert('Error during the tests execution'); },
          400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
          0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
        }
    });
}


$('#deployingModal').on('hidden.bs.modal', function () {
  check_agents_after_deploy()
  //continue_execute_tests()
});

var getStoppedTestCasesID = null;

$('#stopTestCases').click( function () {
    //call stopTests API:
  // beforeSend => TODO: add js to reset test cases execution,
  // success => active "executeTestCases" button

  $.ajax({
    method: "POST",
    url: "{{ url_for('netcast.stopTests') }}",
    data: { campaign_name : $('#campaignName').text() },
    beforeSend: function() {
      $('#stopTestCases').prop('disabled', true);
      clearInterval(getStoppedTestCasesID);
    },
    success: function(response) {
      console.log("TODO: stopTests on success state");
      resp = JSON.parse(response);

      if (resp['test'] == 'stopped') {
        console.log(resp['test']);
        //in the fip-list there are other tests. waiting for the termination of the current test...
        getStoppedTestCasesID = setInterval(getStoppedTestCases, 1000) 
      }
      //ELSE STATEMENT is not necessary, since after this current test, all tests will be completed
    },
    statusCode: {
      500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      501: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      404: function (response) { alert('Status file not found. Please check NetCAST master agent logs.'); },
      0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
      }  
  });
});

function getStoppedTestCases() {
  //periodic task that intercepts the STOPPED condition
  $.ajax({
    method: "POST",
    url: "{{ url_for('netcast.getStoppedTestCases') }}",
    data: { campaign_name : $('#campaignName').text() },
    success: function(response) {

      resp = JSON.parse(response);

      //console.log(resp['status']);

      if (resp['status'] == 'true') {
        $('#executeTestCases').prop('disabled', false);
      
        clearInterval(execProgessID);
        $('.progress').removeClass('active');
      
        $('#exp-list_analytics_col > label > text').text("All");
        $('#exp-list_analytics_col > label > i').prop('hidden', true);
        $('#exp-list_analytics_col > label').removeClass("btn-danger").addClass("btn-success");

        clearInterval(getStatusTestCasesIntervalID);
        clearInterval(updateNetCASTLogsIntervalID);

        $('.nav-tabs a[href="#tabScan"]').prop('disabled',false);
        $('#executeBtn > a > i').prop('hidden', true);  

        clearInterval(getStoppedTestCasesID)

        //update log and status one last time (in asynchronous mode)
        getStatusTestCases()
        updateNetCASTLogs()

      }
      
    },
    statusCode: {
      500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      501: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
      0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
    }
  });
}

function getStatusTestCases(){
  // this is the periodic task that get Status of the Test Cases during thes execution 
  $.ajax({
      method: "POST",
      url: "{{ url_for('netcast.getStatusTestCases')  }}",
      data: { campaign_name : $('#campaignName').text() },
      success: function(response){
          //console.log(response);
          //console.log(fip_list);

          $.each(JSON.parse(response), function (j, obj) {
              var fip_status = obj[0];
              
              if (fip_status[1] === 'completed'){
                $('#expStatus' + fip_status[0]).html('<i class="fa fa-circle" style="font-size:16px;color:green;"></i> Completed');
                all_test_done = true;
              }
              else if (fip_status[1] === 'inProgress'){
                $('#expStatus' + fip_status[0]).html('<i class="fa fa-spinner fa-spin" style="font-size:16px;color:#ffa012;"></i> In Progress');
                if ($('#autoscrollCheckExp').prop('checked')){
                  var expHeight = $('#exp' + fip_status[0])[0].scrollHeight + 1;
                  $('#exp-list').scrollTop((fip_status[0]*expHeight) - 10*expHeight);
                }
                all_test_done = false;
              }
              else if (fip_status[1] === 'error'){
                $('#expStatus' + fip_status[0]).html('<i class="fa fa-exclamation-triangle" style="font-size:16px;color:error;"></i> Error')
                all_test_done = true;
              }
              else if (fip_status[1] === 'skipped'){
                $('#expStatus' + fip_status[0]).html('<i class="fa fa fa-forward" style="font-size:16px;color:error;"></i> Skipped')
                all_test_done = true;
              }

              else if ( fip_status[1] === 'NotCompleted' ) {
                $('#expStatus' + fip_status[0]).html('<i class="fa fa-circle" style="font-size:16px;color:red;"></i> Ready to execute')
                all_test_done = false; 
              } 
              

          });

          //check if we have completed all tests
          if (all_test_done){
              
              clearInterval(getStatusTestCasesIntervalID);
              clearInterval(updateNetCASTLogsIntervalID);
              $('.nav-tabs a[href="#tabScan"]').prop('disabled',false);
              $('#executeBtn > a > i').prop('hidden', true);

          }

      },
      statusCode: {
        500: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        400: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); },
        404: function (response) { alert('Error during load test cases'); location.reload(); },
        0: function (response) { alert('The NetCAST agent may not be started! Please start it before performing tests'); }
      }
  });
}

function updateNetCASTLogs() {
    
  $.ajax({
        type: "GET",
        url: "{{ url_for('netcast.getNetCASTLogs')  }}",
        getNetworkTopology        success: function (response) {
            $('#logs').html('<pre>' + response + '</pre>');
            if ($('#autoscrollCheck').prop('checked')){
                $("#logs").scrollTop($("#logs")[0].scrollHeight);
            }
        },
        statusCode: {
            400: function (response) {
                alert('The NetCAST agent may not be started! Please start it before performing tests');
                location.reload();
            },
            0: function (response) {
                alert('The NetCAST agent may not be started! Please start it before performing tests');
                location.reload();
            }
        }
    });
}

function updateDeployNetCASTLogs() {
    
  $.ajax({
        type: "GET",
        url: "{{ url_for('netcast.getNetCASTLogs')  }}",
        dataType: "json",
        success: function (response) {
            $('#deploy_logs').html('<pre>' + response + '</pre>');
            $("#logs").scrollTop($("#deploy_logs")[0].scrollHeight);
        },
        statusCode: {
            400: function (response) {
                alert('The NetCAST agent may not be started! Please start it before performing tests');
                location.reload();
            },
            0: function (response) {
                alert('The NetCAST agent may not be started! Please start it before performing tests');
                location.reload();
            }
        }
    });
}

$(document).on('shown.bs.tab', '.nav-tabs a[href="#tabDashboard"]', function() {
  $('#selectWorkload').popover({
    html : true,
    trigger : 'show', 
    content: "Click here to configure the workload instances..."});
  $('#selectWorkload').popover('show');
  if (setSelectWorkload) {
    $('#selectWorkload').popover('hide');
  }
  else {
   $('#selectWorkload').popover('show'); 
  }

  //remove instances console dropdown in physical-mode
  if ( $('#uRole').text() == " physical " ) {
    $('#instancesConsole').parent().remove();
  }

});

$('#selectWorkloadModal').on('hidden.bs.modal', function() {
  if ( !setSelectWorkload ) {
       $('#selectWorkload').popover('show');
  }
});

var executeSelectedFIP_clicked = false;
$('.nav-tabs a[href="#tabDashboard"]').on('click', function () {
  var t = $('#table1').DataTable();
  if ( !executeSelectedFIP_clicked  || t.rows('.selected').data().length == 0 ) {
    return false;
  }
});

function handleEditClickNode(d, i) {
    var data_network_topology;

    console.log(data_network_topology);
    node_index = i;
    $('#editNode_configuration').html("");
    /**** emphasized_node ****/
    //turn off another active node
    d3.selectAll('circle')
        .filter(function (d, i) { return (i % 2) == 0 })
        .style("opacity", 0);

    //active clicked node
    d3.select(this).selectAll('circle')
        .filter(function (d, i) { return i == 0 })
        .style("opacity", 1);

    current_node = data_network_topology['nodes'][node_index];
    current_node_groupresource = groupResources[current_node['groups']];
    $('#editNode_configuration').html("");


    //creo un modal diverso dipendentemente dalla tipologia di noto che si deve aggiungere!
    switch (current_node_groupresource) {
        case "public_network":
            $('#editNode_configuration').append(
                '<div id="Edit_Node_configuration_content" class="modal-dialog modal-content style="top: 15px; width: 300px; background-color: aliceblue; border: 1px #555 solid; margin-top: 0px;">' +
                '<div class="modal-header">' +
                '<h5 class="modal-title" style="display: inline" ;> Configure public Network</h5>' +
                '<button id="Edit_Node_configuration_header_close" type="button" class="close">' +
                '</button>' +
                '</div>' +
                '<form id="EditPublicNetForm">' +
                '<p>You will customizee a public net. Insert the followin inormation </p>' +
                '<label for="edit_label_publicNet_name" class="col-form-label">Name:</label>' +
                '<input type="text" id="edit_publicNet_name" placeholder="Public Net value="' + current_node['names'] + '"><br>' +
                '<span id="validate"></span>' + // qui ci sarà un testo che indica che se il nome è già stato utilizzato, esso deve essere modificato!
                '</form>' +
                //this function check if this name is already in use!
                '<div class="modal-footer">' +
                '<button type="button" class="btn btn-secondary pull-left" id="deleteLocalPubliceNet_button" data-dismiss="modal">Delete Node</button>' +
                '<button type="button" class="btn btn-primary pull-right" id="saveNodePublicNet_button">Save changes</button>' +
                '</div>' +
                '</div>');

            /*
            Fatto il form si deve
            1) validare la form
            2) chiamare la funzione AllowChangeeName [che verifica se l'utente ha riscritto il nome, e se nel caso l'ha risctitto se era un nome libero] 
            2) nel caso il nome cambi, Nel caso cambi, bisogna aggiornare data_network_topology['nodes']
            3) se a form è a posto (tutti i campi completi richiesti sono settati) si cambia il numero del group da 10x a 20x )
            */
            break;
            break;

        case "private_network":
            $('#editNode_configuration').append(
                '<div id="Edit_Node_configuration_content" class="modal-dialog modal-content style="top: 15px; width: 300px; background-color: aliceblue; border: 1px #555 solid; margin-top: 0px;">' +
                '<div class="modal-header">' +
                '<h5 class="modal-title" style="display: inline" ;> Configure Private Network</h5>' +
                '<button id="Edit_Node_configuration_header_close" type="button" class="close">' +
                '</button>' +
                '</div>' +
                '<form id="EditPrivateNetForm">' +
                '<p>You will customizee a private net </p>' +
                '<label for="edit_label_privateNet_name" class="col-form-label">Net:</label>' +
                '<input type="text" id="edit_privateNet_name" placeholder="Private Net name" value="' + current_node['names'] + '">' +
                '<span id="validate"></span>' + // qui ci sarà un testo che indica che se il nome è già stato utilizzato, esso deve essere modificato!

                '</form>' +
                //this function check if this name is already in use!
                '<div class="modal-footer">' +
                '<button type="button" class="btn btn-secondary pull-left" id="deleteLocalPrivateNet_button" data-dismiss="modal">Delete Node</button>' +
                '<button type="button" class="btn btn-primary pull-right" id="saveNodePrivateNet_button">Save changes</button>' +
                '</div>' +
                '</div>');
            break;
        case "subnet":
            $('#editNode_configuration').append(
                '<div id="Edit_Node_configuration_content" class="modal-dialog modal-content style="top: 15px; width: 300px; background-color: aliceblue; border: 1px #555 solid; margin-top: 0px;">' +
                '<div class="modal-header">' +
                '<h5 class="modal-title" style="display: inline" ;> Configure Private Subner </h5>' +
                '<button id="Edit_Node_configuration_header_close" type="button" class="close">' +
                '</button>' +
                '</div>' +
                '<form id="EditPrivateSubNetForm">' +
                '<p>You will customizee a private subnet </p>' +
                //name
                '<label for="edit_label_privateSubnet_name" class="col-form-label">SubNet:</label>' +
                '<input type="text" id="edit_privateSubnet_name" placeholder="Private SubNet name" value="' + current_node['names'] + '">' +
                '<span id="validate"></span>' + // qui ci sarà un testo che indica che se il nome è già stato utilizzato, esso deve essere modificato!
                //net
                '<label for="edit_label_privateSubnet_net" class="col-form-label">Net:</label>' +
                '<div id="edit_privateSubnet_net_dropdown" class="dropdown">' +
                '<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">' +
                '<span id="edit_label_privateSubnet_netList" class="dropdown-title">select net</span>' +
                '<span class="fa fa-caret-down"></span>' +
                '</button>' +
                '<ul id="edit_privateSubnet_net_dropdown_menu" class="dropdown-menu"></ul>' +
                '</div>' +


                '</form>' +
                //this function check if this name is already in use!
                '<div class="modal-footer">' +
                '<button type="button" class="btn btn-secondary pull-left" id="deleteLocalPrivateSubnet_button" data-dismiss="modal">Delete Node</button>' +
                '<button type="button" class="btn btn-primary pull-right" id="saveNodePrivateSubNet_button">Save changes</button>' +
                '</div>' +
                '</div>');

            break;
        case "router":
            //temp_list = data_topology["nodes"].filter(node => (node["group"] == 2 || node["group"] == 202));
            //temp_list.forEach(node => List.push(node['name']));
            break;
        case "vm":
            //temp_list = data_topology["nodes"].filter(node => (node["group"] == 5 || node["group"] == 205));
            //temp_list.forEach(node => List.push(node['name']));
            break;
        case "switch":
            //temp_list = data_topology["nodes"].filter(node => (node["group"] == 7 || node["group"] == 207));
            //temp_list.forEach(node => List.push(node['name']));
            break;
        default:
    }

    //funzione che verifica se un nome è già presente in lista oppure no!
    function AllowChangeeName(inputText) {
        console.log("[Function AllowChangeeName:] " + inputText);
        if (resourceNameList.includes(inputText)) {
            console.log("trovato elemento con nome:" + inputText);
            return false;
        }
        else {
            console.log("Il nome " + inputText + " può essere utilizzato per rinominare il nodo corrente!");
            return true;
        }
    }

    /*
    funzione che restituisce una lista di elemento di un determinata tipologia (definita da string 'nome') 
    Essa è creata a partire dai nodi già istanziati sulla piattaforma openstack, e anche quelli aggiunti localmente
    al grafico, ma che sono nello stato di PROVISIONAL.

    */
    function getList(t) {
        List = [];
        switch (t) {
            case "net":
                temp_list = data_topology["nodes"].filter(node => (node["group"] == 1 || node["group"] == 201 || node["group"] == 3 || node["group"] == 203));
                temp_list.forEach(node => List.push(node['name']));
                break;
            case "subnet":
                temp_list = data_topology["nodes"].filter(node => (node["group"] == 4 || node["group"] == 204));
                temp_list.forEach(node => List.push(node['name']));
                break;
            case "router":
                temp_list = data_topology["nodes"].filter(node => (node["group"] == 2 || node["group"] == 202));
                temp_list.forEach(node => List.push(node['name']));
                break;
            case "vm":
                temp_list = data_topology["nodes"].filter(node => (node["group"] == 5 || node["group"] == 205));
                temp_list.forEach(node => List.push(node['name']));
                break;
            case "switch":
                temp_list = data_topology["nodes"].filter(node => (node["group"] == 7 || node["group"] == 207));
                temp_list.forEach(node => List.push(node['name']));
                break;
            default:
                List = [];
        }
        return List;
    }

    var resourceNameList;
    //ogni qualvolta che si mostra questo modal.
    $('#EditpuEdit_Node_configuration_content').on('shown.bs.modal', function () {

        resourceNameList = [];
        data_topology['nodes'].forEach(node => resourceNameList.push(node['name']));  // sarà un vettore formato da elementi mi carico il vettore di appogggio

        nameSource = data_topology['nodes'][node_index]['name'];
        console.log("Si vuol modificare nodes["+node_index+"] -> " + nameSource);

        switch (current_node_groupresource) {
            case "public_network":
                console.log("Stai per modificare una public net")
                /*
                Fatto il form si deve
                1) validare la form
                2) chiamare la funzione AllowChangeeName [che verifica se l'utente ha riscritto il nome, e se nel caso l'ha risctitto se era un nome libero] 
                2) nel caso il nome cambi, Nel caso cambi, bisogna aggiornare data_network_topology['nodes']
                3) se a form è a posto (tutti i campi completi richiesti sono settati) si cambia il numero del group da 10x a 20x )
                */
                break;

            case "private_network":
                console.log("Stai per modificare una private net");

                break;
            case "subnet":
                console.log("Stai per modificare una subnet net");
                /* NB DEVE FARE UN CONTROLLO SUGLI INDIRIZZI IP,
                    sia con una validate ip, ovvero effettivamente verificare che si tratti di indirizzi ip validi
                    sia che quest indirizzi ip siano liberi.
                    quindi bisogna fare una funzione che verifichi se il pool di indirizzi ip che si sta per creare è buono.
                    Si può anche impostare in automatico che una volta settato il pool le altre informazioni,
                    gateway, range, ecc ecc siano impostate di default.
                    ma il controllo sul pool deve essere fatto!

                */
                break;
            case "router":
               console.log("Stai per modificare un router");
            //temp_list = data_topology["nodes"].filter(node => (node["group"] == 2 || node["group"] == 202));
                //temp_list.forEach(node => List.push(node['name']));
                break;
            case "vm":
                console.log("Stai per modificare una  vm");

                //temp_list = data_topology["nodes"].filter(node => (node["group"] == 5 || node["group"] == 205));
                //temp_list.forEach(node => List.push(node['name']));
                break;
            case "switch":
               console.log("Stai per modificare uno switch");
            //temp_list = data_topology["nodes"].filter(node => (node["group"] == 7 || node["group"] == 207));
                //temp_list.forEach(node => List.push(node['name']));
                break;
            default:

                break;
        }

    });
        //dipendentemente dalla tipologia del field che si vuole settare si vanno  a caricare tutti gli elementi !
        //funzione che permette di aggiungere gli elementi relativi alle option di 
        //netListEditrouter_dropdown_menu
        //quindi per ogni valore che c'è nella lista 
/*           $("#netListEditrouter_dropdown_menu").html("");
        netlists = getList('net');
        if (netlists.length) {
            for (var i = 0; i < netlists.length; i++) {
                $("#netListEditrouter_dropdown_menu").append(
                    '<li data-original-index="' + i + 1 + '" data-toggle="tooltip" data-placement="top">' +
                    '<a data-select-value="' + listaelementi[i] + '">' + listaelementi[i] + '</a>' +
                    '</li>'
                );
            }
            $('#netListEditrouter_dropdown_menu li a').click(function () {
                //on change netListLabel content
                if ($('#netListEditrouter_label').text() !== $(this).text()) {
                    $('#netListEditrouter_label').text($(this).text());
                }

                if ($('#netListEditrouter_label').text() !== ("select net")) {
                    $('#netListEditrouter_button_save').prop('disabled', false);
                }
            });
        }
        else {
            $('#netListEditrouter_label').text("Empty");
            $('#netListEditrouter_dropdown button').prop('disabled', true);
        }
    });
*/

}
</script>
{% endblock %}
